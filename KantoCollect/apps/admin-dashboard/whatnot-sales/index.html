<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatNot Sales Tracker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 24px; background: #111827; border-bottom: 1px solid #1f2937; }
    main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    h1 { margin: 0; font-size: 24px; }
    h2 { font-size: 18px; margin: 0 0 16px; }
    .card { background: #111827; padding: 16px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 16px; }
    label { display: block; margin: 8px 0 4px; font-size: 12px; color: #94a3b8; }
    input, select, textarea, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e2e8f0; font-family: inherit; font-size: 14px; }
    textarea { width: 100%; min-height: 60px; }
    button { cursor: pointer; background: #22c55e; border-color: #22c55e; color: #0f172a; font-weight: 600; transition: all 0.2s; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    button.secondary { background: #0f172a; color: #e2e8f0; border-color: #334155; }
    button.danger { background: #ef4444; border-color: #ef4444; color: white; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: #94a3b8; font-size: 12px; }
    .success { color: #22c55e; }
    .warning { color: #f59e0b; }
    .danger { color: #ef4444; }

    /* Tabs */
    .tabs { display: none; gap: 8px; border-bottom: 1px solid #1f2937; margin-bottom: 24px; }
    .tab { padding: 12px 20px; cursor: pointer; color: #94a3b8; border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab:hover { background: #111827; }
    .tab.active { background: #111827; color: #e2e8f0; border-bottom: 2px solid #22c55e; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }

    /* Spinner animation */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #1f2937;
      border-top-color: #22c55e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .stat-card { background: #111827; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #1f2937; }
    .stat-value { font-size: 32px; font-weight: 700; color: #22c55e; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Tags */
    .tag-input { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; min-height: 40px; }
    .tag { background: #22c55e; color: #0f172a; padding: 4px 8px; border-radius: 6px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; }
    .tag .remove { cursor: pointer; font-weight: bold; }

    /* Table */
    table { border: 1px solid #1f2937; }
    th { color: #e2e8f0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { color: #cbd5e1; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #111827; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-close { cursor: pointer; font-size: 24px; color: #94a3b8; }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #1f2937; }
    th { color: #94a3b8; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    tr:hover { background: #0f172a; }
  </style>
</head>
<body>
  <header>
    <h1>üé¨ WhatNot Sales Tracker</h1>
    <div class="muted">Track stream sales, auto-assign COGS, analyze performance</div>
  </header>
  <main>
    <!-- Admin Lock/Unlock -->
    <div class="card">
      <h2>üîê Admin Access</h2>
      <div class="row">
        <input id="adminPin" type="password" placeholder="Enter PIN" style="width:150px;" maxlength="4" />
        <button onclick="enableAdmin()" id="enableBtn">Enable Admin</button>
        <button class="secondary" onclick="disableAdmin()" id="disableBtn" style="display:none;">Disable Admin</button>
        <span id="adminStatus" class="muted">üîí Locked</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('import')">üì§ Import</div>
      <div class="tab" onclick="showTab('master-catalog')">üìã Master Catalog</div>
      <div class="tab" onclick="showTab('cogs-rules')">‚≠ê COGS Rules</div>
      <div class="tab" onclick="showTab('shows')">üé¨ Shows</div>
      <div class="tab" onclick="showTab('marketplace')">üõí Marketplace</div>
      <div class="tab" onclick="showTab('products')">üì¶ Products</div>
      <div class="tab" onclick="showTab('buyers')">üë• Buyers</div>
      <div class="tab" onclick="showTab('analytics')">üìä Analytics</div>
    </div>

    <!-- IMPORT TAB -->
    <div id="import-tab" class="tab-content active">
      <div class="card">
        <h2>üì§ Import Excel File</h2>
        <p class="muted">Upload your WhatNot sales Excel file. Show name and date will be automatically extracted.</p>
        <label for="excelFile">Select Excel File</label>
        <input id="excelFile" type="file" accept=".xlsx,.xls" />
        <div class="row" style="margin-top:12px;">
          <button onclick="uploadExcel()">Upload & Import</button>
          <span id="importStatus" class="muted"></span>
        </div>
        <div id="importResults" style="margin-top:16px;"></div>
      </div>

      <div class="card">
        <h2>üìã Recent Imports</h2>
        <div id="recentImports" class="grid"></div>
      </div>
    </div>

    <!-- MASTER CATALOG TAB -->
    <div id="master-catalog-tab" class="tab-content">
      <div class="card">
        <h2>üìã Master Catalog</h2>
        <p class="muted" style="margin-bottom:16px;">Complete list of all products sold across shows and marketplace. COGS mapping will be applied once rules are created.</p>

        <!-- Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="catalogTotalProducts">0</div>
            <div class="stat-label">Total Products</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="catalogTotalSales">0</div>
            <div class="stat-label">Total Units Sold</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="catalogMappedCount">0</div>
            <div class="stat-label">COGS Mapped (0%)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="catalogUnmappedCount">0</div>
            <div class="stat-label">Needs Mapping</div>
          </div>
        </div>

        <!-- Filter/Search -->
        <div style="margin-bottom:16px; display:flex; gap:12px;">
          <input id="catalogSearch" placeholder="Search products..." style="flex:1;" onkeyup="filterMasterCatalog()" />
          <select id="catalogFilter" onchange="loadMasterCatalog()" style="width:200px;">
            <option value="all">All Products</option>
            <option value="mapped">COGS Mapped</option>
            <option value="unmapped">Needs COGS</option>
          </select>
        </div>

        <!-- Products Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600;">Product Name</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Times Sold</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Qty</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg Price</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Revenue</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">COGS/Unit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total COGS</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Profit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Status</th>
              </tr>
            </thead>
            <tbody id="masterCatalogTableBody">
              <tr>
                <td colspan="9" style="padding:20px; text-align:center;" class="muted">Loading master catalog...</td>
              </tr>
            </tbody>
            <tfoot id="masterCatalogTableFooter" style="background:#1f2937; border-top:2px solid #22c55e; font-weight:600;">
              <!-- Totals row will be added here -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- COGS RULES TAB -->
    <div id="cogs-rules-tab" class="tab-content">
      <div class="card">
        <h2>‚≠ê COGS Mapping Rules</h2>
        <p class="muted" style="margin-bottom:20px;">Create keyword-based rules to automatically assign COGS to products. Rules are checked by priority (higher numbers first).</p>

        <!-- Add New Rule Form -->
        <div style="background:#0f172a; padding:20px; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px;">
          <h3 style="margin:0 0 16px 0; font-size:16px;">‚ûï Add New Rule</h3>
          <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
            <div>
              <label>Rule Name</label>
              <input id="newRuleName" type="text" placeholder="e.g., Booster Packs" style="width:100%;" />
            </div>
            <div>
              <label>COGS Amount ($)</label>
              <input id="newRuleCOGS" type="number" step="0.01" placeholder="0.00" style="width:100%;" />
            </div>
            <div>
              <label>Priority</label>
              <input id="newRulePriority" type="number" placeholder="100" value="100" style="width:100%;" />
            </div>
            <div>
              <label>Match Type</label>
              <select id="newRuleMatchType" style="width:100%;">
                <option value="contains">Contains</option>
                <option value="starts_with">Starts With</option>
                <option value="ends_with">Ends With</option>
                <option value="exact">Exact Match</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom:12px;">
            <label>Keywords (comma-separated)</label>
            <input id="newRuleKeywords" type="text" placeholder="booster, booster pack, bp" style="width:100%;" />
            <div class="muted" style="margin-top:4px;">Enter keywords separated by commas. Example: "booster pack, booster, bp"</div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
            <div>
              <label>Category (optional)</label>
              <input id="newRuleCategory" type="text" placeholder="e.g., Sealed Products" style="width:100%;" />
            </div>
            <div>
              <label>Notes (optional)</label>
              <input id="newRuleNotes" type="text" placeholder="Description of this rule" style="width:100%;" />
            </div>
          </div>
          <button onclick="createNewRule()">‚úÖ Create Rule</button>
        </div>

        <!-- Existing Rules List -->
        <h3 style="margin:0 0 16px 0; font-size:16px;">üìã Existing Rules (<span id="rulesCount">0</span>)</h3>
        <div id="cogsRulesList"></div>
      </div>
    </div>

    <!-- SHOWS TAB -->
    <div id="shows-tab" class="tab-content">
      <!-- Shows List View -->
      <div id="shows-list-view" class="card">
        <h2>üé¨ WhatNot Stream Sales</h2>
        <p class="muted" style="margin-bottom:16px;">Click on any show to view and edit transaction details</p>

        <!-- Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="totalShowsCount">0</div>
            <div class="stat-label">Total Shows</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalEarnings">$0</div>
            <div class="stat-label">Total Earnings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgROI">0%</div>
            <div class="stat-label">Average ROI</div>
          </div>
        </div>

        <!-- Shows Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600;">Date</th>
                <th style="padding:12px 8px; font-weight:600;">Show Name</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Revenue</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Commission</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Earnings</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total COGS</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Net Profit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">ROI %</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Items</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Buyers</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg Order</th>
              </tr>
            </thead>
            <tbody id="showsTableBody">
              <tr>
                <td colspan="11" style="padding:20px; text-align:center;" class="muted">Loading shows...</td>
              </tr>
            </tbody>
            <tfoot id="showsTableFooter" style="background:#1f2937; border-top:2px solid #22c55e; font-weight:600;">
              <!-- Totals row will be added here -->
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Show Detail View -->
      <div id="show-detail-view" class="card" style="display:none;">
        <div style="margin-bottom:20px;">
          <button class="secondary" onclick="backToShowsList()">‚Üê Back to Shows</button>
        </div>

        <h2 id="showDetailTitle">Show Details</h2>
        <div id="showDetailMeta" class="muted" style="margin-bottom:20px;"></div>

        <!-- Show Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="detailTotalItems">0</div>
            <div class="stat-label">Items Sold</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailCOGS">$0</div>
            <div class="stat-label">Total COGS</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailProfit">$0</div>
            <div class="stat-label">Net Profit</div>
          </div>
        </div>

        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Transactions</h3>
          <button onclick="saveAllCOGS()" id="saveCOGSBtn">üíæ Save All COGS Changes</button>
        </div>

        <!-- Transactions Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#0f172a;">
                <th style="padding:12px 8px;">Product</th>
                <th style="padding:12px 8px; text-align:center;">Qty</th>
                <th style="padding:12px 8px;">Buyer</th>
                <th style="padding:12px 8px; text-align:right;">Price</th>
                <th style="padding:12px 8px; text-align:right;">Earnings</th>
                <th style="padding:12px 8px; text-align:right;">COGS</th>
                <th style="padding:12px 8px; text-align:right;">Profit</th>
                <th style="padding:12px 8px; text-align:right;">ROI%</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MARKETPLACE TAB -->
    <div id="marketplace-tab" class="tab-content">
      <div class="card">
        <h2>üõí Marketplace Orders</h2>
        <p class="muted" style="margin-bottom:16px;">Import and manage WhatNot marketplace orders (non-stream sales)</p>

        <!-- Import Section -->
        <div style="padding:16px; background:#0f172a; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px;">
          <h3 style="margin:0 0 12px 0; font-size:16px;">üì§ Import Marketplace Excel</h3>
          <div class="row">
            <input type="file" id="marketplaceFile" accept=".xlsx,.xls" style="flex:1;" />
            <button onclick="uploadMarketplace()">Upload & Import</button>
          </div>
          <div id="marketplaceImportStatus" style="margin-top:12px;"></div>
          <div id="marketplaceImportResults" style="margin-top:12px;"></div>
        </div>

        <!-- Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="marketplaceTotalOrders">0</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceEarnings">$0</div>
            <div class="stat-label">Total Earnings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceProfit">$0</div>
            <div class="stat-label">Net Profit</div>
          </div>
        </div>

        <!-- Orders Table -->
        <div style="margin-bottom:16px; display:flex; justify-content:flex-end; align-items:center;">
          <button onclick="saveAllMarketplaceCOGS()" id="saveMarketplaceCOGSBtn" style="display:none;">üíæ Save All COGS Changes</button>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600; width:40px;"></th>
                <th style="padding:12px 8px; font-weight:600;">Product Name</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Qty Sold</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg Price</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Revenue</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Earnings</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg COGS</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Profit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg ROI%</th>
              </tr>
            </thead>
            <tbody id="marketplaceTableBody">
              <tr>
                <td colspan="9" style="padding:20px; text-align:center;" class="muted">Loading marketplace orders...</td>
              </tr>
            </tbody>
            <tfoot id="marketplaceTableFooter" style="background:#1f2937; border-top:2px solid #22c55e; font-weight:600;">
              <!-- Totals row will be added here -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- PRODUCTS TAB -->
    <div id="products-tab" class="tab-content">
      <div class="card">
        <h2>üì¶ Product Performance</h2>
        <div class="row" style="margin-bottom:12px;">
          <input id="productSearch" placeholder="Search products..." style="flex:1;" />
          <select id="productFilter" onchange="loadProducts()">
            <option value="all">All Products</option>
            <option value="has_cogs">Has COGS</option>
            <option value="missing_cogs">Missing COGS</option>
          </select>
        </div>
        <div id="productsList" class="grid"></div>
      </div>
    </div>

    <!-- BUYERS TAB -->
    <div id="buyers-tab" class="tab-content">
      <div class="card">
        <h2>üë• Buyer Analytics</h2>
        <div class="row" style="margin-bottom:12px;">
          <input id="buyerSearch" placeholder="Search buyers..." style="flex:1;" />
          <button class="secondary" onclick="loadBuyers(true)">Repeat Buyers Only</button>
        </div>
        <div id="buyersList" class="grid"></div>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="tab-content">
      <div id="analyticsStats" class="stat-grid"></div>
      <div class="grid">
        <div class="card">
          <h2>üèÜ Top Products</h2>
          <div id="topProducts"></div>
        </div>
        <div class="card">
          <h2>üëë Top Buyers</h2>
          <div id="topBuyers"></div>
        </div>
      </div>
      <div class="card">
        <h2>‚≠ê COGS Rule Performance</h2>
        <div id="rulePerformance"></div>
      </div>
    </div>

    <!-- COGS Rule Modal (DEPRECATED - Using inline form now) -->
    <div id="cogsRuleModal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="ruleModalTitle">New COGS Rule</h2>
          <span class="modal-close" onclick="closeRuleModal()">√ó</span>
        </div>
        <label for="ruleName">Rule Name</label>
        <input id="ruleName" placeholder="e.g., One Piece AA Cards" />

        <label>Keywords (press Enter to add)</label>
        <div id="keywordTags" class="tag-input">
          <input id="keywordInput" placeholder="Type keyword..." style="border:none;flex:1;background:transparent;" onkeydown="handleKeywordEnter(event)" />
        </div>

        <label for="matchType">Match Type</label>
        <select id="matchType">
          <option value="contains">Contains</option>
          <option value="starts_with">Starts With</option>
          <option value="ends_with">Ends With</option>
          <option value="exact">Exact Match</option>
        </select>

        <label for="cogsAmount">COGS Amount ($)</label>
        <input id="cogsAmount" type="number" step="0.01" placeholder="25.00" />

        <label for="priority">Priority (higher = checked first)</label>
        <input id="priority" type="number" value="50" />

        <label for="category">Category (optional)</label>
        <input id="category" placeholder="e.g., One Piece Cards" />

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Description of what this rule covers..."></textarea>

        <div class="row" style="margin-top:16px;">
          <button onclick="saveRule()">Save Rule</button>
          <button class="secondary" onclick="testRule()">Test Rule</button>
          <button class="secondary" onclick="closeRuleModal()">Cancel</button>
        </div>
        <div id="ruleTestResults" style="margin-top:12px;"></div>
      </div>
    </div>
  </main>

  <script>
    const apiBase = "/api/v1/admin/whatnot";
    let currentKeywords = [];
    let editingRuleId = null;
    let adminEnabled = false;
    let adminKey = null;

    // Admin lock/unlock
    function enableAdmin() {
      const pin = document.getElementById("adminPin").value;
      if (pin === "1453") {
        adminEnabled = true;
        adminKey = "1453";
        document.getElementById("adminStatus").innerHTML = '‚úÖ Admin Enabled';
        document.getElementById("adminStatus").className = 'success';
        document.getElementById("enableBtn").style.display = 'none';
        document.getElementById("disableBtn").style.display = 'inline-block';
        document.getElementById("adminPin").value = '';
        document.querySelector('.tabs').style.display = 'flex';
        updateUIForAdminMode();
        showTab('master-catalog');
      } else {
        alert('Invalid PIN');
      }
    }

    function disableAdmin() {
      adminEnabled = false;
      adminKey = null;
      document.getElementById("adminStatus").innerHTML = 'üëÅÔ∏è View Only';
      document.getElementById("adminStatus").className = 'muted';
      document.getElementById("enableBtn").style.display = 'inline-block';
      document.getElementById("disableBtn").style.display = 'none';
      updateUIForAdminMode();
    }

    function updateUIForAdminMode() {
      // Hide/show admin-only tabs
      const importTab = document.querySelector('.tab[onclick*="import"]');
      const rulesTab = document.querySelector('.tab[onclick*="cogs-rules"]');
      const catalogTab = document.querySelector('.tab[onclick*="master-catalog"]');

      importTab.style.display = adminEnabled ? 'block' : 'none';
      rulesTab.style.display = adminEnabled ? 'block' : 'none';
      catalogTab.style.display = adminEnabled ? 'block' : 'none';

      // If disabling admin and currently on an admin-only tab, switch to Shows
      if (!adminEnabled) {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab && (activeTab.textContent.includes('Import') ||
                          activeTab.textContent.includes('COGS Rules') ||
                          activeTab.textContent.includes('Master Catalog'))) {
          showTab('shows');
        }
      }

      // Hide/show all Save buttons and input fields
      document.querySelectorAll('input[type="number"]').forEach(input => {
        input.disabled = !adminEnabled;
        input.style.opacity = adminEnabled ? '1' : '0.5';
      });

      document.querySelectorAll('button').forEach(btn => {
        if (btn.textContent.includes('Save') || btn.textContent.includes('Upload') || btn.textContent.includes('New Rule')) {
          btn.style.display = adminEnabled ? 'inline-block' : 'none';
        }
      });
    }

    function authHeaders() {
      return adminKey ? { "Authorization": `Bearer ${adminKey}`, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
    }

    // Tab management
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Load data for active tab
      if (tabName === 'import') loadRecentImports();
      if (tabName === 'master-catalog') loadMasterCatalog();
      if (tabName === 'cogs-rules') loadCogsRules();
      if (tabName === 'shows') loadShows();
      if (tabName === 'marketplace') loadMarketplace();
      if (tabName === 'products') loadProducts();
      if (tabName === 'buyers') loadBuyers();
      if (tabName === 'analytics') loadAnalytics();
    }

    // Excel Import
    async function uploadExcel() {
      const fileInput = document.getElementById("excelFile");

      if (!fileInput.files[0]) {
        document.getElementById("importStatus").innerHTML = '<span class="warning">‚ö† Please select an Excel file</span>';
        return;
      }

      const fileName = fileInput.files[0].name;
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      // Show detailed progress
      const statusEl = document.getElementById("importStatus");
      const resultsEl = document.getElementById("importResults");

      statusEl.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="spinner"></div>
          <div>
            <div style="font-weight:600; margin-bottom:4px;">üì§ Importing ${fileName}...</div>
            <div class="muted" style="font-size:11px;">Parsing Excel ‚Üí Creating transactions ‚Üí Matching COGS rules</div>
          </div>
        </div>
      `;
      resultsEl.innerHTML = '';

      try {
        const startTime = Date.now();

        const res = await fetch(`${apiBase}/import/excel`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${adminKey}` },
          body: formData
        });

        const result = await res.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        if (res.ok) {
          const cogsPct = result.imported > 0 ? ((result.cogs_assigned_count / result.imported) * 100).toFixed(0) : 0;

          statusEl.innerHTML = `<div class="success" style="font-weight:600;">‚úÖ Import Complete (${elapsed}s)</div>`;

          resultsEl.innerHTML = `
            <div class="card" style="background:#111827; border:1px solid #22c55e;">
              <div style="font-weight:600; margin-bottom:12px; color:#22c55e;">üìä Import Summary</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">TRANSACTIONS</div>
                  <div style="font-size:20px; font-weight:600;">${result.imported}</div>
                  <div class="muted" style="font-size:11px;">from ${result.total_rows} rows</div>
                </div>
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">COGS COVERAGE</div>
                  <div style="font-size:20px; font-weight:600; color:${cogsPct >= 80 ? '#22c55e' : cogsPct >= 50 ? '#f59e0b' : '#ef4444'}">${cogsPct}%</div>
                  <div class="muted" style="font-size:11px;">${result.cogs_assigned_count} / ${result.imported} assigned</div>
                </div>
              </div>
              ${result.cogs_missing_count > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="warning">‚ö† ${result.cogs_missing_count} transactions need COGS rules</div>
                  <div class="muted" style="font-size:11px; margin-top:4px;">Go to Product Catalog to assign COGS</div>
                </div>
              ` : ''}
              ${result.errors.length > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="danger">‚ùå ${result.errors.length} errors:</div>
                  ${result.errors.map(e => `<div class="muted" style="font-size:11px;">‚Ä¢ ${e}</div>`).join('')}
                </div>
              ` : ''}
            </div>
          `;

          loadRecentImports();
          fileInput.value = '';
        } else {
          statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
          resultsEl.innerHTML = `
            <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
              <div class="danger">${result.detail || 'Unknown error'}</div>
            </div>
          `;
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
        resultsEl.innerHTML = `
          <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
            <div class="danger">${error.message}</div>
          </div>
        `;
      }
    }

    async function loadRecentImports() {
      const res = await fetch(`${apiBase}/shows?limit=5`, { headers: authHeaders() });
      const shows = await res.json();
      const container = document.getElementById("recentImports");
      container.innerHTML = shows.map(show => `
        <div class="card">
          <strong>${show.show_date}</strong> - ${show.show_name || 'Unnamed'}<br>
          <span class="muted">${show.item_count} items ‚Ä¢ $${show.total_gross_sales}</span>
        </div>
      `).join('');
    }

    // COGS Rules
    async function loadCogsRules() {
      try {
        const res = await fetch(`${apiBase}/cogs-rules`, { headers: authHeaders() });
        const rules = await res.json();
        const container = document.getElementById("cogsRulesList");
        const countEl = document.getElementById("rulesCount");

        countEl.textContent = rules.length;

        if (rules.length === 0) {
          container.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">No COGS rules yet. Create one above to auto-assign costs!</div>';
          return;
        }

        // Sort by priority (descending)
        const sortedRules = rules.sort((a, b) => b.priority - a.priority);

        container.innerHTML = sortedRules.map(rule => `
          <div style="background:#0f172a; padding:16px; border-radius:8px; border:1px solid #1f2937; margin-bottom:12px;">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:12px; align-items:center;">
              <div>
                <strong style="font-size:15px;">${rule.rule_name}</strong>
                <div class="muted" style="font-size:12px; margin-top:4px;">Keywords: ${rule.keywords.join(', ')}</div>
                ${rule.category ? `<div class="muted" style="font-size:11px;">Category: ${rule.category}</div>` : ''}
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">COGS</div>
                <div style="font-weight:600; color:#22c55e; font-size:16px;">$${parseFloat(rule.cogs_amount).toFixed(2)}</div>
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">Priority</div>
                <div style="font-weight:600;">${rule.priority}</div>
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">Match</div>
                <div style="font-size:12px;">${rule.match_type}</div>
              </div>
              <div style="display:flex; gap:6px;">
                ${rule.is_active ?
                  '<button class="secondary" style="font-size:12px; padding:6px 10px;" onclick="toggleRuleStatus(' + rule.id + ', false)">üîá Disable</button>' :
                  '<button style="font-size:12px; padding:6px 10px;" onclick="toggleRuleStatus(' + rule.id + ', true)">üîä Enable</button>'}
                <button class="danger" style="font-size:12px; padding:6px 10px;" onclick="deleteCogsRule(${rule.id})">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading COGS rules:', error);
      }
    }

    async function createNewRule() {
      const name = document.getElementById('newRuleName').value.trim();
      const cogs = parseFloat(document.getElementById('newRuleCOGS').value);
      const priority = parseInt(document.getElementById('newRulePriority').value) || 100;
      const matchType = document.getElementById('newRuleMatchType').value;
      const keywordsStr = document.getElementById('newRuleKeywords').value.trim();
      const category = document.getElementById('newRuleCategory').value.trim();
      const notes = document.getElementById('newRuleNotes').value.trim();

      // Validation
      if (!name) {
        alert('Please enter a rule name');
        return;
      }
      if (!cogs || cogs <= 0) {
        alert('Please enter a valid COGS amount');
        return;
      }
      if (!keywordsStr) {
        alert('Please enter at least one keyword');
        return;
      }

      // Parse keywords (comma-separated)
      const keywords = keywordsStr.split(',').map(k => k.trim()).filter(k => k.length > 0);
      if (keywords.length === 0) {
        alert('Please enter at least one keyword');
        return;
      }

      const data = {
        rule_name: name,
        keywords: keywords,
        cogs_amount: cogs,
        match_type: matchType,
        priority: priority,
        is_active: true,
        category: category || null,
        notes: notes || null
      };

      try {
        const res = await fetch(`${apiBase}/cogs-rules`, {
          method: 'POST',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          // Clear form
          document.getElementById('newRuleName').value = '';
          document.getElementById('newRuleCOGS').value = '';
          document.getElementById('newRulePriority').value = '100';
          document.getElementById('newRuleKeywords').value = '';
          document.getElementById('newRuleCategory').value = '';
          document.getElementById('newRuleNotes').value = '';

          // Reload rules list
          await loadCogsRules();
          alert('‚úÖ COGS rule created successfully!');
        } else {
          const error = await res.json();
          alert(`Error creating rule: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    async function toggleRuleStatus(ruleId, newStatus) {
      try {
        const res = await fetch(`${apiBase}/cogs-rules/${ruleId}`, {
          method: 'PUT',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_active: newStatus })
        });

        if (res.ok) {
          await loadCogsRules();
        } else {
          alert('Error updating rule status');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    async function deleteCogsRule(ruleId) {
      if (!confirm('Are you sure you want to delete this COGS rule?')) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/cogs-rules/${ruleId}`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (res.ok || res.status === 204) {
          await loadCogsRules();
          alert('‚úÖ Rule deleted successfully');
        } else {
          alert('Error deleting rule');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    function openNewRuleModal() {
      editingRuleId = null;
      currentKeywords = [];
      document.getElementById("ruleModalTitle").textContent = "New COGS Rule";
      document.getElementById("ruleName").value = "";
      document.getElementById("cogsAmount").value = "";
      document.getElementById("priority").value = "50";
      document.getElementById("matchType").value = "contains";
      document.getElementById("category").value = "";
      document.getElementById("notes").value = "";
      updateKeywordTags();
      document.getElementById("cogsRuleModal").classList.add("active");
    }

    function closeRuleModal() {
      document.getElementById("cogsRuleModal").classList.remove("active");
      document.getElementById("ruleTestResults").innerHTML = "";
    }

    function handleKeywordEnter(event) {
      if (event.key === 'Enter' && event.target.value.trim()) {
        currentKeywords.push(event.target.value.trim());
        event.target.value = '';
        updateKeywordTags();
        event.preventDefault();
      }
    }

    function removeKeyword(index) {
      currentKeywords.splice(index, 1);
      updateKeywordTags();
    }

    function updateKeywordTags() {
      const container = document.getElementById("keywordTags");
      const input = document.getElementById("keywordInput");
      container.innerHTML = currentKeywords.map((kw, i) =>
        `<span class="tag">${kw}<span class="remove" onclick="removeKeyword(${i})">√ó</span></span>`
      ).join('') + input.outerHTML;
    }

    async function saveRule() {
      const data = {
        rule_name: document.getElementById("ruleName").value,
        keywords: currentKeywords,
        cogs_amount: parseFloat(document.getElementById("cogsAmount").value),
        match_type: document.getElementById("matchType").value,
        priority: parseInt(document.getElementById("priority").value),
        category: document.getElementById("category").value || null,
        notes: document.getElementById("notes").value || null
      };

      if (!data.rule_name || currentKeywords.length === 0 || !data.cogs_amount) {
        alert("Name, keywords, and COGS amount are required");
        return;
      }

      const url = editingRuleId ? `${apiBase}/cogs-rules/${editingRuleId}` : `${apiBase}/cogs-rules`;
      const method = editingRuleId ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: authHeaders(),
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeRuleModal();
        loadCogsRules();
      } else {
        alert("Error saving rule");
      }
    }

    async function testRule() {
      const data = {
        rule_name: "Test",
        keywords: currentKeywords,
        cogs_amount: parseFloat(document.getElementById("cogsAmount").value) || 0,
        match_type: document.getElementById("matchType").value,
        priority: 50
      };

      const res = await fetch(`${apiBase}/cogs-rules/test`, {
        method: "POST",
        headers: authHeaders(),
        body: JSON.stringify(data)
      });

      const result = await res.json();
      document.getElementById("ruleTestResults").innerHTML = result.matches.length > 0
        ? `<div class="success">‚úì Would match ${result.match_count} products:</div><div class="muted">${result.matches.slice(0,5).join(', ')}${result.matches.length > 5 ? '...' : ''}</div>`
        : '<div class="warning">‚ö† No matches found</div>';
    }

    async function toggleRule(id) {
      await fetch(`${apiBase}/cogs-rules/${id}/toggle`, {
        method: "POST",
        headers: authHeaders()
      });
      loadCogsRules();
    }

    async function deleteRule(id) {
      if (!confirm("Delete this COGS rule?")) return;
      await fetch(`${apiBase}/cogs-rules/${id}`, {
        method: "DELETE",
        headers: authHeaders()
      });
      loadCogsRules();
    }

    // Shows
    async function loadShows() {
      try {
        const res = await fetch(`${apiBase}/shows?limit=100`, { headers: authHeaders() });
        const shows = await res.json();

        const tbody = document.getElementById("showsTableBody");
        const tfoot = document.getElementById("showsTableFooter");

        if (shows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" style="padding:20px; text-align:center;" class="muted">No shows imported yet. Go to Import tab to upload your first Excel file!</td></tr>';
          return;
        }

        // Calculate totals
        let totalRevenue = 0;
        let totalCommission = 0;
        let totalEarnings = 0;
        let totalCOGS = 0;
        let totalProfit = 0;
        let totalItems = 0;
        let totalBuyers = 0;
        let showsWithCOGS = 0;

        // Render table rows
        tbody.innerHTML = shows.map(show => {
          const revenue = parseFloat(show.total_gross_sales || 0);
          const commission = parseFloat(show.total_whatnot_commission || 0) + parseFloat(show.total_whatnot_fees || 0);
          const earnings = parseFloat(show.total_net_earnings || 0);
          const cogs = parseFloat(show.total_cogs || 0);
          const profit = parseFloat(show.total_net_profit || 0);
          const items = parseInt(show.item_count || 0);
          const buyers = parseInt(show.unique_buyers || 0);
          const avgOrder = buyers > 0 ? (revenue / buyers).toFixed(2) : '0.00';
          const roi = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          // Add to totals
          totalRevenue += revenue;
          totalCommission += commission;
          totalEarnings += earnings;
          totalCOGS += cogs;
          totalProfit += profit;
          totalItems += items;
          totalBuyers += buyers;
          if (cogs > 0) showsWithCOGS++;

          // Format date
          const date = new Date(show.show_date);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

          // Determine profit color
          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          // Truncate show name if too long
          const showName = show.show_name.length > 50 ? show.show_name.substring(0, 47) + '...' : show.show_name;

          return `
            <tr style="border-bottom:1px solid #1f2937; transition:background 0.2s; cursor:pointer;"
                onclick="viewShowDetail(${show.id})"
                onmouseover="this.style.background='#111827'"
                onmouseout="this.style.background='transparent'">
              <td style="padding:12px 8px; white-space:nowrap;">${dateStr}</td>
              <td style="padding:12px 8px;">
                <div style="font-weight:500;">${showName}</div>
              </td>
              <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${commission.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${cogs > 0 ? cogs.toFixed(2) : '-'}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${roi}${roi !== 'N/A' ? '%' : ''}</td>
              <td style="padding:12px 8px; text-align:center;" class="muted">${items}</td>
              <td style="padding:12px 8px; text-align:center;" class="muted">${buyers}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${avgOrder}</td>
            </tr>
          `;
        }).join('');

        // Add totals footer
        const avgROI = totalCOGS > 0 ? ((totalProfit / totalCOGS) * 100).toFixed(1) : 'N/A';
        const avgOrderTotal = totalBuyers > 0 ? (totalRevenue / totalBuyers).toFixed(2) : '0.00';

        tfoot.innerHTML = `
          <tr>
            <td style="padding:12px 8px;" colspan="2"><strong>TOTALS (${shows.length} shows)</strong></td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalRevenue.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCommission.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalEarnings.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCOGS.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${totalProfit > 0 ? '#22c55e' : '#ef4444'};">$${totalProfit.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${avgROI !== 'N/A' ? '#22c55e' : '#94a3b8'};">${avgROI}${avgROI !== 'N/A' ? '%' : ''}</td>
            <td style="padding:12px 8px; text-align:center;">${totalItems}</td>
            <td style="padding:12px 8px; text-align:center;">${totalBuyers}</td>
            <td style="padding:12px 8px; text-align:right;">$${avgOrderTotal}</td>
          </tr>
        `;

        // Update summary stats
        document.getElementById('totalShowsCount').textContent = shows.length;
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(0)}`;
        document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(0)}`;
        document.getElementById('avgROI').textContent = avgROI !== 'N/A' ? `${avgROI}%` : 'N/A';

      } catch (error) {
        document.getElementById("showsTableBody").innerHTML = `
          <tr><td colspan="11" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading shows: ${error.message}</td></tr>
        `;
      }
    }

    // Show Detail View Functions
    let currentShowTransactions = [];

    async function viewShowDetail(showId) {
      try {
        // Fetch show details
        const showRes = await fetch(`${apiBase}/shows/${showId}`, { headers: authHeaders() });
        const show = await showRes.json();

        // Fetch transactions for this show
        const transRes = await fetch(`${apiBase}/transactions?show_id=${showId}&limit=500`, { headers: authHeaders() });
        const transactions = await transRes.json();
        currentShowTransactions = transactions;

        // Update header
        const date = new Date(show.show_date);
        const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        document.getElementById('showDetailTitle').textContent = `üé¨ ${show.show_name}`;
        document.getElementById('showDetailMeta').textContent = `${dateStr} ‚Ä¢ ${transactions.length} transactions`;

        // Update summary stats
        const revenue = parseFloat(show.total_gross_sales || 0);
        const cogs = parseFloat(show.total_cogs || 0);
        const profit = parseFloat(show.total_net_profit || 0);
        document.getElementById('detailTotalItems').textContent = show.item_count || 0;
        document.getElementById('detailRevenue').textContent = `$${revenue.toFixed(2)}`;
        document.getElementById('detailCOGS').textContent = `$${cogs.toFixed(2)}`;
        document.getElementById('detailProfit').textContent = `$${profit.toFixed(2)}`;

        // Render transactions table
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = transactions.map((t, index) => {
          const revenue = parseFloat(t.total_revenue || t.gross_sale_price || 0);
          const earnings = parseFloat(t.net_earnings || 0);
          const cogs = parseFloat(t.cogs || 0);
          const profit = earnings - cogs;
          const roi = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          return `
            <tr style="border-bottom:1px solid #1f2937;">
              <td style="padding:12px 8px;">
                <div style="font-weight:500; max-width:300px;">${t.item_name}</div>
              </td>
              <td style="padding:12px 8px; text-align:center;">${t.quantity || 1}</td>
              <td style="padding:12px 8px;">@${t.buyer_username}</td>
              <td style="padding:12px 8px; text-align:right;">$${revenue.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; color:#22c55e;">$${earnings.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;">
                <input type="number"
                       step="0.01"
                       value="${cogs.toFixed(2)}"
                       data-transaction-id="${t.id}"
                       data-index="${index}"
                       onchange="updateTransactionCalc(${index})"
                       style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px;" />
              </td>
              <td id="profit-${index}" style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
              <td id="roi-${index}" style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${roi}${roi !== 'N/A' ? '%' : ''}</td>
            </tr>
          `;
        }).join('');

        // Hide shows list, show detail view
        document.getElementById('shows-list-view').style.display = 'none';
        document.getElementById('show-detail-view').style.display = 'block';

      } catch (error) {
        alert(`Error loading show details: ${error.message}`);
      }
    }

    function backToShowsList() {
      document.getElementById('show-detail-view').style.display = 'none';
      document.getElementById('shows-list-view').style.display = 'block';
      loadShows(); // Refresh the shows list
    }

    function updateTransactionCalc(index) {
      const t = currentShowTransactions[index];
      const cogsInput = document.querySelector(`input[data-index="${index}"]`);
      const newCOGS = parseFloat(cogsInput.value) || 0;

      const earnings = parseFloat(t.net_earnings || 0);
      const profit = earnings - newCOGS;
      const roi = newCOGS > 0 ? ((profit / newCOGS) * 100).toFixed(1) : 'N/A';

      const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
      const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

      document.getElementById(`profit-${index}`).textContent = `$${profit.toFixed(2)}`;
      document.getElementById(`profit-${index}`).style.color = profitColor;
      document.getElementById(`roi-${index}`).textContent = `${roi}${roi !== 'N/A' ? '%' : ''}`;
      document.getElementById(`roi-${index}`).style.color = roiColor;
    }

    async function saveAllCOGS() {
      const saveBtn = document.getElementById('saveCOGSBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const updates = [];
        const inputs = document.querySelectorAll('input[data-transaction-id]');

        for (const input of inputs) {
          const transactionId = parseInt(input.getAttribute('data-transaction-id'));
          const newCOGS = parseFloat(input.value) || 0;
          const index = parseInt(input.getAttribute('data-index'));
          const t = currentShowTransactions[index];
          const oldCOGS = parseFloat(t.cogs || 0);

          // Only update if changed
          if (Math.abs(newCOGS - oldCOGS) > 0.001) {
            updates.push({ id: transactionId, cogs: newCOGS });
          }
        }

        if (updates.length === 0) {
          alert('No changes to save');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save All COGS Changes';
          return;
        }

        // Update each transaction
        let successCount = 0;
        for (const update of updates) {
          const res = await fetch(`${apiBase}/transactions/${update.id}`, {
            method: 'PUT',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cogs: update.cogs })
          });

          if (res.ok) {
            successCount++;
          }
        }

        alert(`‚úÖ Updated ${successCount} of ${updates.length} transactions`);

        // Reload the show detail to refresh totals
        const showId = currentShowTransactions[0].show_id;
        viewShowDetail(showId);

      } catch (error) {
        alert(`Error saving COGS: ${error.message}`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save All COGS Changes';
      }
    }

    // Products
    async function loadProducts() {
      const filter = document.getElementById("productFilter").value;
      let url = `${apiBase}/products?limit=50`;
      if (filter === 'has_cogs') url += '&has_cogs=true';
      if (filter === 'missing_cogs') url += '&has_cogs=false';

      const res = await fetch(url, { headers: authHeaders() });
      const products = await res.json();
      const container = document.getElementById("productsList");
      container.innerHTML = products.map(p => `
        <div class="card">
          <strong>${p.product_name}</strong><br>
          <div class="muted">Sold ${p.times_sold}x ‚Ä¢ Avg: $${p.avg_sale_price}</div>
          <div>Total: <strong>$${p.total_gross_sales}</strong></div>
          ${p.default_cogs ? `<div class="success">COGS: $${p.default_cogs}</div>` : '<div class="warning">‚ö† Missing COGS</div>'}
        </div>
      `).join('');
    }

    // Buyers
    async function loadBuyers(repeatOnly = false) {
      const url = `${apiBase}/buyers?limit=50${repeatOnly ? '&repeat_only=true' : ''}`;
      const res = await fetch(url, { headers: authHeaders() });
      const buyers = await res.json();
      const container = document.getElementById("buyersList");
      container.innerHTML = buyers.map(b => `
        <div class="card">
          <strong>@${b.username}</strong> ${b.is_repeat_buyer ? '‚≠ê' : ''}<br>
          <div class="muted">${b.total_purchases} purchases ‚Ä¢ Avg: $${b.avg_purchase_price}</div>
          <div>Total Spent: <strong>$${b.total_spent}</strong></div>
        </div>
      `).join('');
    }

    // Analytics
    async function loadAnalytics() {
      const res = await fetch(`${apiBase}/analytics/overview`, { headers: authHeaders() });
      const data = await res.json();
      const stats = document.getElementById("analyticsStats");

      const cogsPct = data.cogs_coverage.coverage_percent || 0;
      stats.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">$${data.total_gross_sales}</div>
          <div class="stat-label">Gross Sales</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">$${data.total_net_earnings}</div>
          <div class="stat-label">Net Earnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">$${data.total_profit}</div>
          <div class="stat-label">Net Profit</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${cogsPct.toFixed(0)}%</div>
          <div class="stat-label">COGS Coverage</div>
        </div>
      `;

      const topProds = await fetch(`${apiBase}/analytics/top-products?limit=5`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("topProducts").innerHTML = topProds.map((p, i) =>
        `<div>${i+1}. ${p.product_name} - $${p.total_revenue}</div>`
      ).join('');

      const topBuy = await fetch(`${apiBase}/analytics/top-buyers?limit=5`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("topBuyers").innerHTML = topBuy.map((b, i) =>
        `<div>${i+1}. @${b.username} - $${b.total_spent} (${b.purchase_count} purchases)</div>`
      ).join('');

      const rulePref = await fetch(`${apiBase}/analytics/cogs-rule-performance`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("rulePerformance").innerHTML = rulePref.map(r =>
        `<div><strong>${r.rule_name}:</strong> ${r.matches} matches, $${r.total_cogs_assigned} COGS assigned</div>`
      ).join('');
    }

    // Master Catalog
    let allCatalogProducts = [];

    async function loadMasterCatalog() {
      const tbody = document.getElementById("masterCatalogTableBody");
      const tfoot = document.getElementById("masterCatalogTableFooter");
      const filter = document.getElementById("catalogFilter").value;

      try {
        // Get all products from whatnot_products table
        const res = await fetch(`${apiBase}/products?limit=1000`, { headers: authHeaders() });
        const products = await res.json();
        allCatalogProducts = products;

        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="muted">No products in catalog yet. Import shows or marketplace orders first.</td></tr>';
          return;
        }

        // Calculate stats
        let totalProducts = products.length;
        let totalSales = products.reduce((sum, p) => sum + (p.total_quantity_sold || 0), 0);
        let mappedCount = 0; // For now 0 until we add COGS rules
        let unmappedCount = totalProducts;

        // Update summary stats
        document.getElementById('catalogTotalProducts').textContent = totalProducts;
        document.getElementById('catalogTotalSales').textContent = totalSales;
        document.getElementById('catalogMappedCount').textContent = `${mappedCount} (0%)`;
        document.getElementById('catalogUnmappedCount').textContent = unmappedCount;

        // Filter products
        let filteredProducts = products;
        if (filter === 'mapped') {
          filteredProducts = products.filter(p => p.default_cogs && p.default_cogs > 0);
        } else if (filter === 'unmapped') {
          filteredProducts = products.filter(p => !p.default_cogs || p.default_cogs == 0);
        }

        // Render table
        renderMasterCatalogTable(filteredProducts, tbody, tfoot);

      } catch (error) {
        tbody.innerHTML = `
          <tr><td colspan="9" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading catalog: ${error.message}</td></tr>
        `;
      }
    }

    function renderMasterCatalogTable(products, tbody, tfoot) {
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="muted">No products match the filter.</td></tr>';
        return;
      }

      // Sort by total revenue descending
      const sorted = products.sort((a, b) => parseFloat(b.total_gross_sales || 0) - parseFloat(a.total_gross_sales || 0));

      let totalQty = 0;
      let totalRevenue = 0;
      let totalCOGS = 0;
      let totalProfit = 0;

      tbody.innerHTML = sorted.map(p => {
        const timesSold = p.times_sold || 0;
        const qty = p.total_quantity_sold || 0;
        const avgPrice = p.avg_sale_price || 0;
        const revenue = parseFloat(p.total_gross_sales || 0);

        // For now, COGS is 0 until rules are applied
        const cogsPerUnit = 0;
        const totalCogs = 0;
        const profit = 0;
        const status = '‚ö†Ô∏è Needs COGS';

        totalQty += qty;
        totalRevenue += revenue;
        totalCOGS += totalCogs;
        totalProfit += profit;

        return `
          <tr style="border-bottom:1px solid #1f2937;">
            <td style="padding:12px 8px;">
              <div style="font-weight:500;">${p.product_name}</div>
            </td>
            <td style="padding:12px 8px; text-align:center;">${timesSold}</td>
            <td style="padding:12px 8px; text-align:right;">${qty}</td>
            <td style="padding:12px 8px; text-align:right;">$${avgPrice.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;" class="muted">-</td>
            <td style="padding:12px 8px; text-align:right;" class="muted">-</td>
            <td style="padding:12px 8px; text-align:right;" class="muted">-</td>
            <td style="padding:12px 8px; text-align:center;">
              <span class="warning" style="font-size:11px;">${status}</span>
            </td>
          </tr>
        `;
      }).join('');

      // Footer totals
      tfoot.innerHTML = `
        <tr>
          <td style="padding:12px 8px;"><strong>TOTALS (${products.length} products)</strong></td>
          <td style="padding:12px 8px; text-align:center; font-weight:600;">-</td>
          <td style="padding:12px 8px; text-align:right; font-weight:600;">${totalQty}</td>
          <td style="padding:12px 8px;"></td>
          <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalRevenue.toFixed(2)}</td>
          <td style="padding:12px 8px; text-align:right;">-</td>
          <td style="padding:12px 8px; text-align:right;">-</td>
          <td style="padding:12px 8px; text-align:right;">-</td>
          <td style="padding:12px 8px;"></td>
        </tr>
      `;
    }

    function filterMasterCatalog() {
      const searchTerm = document.getElementById('catalogSearch').value.toLowerCase();
      const tbody = document.getElementById('masterCatalogTableBody');
      const tfoot = document.getElementById('masterCatalogTableFooter');

      if (!searchTerm) {
        loadMasterCatalog();
        return;
      }

      const filtered = allCatalogProducts.filter(p =>
        p.product_name.toLowerCase().includes(searchTerm)
      );

      renderMasterCatalogTable(filtered, tbody, tfoot);
    }

    // Marketplace Import
    async function uploadMarketplace() {
      const fileInput = document.getElementById("marketplaceFile");

      if (!fileInput.files[0]) {
        document.getElementById("marketplaceImportStatus").innerHTML = '<span class="warning">‚ö† Please select an Excel file</span>';
        return;
      }

      const fileName = fileInput.files[0].name;
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const statusEl = document.getElementById("marketplaceImportStatus");
      const resultsEl = document.getElementById("marketplaceImportResults");

      statusEl.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="spinner"></div>
          <div>
            <div style="font-weight:600; margin-bottom:4px;">üì§ Importing ${fileName}...</div>
            <div class="muted" style="font-size:11px;">Parsing marketplace orders ‚Üí Matching COGS rules</div>
          </div>
        </div>
      `;
      resultsEl.innerHTML = '';

      try {
        const startTime = Date.now();

        const res = await fetch(`${apiBase}/import/marketplace`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${adminKey}` },
          body: formData
        });

        const result = await res.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        if (res.ok) {
          const cogsPct = result.imported > 0 ? ((result.cogs_assigned_count / result.imported) * 100).toFixed(0) : 0;

          statusEl.innerHTML = `<div class="success" style="font-weight:600;">‚úÖ Import Complete (${elapsed}s)</div>`;

          resultsEl.innerHTML = `
            <div class="card" style="background:#111827; border:1px solid #22c55e;">
              <div style="font-weight:600; margin-bottom:12px; color:#22c55e;">üìä Import Summary</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">MARKETPLACE ORDERS</div>
                  <div style="font-size:20px; font-weight:600;">${result.imported}</div>
                  <div class="muted" style="font-size:11px;">from ${result.total_rows} rows</div>
                </div>
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">COGS COVERAGE</div>
                  <div style="font-size:20px; font-weight:600; color:${cogsPct >= 80 ? '#22c55e' : cogsPct >= 50 ? '#f59e0b' : '#ef4444'}">${cogsPct}%</div>
                  <div class="muted" style="font-size:11px;">${result.cogs_assigned_count} / ${result.imported} assigned</div>
                </div>
              </div>
              ${result.cogs_missing_count > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="warning">‚ö† ${result.cogs_missing_count} orders need COGS rules</div>
                  <div class="muted" style="font-size:11px; margin-top:4px;">Go to COGS Rules or Product Catalog to assign COGS</div>
                </div>
              ` : ''}
              ${result.errors.length > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="danger">‚ùå ${result.errors.length} errors:</div>
                  ${result.errors.map(e => `<div class="muted" style="font-size:11px;">‚Ä¢ ${e}</div>`).join('')}
                </div>
              ` : ''}
            </div>
          `;

          loadMarketplace();
          fileInput.value = '';
        } else {
          statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
          resultsEl.innerHTML = `
            <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
              <div class="danger">${result.detail || 'Unknown error'}</div>
            </div>
          `;
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
        resultsEl.innerHTML = `
          <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
            <div class="danger">${error.message}</div>
          </div>
        `;
      }
    }

    let expandedMarketplaceRows = new Set();
    let currentMarketplaceOrders = [];

    async function loadMarketplace() {
      const tbody = document.getElementById("marketplaceTableBody");
      const tfoot = document.getElementById("marketplaceTableFooter");

      try {
        const res = await fetch(`${apiBase}/transactions?sale_type=marketplace&limit=500`, { headers: authHeaders() });
        const orders = await res.json();
        currentMarketplaceOrders = orders;

        if (orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="muted">No marketplace orders yet. Import your first Excel file above!</td></tr>';
          document.getElementById('saveMarketplaceCOGSBtn').style.display = 'none';
          return;
        }

        // Show save button if admin
        if (adminEnabled) {
          document.getElementById('saveMarketplaceCOGSBtn').style.display = 'inline-block';
        }

        // Group orders by product name
        const grouped = {};
        orders.forEach(order => {
          const key = order.item_name;
          if (!grouped[key]) {
            grouped[key] = [];
          }
          grouped[key].push(order);
        });

        // Calculate totals
        let totalOrders = orders.length;
        let totalRevenue = 0;
        let totalEarnings = 0;
        let totalCOGS = 0;
        let totalProfit = 0;

        // Render grouped rows
        const rows = [];
        let orderIndex = 0; // Global index for tracking individual orders

        Object.keys(grouped).sort().forEach((productName, groupIndex) => {
          const items = grouped[productName];
          const count = items.length;

          // Calculate aggregates for this product
          const revenue = items.reduce((sum, o) => sum + parseFloat(o.total_revenue || o.gross_sale_price || 0), 0);
          const earnings = items.reduce((sum, o) => sum + parseFloat(o.net_earnings || 0), 0);
          const cogs = items.reduce((sum, o) => sum + parseFloat(o.cogs || 0), 0);
          const profit = earnings - cogs;
          const avgPrice = revenue / count;
          const avgCOGS = cogs / count;
          const avgROI = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          // Add to totals
          totalRevenue += revenue;
          totalEarnings += earnings;
          totalCOGS += cogs;
          totalProfit += profit;

          // Determine colors
          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = avgROI !== 'N/A' ? (parseFloat(avgROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          const isExpanded = expandedMarketplaceRows.has(productName);
          const expandIcon = isExpanded ? '‚ñº' : '‚ñ∂';

          // Main row
          // For single items (count == 1), show editable COGS in the main row
          if (count === 1) {
            const singleOrder = items[0];
            const currentOrderIndex = orderIndex;
            orderIndex++;

            const singleCOGS = parseFloat(singleOrder.cogs || 0);
            const singleProfit = earnings - singleCOGS;
            const singleROI = singleCOGS > 0 ? ((singleProfit / singleCOGS) * 100).toFixed(1) : 'N/A';
            const singleProfitColor = singleProfit > 0 ? '#22c55e' : singleProfit < 0 ? '#ef4444' : '#94a3b8';
            const singleROIColor = singleROI !== 'N/A' ? (parseFloat(singleROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

            rows.push(`
              <tr style="border-bottom:1px solid #1f2937; transition:background 0.2s;">
                <td style="padding:12px 8px; text-align:center; color:#94a3b8;"></td>
                <td style="padding:12px 8px;">
                  <div style="font-weight:500;">${productName}</div>
                </td>
                <td style="padding:12px 8px; text-align:center; font-weight:600;">${count}</td>
                <td style="padding:12px 8px; text-align:right;">$${avgPrice.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right;">
                  <input type="number"
                         step="0.01"
                         value="${singleCOGS.toFixed(2)}"
                         data-transaction-id="${singleOrder.id}"
                         data-marketplace-index="${currentOrderIndex}"
                         onchange="updateMarketplaceCalc(${currentOrderIndex})"
                         style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:13px;" />
                </td>
                <td id="marketplace-profit-${currentOrderIndex}" style="padding:12px 8px; text-align:right; font-weight:600; color:${singleProfitColor};">$${singleProfit.toFixed(2)}</td>
                <td id="marketplace-roi-${currentOrderIndex}" style="padding:12px 8px; text-align:right; font-weight:600; color:${singleROIColor};">${singleROI}${singleROI !== 'N/A' ? '%' : ''}</td>
              </tr>
            `);
          } else {
            // Multiple items - show grouped row (clickable to expand)
            rows.push(`
              <tr style="border-bottom:1px solid #1f2937; cursor:pointer; transition:background 0.2s;"
                  onclick="toggleMarketplaceExpand('${productName.replace(/'/g, "\\'")}', this)"
                  onmouseover="this.style.background='#111827'"
                  onmouseout="this.style.background='transparent'">
                <td style="padding:12px 8px; text-align:center; color:#94a3b8;">
                  ${expandIcon}
                </td>
                <td style="padding:12px 8px;">
                  <div style="font-weight:500;">${productName}</div>
                  <div class="muted" style="font-size:11px; margin-top:2px;">${count} orders</div>
                </td>
                <td style="padding:12px 8px; text-align:center; font-weight:600;">${count}</td>
                <td style="padding:12px 8px; text-align:right;">$${avgPrice.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right;" class="muted">${cogs > 0 ? `$${avgCOGS.toFixed(2)}` : '-'}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${avgROI}${avgROI !== 'N/A' ? '%' : ''}</td>
              </tr>
            `);
          }

          // Expanded detail rows (only for count > 1)
          if (count > 1) {
            if (isExpanded) {
              items.forEach((order, i) => {
                const currentOrderIndex = orderIndex;
                orderIndex++;

                const orderRevenue = parseFloat(order.total_revenue || order.gross_sale_price || 0);
                const orderEarnings = parseFloat(order.net_earnings || 0);
                const orderCOGS = parseFloat(order.cogs || 0);
                const orderProfit = orderEarnings - orderCOGS;
                const orderROI = orderCOGS > 0 ? ((orderProfit / orderCOGS) * 100).toFixed(1) : 'N/A';
                const orderProfitColor = orderProfit > 0 ? '#22c55e' : orderProfit < 0 ? '#ef4444' : '#94a3b8';
                const orderROIColor = orderROI !== 'N/A' ? (parseFloat(orderROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

                const date = new Date(order.transaction_date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                rows.push(`
                  <tr class="marketplace-detail-row" style="background:#0f172a; border-bottom:1px solid #1f2937;">
                    <td style="padding:8px 8px 8px 32px;"></td>
                    <td style="padding:8px;" colspan="2">
                      <div style="font-size:12px;" class="muted">${dateStr} ‚Ä¢ @${order.buyer_username || 'Unknown'}</div>
                    </td>
                    <td style="padding:8px; text-align:right; font-size:12px;">$${orderRevenue.toFixed(2)}</td>
                    <td style="padding:8px; text-align:right; font-size:12px;">-</td>
                    <td style="padding:8px; text-align:right; font-size:12px; color:#22c55e;">$${orderEarnings.toFixed(2)}</td>
                    <td style="padding:8px; text-align:right;">
                      <input type="number"
                             step="0.01"
                             value="${orderCOGS.toFixed(2)}"
                             data-transaction-id="${order.id}"
                             data-marketplace-index="${currentOrderIndex}"
                             onchange="updateMarketplaceCalc(${currentOrderIndex})"
                             style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;" />
                    </td>
                    <td id="marketplace-profit-${currentOrderIndex}" style="padding:8px; text-align:right; font-size:12px; color:${orderProfitColor};">$${orderProfit.toFixed(2)}</td>
                    <td id="marketplace-roi-${currentOrderIndex}" style="padding:8px; text-align:right; font-size:12px; color:${orderROIColor};">${orderROI}${orderROI !== 'N/A' ? '%' : ''}</td>
                  </tr>
                `);
              });
            } else {
              // Still increment orderIndex for items in collapsed groups
              orderIndex += items.length;
            }
          }
        });

        tbody.innerHTML = rows.join('');

        // Add totals footer
        const avgTotalROI = totalCOGS > 0 ? ((totalProfit / totalCOGS) * 100).toFixed(1) : 'N/A';

        tfoot.innerHTML = `
          <tr>
            <td style="padding:12px 8px;" colspan="2"><strong>TOTALS (${Object.keys(grouped).length} unique products, ${totalOrders} orders)</strong></td>
            <td style="padding:12px 8px; text-align:center; font-weight:600;">${totalOrders}</td>
            <td style="padding:12px 8px;"></td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalRevenue.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalEarnings.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCOGS.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${totalProfit > 0 ? '#22c55e' : '#ef4444'};">$${totalProfit.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${avgTotalROI !== 'N/A' ? '#22c55e' : '#94a3b8'};">${avgTotalROI}${avgTotalROI !== 'N/A' ? '%' : ''}</td>
          </tr>
        `;

        // Update summary stats
        document.getElementById('marketplaceTotalOrders').textContent = totalOrders;
        document.getElementById('marketplaceRevenue').textContent = `$${totalRevenue.toFixed(0)}`;
        document.getElementById('marketplaceEarnings').textContent = `$${totalEarnings.toFixed(0)}`;
        document.getElementById('marketplaceProfit').textContent = `$${totalProfit.toFixed(0)}`;

      } catch (error) {
        tbody.innerHTML = `
          <tr><td colspan="9" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading orders: ${error.message}</td></tr>
        `;
      }
    }

    function toggleMarketplaceExpand(productName, rowElement) {
      if (expandedMarketplaceRows.has(productName)) {
        expandedMarketplaceRows.delete(productName);
      } else {
        expandedMarketplaceRows.add(productName);
      }
      loadMarketplace();
    }

    function updateMarketplaceCalc(index) {
      const order = currentMarketplaceOrders[index];
      const cogsInput = document.querySelector(`input[data-marketplace-index="${index}"]`);
      const newCOGS = parseFloat(cogsInput.value) || 0;

      const earnings = parseFloat(order.net_earnings || 0);
      const profit = earnings - newCOGS;
      const roi = newCOGS > 0 ? ((profit / newCOGS) * 100).toFixed(1) : 'N/A';

      const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
      const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

      document.getElementById(`marketplace-profit-${index}`).textContent = `$${profit.toFixed(2)}`;
      document.getElementById(`marketplace-profit-${index}`).style.color = profitColor;
      document.getElementById(`marketplace-roi-${index}`).textContent = `${roi}${roi !== 'N/A' ? '%' : ''}`;
      document.getElementById(`marketplace-roi-${index}`).style.color = roiColor;
    }

    async function saveAllMarketplaceCOGS() {
      const saveBtn = document.getElementById('saveMarketplaceCOGSBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const updates = [];
        const inputs = document.querySelectorAll('input[data-transaction-id]');

        for (const input of inputs) {
          const transactionId = parseInt(input.getAttribute('data-transaction-id'));
          const newCOGS = parseFloat(input.value) || 0;
          const index = parseInt(input.getAttribute('data-marketplace-index'));
          const order = currentMarketplaceOrders[index];
          const oldCOGS = parseFloat(order.cogs || 0);

          // Only update if changed
          if (Math.abs(newCOGS - oldCOGS) > 0.001) {
            updates.push({ id: transactionId, cogs: newCOGS });
          }
        }

        if (updates.length === 0) {
          alert('No changes to save');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save All COGS Changes';
          return;
        }

        // Update each transaction
        let successCount = 0;
        for (const update of updates) {
          const res = await fetch(`${apiBase}/transactions/${update.id}`, {
            method: 'PUT',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cogs: update.cogs })
          });

          if (res.ok) {
            successCount++;
          }
        }

        alert(`‚úÖ Updated ${successCount} of ${updates.length} marketplace orders`);

        // Reload marketplace to refresh totals
        await loadMarketplace();

      } catch (error) {
        alert(`Error saving COGS: ${error.message}`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save All COGS Changes';
      }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      // Start in view-only mode - show tabs but disable editing
      document.querySelector('.tabs').style.display = 'flex';
      document.getElementById("adminStatus").innerHTML = 'üëÅÔ∏è View Only';

      // Hide admin-only tabs initially (Import, COGS Rules, Master Catalog)
      const importTab = document.querySelector('.tab[onclick*="import"]');
      const rulesTab = document.querySelector('.tab[onclick*="cogs-rules"]');
      const catalogTab = document.querySelector('.tab[onclick*="master-catalog"]');
      importTab.style.display = 'none';
      rulesTab.style.display = 'none';
      catalogTab.style.display = 'none';

      // Show Shows tab by default (view-only mode)
      showTab('shows');

      // Allow Enter key to enable admin
      document.getElementById("adminPin").addEventListener("keypress", (e) => {
        if (e.key === "Enter") enableAdmin();
      });
    });
  </script>
</body>
</html>
