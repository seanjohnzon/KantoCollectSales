<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>WhatNot Sales Tracker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 24px; background: #111827; border-bottom: 1px solid #1f2937; }
    main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    h1 { margin: 0; font-size: 24px; }
    h2 { font-size: 18px; margin: 0 0 16px; }
    .card { background: #111827; padding: 16px; border-radius: 12px; border: 1px solid #1f2937; margin-bottom: 16px; }
    label { display: block; margin: 8px 0 4px; font-size: 12px; color: #94a3b8; }
    input, select, textarea, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #e2e8f0; font-family: inherit; font-size: 14px; }
    textarea { width: 100%; min-height: 60px; }
    button { cursor: pointer; background: #22c55e; border-color: #22c55e; color: #0f172a; font-weight: 600; transition: all 0.2s; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    button.secondary { background: #0f172a; color: #e2e8f0; border-color: #334155; }
    button.danger { background: #ef4444; border-color: #ef4444; color: white; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: #94a3b8; font-size: 12px; }
    .success { color: #22c55e; }
    .warning { color: #f59e0b; }
    .danger { color: #ef4444; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid #1f2937; margin-bottom: 24px; }
    .tab { padding: 12px 20px; cursor: pointer; color: #94a3b8; border-radius: 8px 8px 0 0; transition: all 0.2s; }
    .tab:hover { background: #111827; }
    .tab.active { background: #111827; color: #e2e8f0; border-bottom: 2px solid #22c55e; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }

    /* Spinner animation */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #1f2937;
      border-top-color: #22c55e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .stat-card { background: #111827; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #1f2937; }
    .stat-value { font-size: 32px; font-weight: 700; color: #22c55e; margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Tags */
    .tag-input { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; min-height: 40px; }
    .tag { background: #22c55e; color: #0f172a; padding: 4px 8px; border-radius: 6px; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; }
    .tag .remove { cursor: pointer; font-weight: bold; }

    /* Table */
    table { border: 1px solid #1f2937; }
    th { color: #e2e8f0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    td { color: #cbd5e1; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: #111827; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid #1f2937; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-close { cursor: pointer; font-size: 24px; color: #94a3b8; }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #1f2937; }
    th { color: #94a3b8; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    tr:hover { background: #0f172a; }
  </style>
</head>
<body>
  <header>
    <h1>üé¨ WhatNot Sales Tracker</h1>
    <div class="muted">Track stream sales, auto-assign COGS, analyze performance</div>
  </header>
  <main>
    <!-- Admin Lock/Unlock -->
    <div class="card">
      <h2>üîê Admin Access</h2>
      <div class="row">
        <input id="adminPin" type="password" placeholder="Enter PIN" style="width:150px;" maxlength="4" />
        <button onclick="enableAdmin()" id="enableBtn">Enable Admin</button>
        <button class="secondary" onclick="disableAdmin()" id="disableBtn" style="display:none;">Disable Admin</button>
        <span id="adminStatus" class="muted">üëÅÔ∏è View Only Mode (Enable admin to make edits)</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab" onclick="showTab('import')" id="import-tab-btn" style="display:none;">üì§ Import</div>
      <div class="tab" onclick="showTab('master-catalog')" id="catalog-tab-btn">üìã Master Catalog</div>
      <div class="tab" onclick="showTab('cogs-rules')" id="cogs-rules-tab-btn" style="display:none;">‚≠ê COGS Rules</div>
      <div class="tab active" onclick="showTab('analytics')">üìä Analytics</div>
      <div class="tab" onclick="showTab('shows')">üé¨ Shows</div>
      <div class="tab" onclick="showTab('marketplace')">üõí Marketplace</div>
      <div class="tab" onclick="showTab('inventory')" id="inventory-tab-btn">üè™ Inventory</div>
      <div class="tab" onclick="showTab('products')">üè∑Ô∏è Products</div>
      <div class="tab" onclick="showTab('singles')">üÉè Singles</div>
      <div class="tab" onclick="showTab('buyers')">üë• Buyers</div>
      <div class="tab" onclick="showTab('owners')">üë§ Owners</div>
    </div>

    <!-- IMPORT TAB -->
    <div id="import-tab" class="tab-content">
      <div class="card">
        <h2>üì§ Import Excel File</h2>
        <p class="muted">Upload your WhatNot sales Excel file. Show name and date will be automatically extracted.</p>
        <label for="excelFile">Select Excel File</label>
        <input id="excelFile" type="file" accept=".xlsx,.xls" />
        <div class="row" style="margin-top:12px;">
          <button onclick="uploadExcel()">Upload & Import</button>
          <span id="importStatus" class="muted"></span>
        </div>
        <div id="importResults" style="margin-top:16px;"></div>
      </div>

      <div class="card">
        <h2>üìã Recent Imports</h2>
        <div id="recentImports" class="grid"></div>
      </div>
    </div>

    <!-- MASTER CATALOG TAB -->
    <div id="master-catalog-tab" class="tab-content">
      <div class="card">
        <h2>üìã Master Catalog - Assign COGS</h2>
        <p class="muted" style="margin-bottom:16px;">Set default COGS for each product. These values will be used when creating COGS mapping rules.</p>

        <!-- Add New Item Section -->
        <div style="background:#0f172a; padding:20px; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px;">
          <h3 style="margin:0 0 16px 0; font-size:16px;">‚ûï Add New Item to Catalog</h3>
          <div style="display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end;">
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; color:#94a3b8;">Image URL from ImageKit</label>
              <input id="newCatalogImageUrl" type="text"
                     placeholder="Paste image URL here (e.g., https://ik.imagekit.io/homecraft/Item%20Pics/...)"
                     style="width:100%; padding:10px; background:#1e293b; border:1px solid #334155; border-radius:6px; color:#e2e8f0; font-size:13px;" />
            </div>
            <button onclick="addCatalogItem()" style="padding:10px 24px; white-space:nowrap;">
              ‚ûï Add to Catalog
            </button>
          </div>
          <div id="addCatalogMessage" style="margin-top:12px; font-size:13px;"></div>
        </div>

        <!-- Instructions -->
        <div style="margin-bottom:16px;">
          <div class="muted" style="font-size:12px;">üí° Enter COGS for each item and click "Apply COGS" to save and lock. Click the value to edit later.</div>
        </div>

        <!-- Products Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600; width:80px;">Image</th>
                <th style="padding:12px 8px; font-weight:600;">Product Name</th>
                <th style="padding:12px 8px; font-weight:600;">Category</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Sales</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Revenue</th>
                <th id="keywords-header" style="padding:12px 8px; font-weight:600; display:none;">Keywords</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">COGS ($)</th>
                <th id="catalog-owner-header" style="padding:12px 8px; font-weight:600; display:none;">Owner</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center; width:80px;">Actions</th>
              </tr>
            </thead>
            <tbody id="catalogTableBody">
              <tr>
                <td colspan="9" style="padding:20px; text-align:center;" class="muted">Loading master catalog...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- COGS RULES TAB -->
    <div id="cogs-rules-tab" class="tab-content">
      <div class="card">
        <h2>‚≠ê COGS Mapping Rules</h2>
        <p class="muted" style="margin-bottom:20px;">Create keyword-based rules to automatically assign COGS to products. Rules are checked by priority (higher numbers first).</p>

        <!-- Add New Rule Form -->
        <div style="background:#0f172a; padding:20px; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px;">
          <h3 style="margin:0 0 16px 0; font-size:16px;">‚ûï Add New Rule</h3>
          <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
            <div>
              <label>Rule Name</label>
              <input id="newRuleName" type="text" placeholder="e.g., Booster Packs" style="width:100%;" />
            </div>
            <div>
              <label>COGS Amount ($)</label>
              <input id="newRuleCOGS" type="number" step="0.01" placeholder="0.00" style="width:100%;" />
            </div>
            <div>
              <label>Priority</label>
              <input id="newRulePriority" type="number" placeholder="100" value="100" style="width:100%;" />
            </div>
            <div>
              <label>Match Type</label>
              <select id="newRuleMatchType" style="width:100%;">
                <option value="contains">Contains</option>
                <option value="starts_with">Starts With</option>
                <option value="ends_with">Ends With</option>
                <option value="exact">Exact Match</option>
              </select>
            </div>
          </div>
          <div style="margin-bottom:12px;">
            <label>Keywords (comma-separated)</label>
            <input id="newRuleKeywords" type="text" placeholder="booster, booster pack, bp" style="width:100%;" />
            <div class="muted" style="margin-top:4px;">Enter keywords separated by commas. Example: "booster pack, booster, bp"</div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
            <div>
              <label>Category (optional)</label>
              <input id="newRuleCategory" type="text" placeholder="e.g., Sealed Products" style="width:100%;" />
            </div>
            <div>
              <label>Notes (optional)</label>
              <input id="newRuleNotes" type="text" placeholder="Description of this rule" style="width:100%;" />
            </div>
          </div>
          <button onclick="createNewRule()">‚úÖ Create Rule</button>
        </div>

        <!-- Existing Rules List -->
        <h3 style="margin:0 0 16px 0; font-size:16px;">üìã Existing Rules (<span id="rulesCount">0</span>)</h3>
        <div id="cogsRulesList"></div>
      </div>
    </div>

    <!-- SHOWS TAB -->
    <div id="shows-tab" class="tab-content">
      <!-- Shows List View -->
      <div id="shows-list-view" class="card">
        <h2>üé¨ WhatNot Stream Sales</h2>
        <p class="muted" style="margin-bottom:16px;">Click on any show to view and edit transaction details</p>

        <!-- Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="totalShowsCount">0</div>
            <div class="stat-label">Total Shows</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalEarnings">$0</div>
            <div class="stat-label">Total Earnings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgROI">0%</div>
            <div class="stat-label">Average ROI</div>
          </div>
        </div>

        <!-- Shows Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600;">Date</th>
                <th style="padding:12px 8px; font-weight:600;">Show Name</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Revenue</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Commission</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Earnings</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total COGS</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Net Profit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">ROI %</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Items</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Buyers</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg Order</th>
              </tr>
            </thead>
            <tbody id="showsTableBody">
              <tr>
                <td colspan="11" style="padding:20px; text-align:center;" class="muted">Loading shows...</td>
              </tr>
            </tbody>
            <tfoot id="showsTableFooter" style="background:#1f2937; border-top:2px solid #22c55e; font-weight:600;">
              <!-- Totals row will be added here -->
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Show Detail View -->
      <div id="show-detail-view" class="card" style="display:none;">
        <div style="margin-bottom:20px;">
          <button class="secondary" onclick="backToShowsList()">‚Üê Back to Shows</button>
        </div>

        <h2 id="showDetailTitle">Show Details</h2>
        <div id="showDetailMeta" class="muted" style="margin-bottom:20px;"></div>

        <!-- Show Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="detailTotalItems">0</div>
            <div class="stat-label">Items Sold</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailCOGS">$0</div>
            <div class="stat-label">Total COGS</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="detailProfit">$0</div>
            <div class="stat-label">Net Profit</div>
          </div>
        </div>

        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
          <h3 style="margin:0;">Transactions</h3>
          <div style="display:flex; gap:8px; align-items:center;">
            <div id="assignOwnerSection" style="display:flex; gap:8px; align-items:center;">
              <span class="muted" style="font-size:13px;">Assign to entire show:</span>
              <select id="showOwnerSelect" style="padding:6px 8px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:13px;">
                <option value="">Select Owner</option>
                <option value="Cihan">Cihan</option>
                <option value="Nima">Nima</option>
                <option value="Askar">Askar</option>
                <option value="Kanto">Kanto</option>
              </select>
              <button onclick="assignOwnerToShow()" class="secondary" style="white-space:nowrap;">Assign Owner</button>
            </div>
            <button onclick="saveAllCOGS()" id="saveCOGSBtn">üíæ Save COGS</button>
          </div>
        </div>

        <!-- Transactions Table -->
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#0f172a;">
                <th style="padding:12px 8px;">Product</th>
                <th style="padding:12px 8px; text-align:center;">Qty</th>
                <th style="padding:12px 8px;">Buyer</th>
                <th style="padding:12px 8px; text-align:right;">Price</th>
                <th style="padding:12px 8px; text-align:right;">Earnings</th>
                <th style="padding:12px 8px; text-align:right;">COGS</th>
                <th style="padding:12px 8px; text-align:right;">Profit</th>
                <th style="padding:12px 8px; text-align:right;">ROI%</th>
                <th style="padding:12px 8px;">Owner</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div id="showPaginationControls" style="display:flex; justify-content:center; align-items:center; gap:12px; margin-top:16px; padding:16px;">
          <button id="showPrevBtn" onclick="previousShowPage()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;">
            ‚Üê Previous
          </button>
          <span id="showPageInfo" style="color:#94a3b8; font-size:14px;">Page 1 of 1</span>
          <button id="showNextBtn" onclick="nextShowPage()" style="padding:8px 16px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;">
            Next ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- MARKETPLACE TAB -->
    <div id="marketplace-tab" class="tab-content">
      <div class="card">
        <h2>üõí Marketplace Orders</h2>
        <p class="muted" style="margin-bottom:16px;">Import and manage WhatNot marketplace orders (non-stream sales)</p>

        <!-- Import Section -->
        <div style="padding:16px; background:#0f172a; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px;">
          <h3 style="margin:0 0 12px 0; font-size:16px;">üì§ Import Marketplace Excel</h3>
          <div class="row">
            <input type="file" id="marketplaceFile" accept=".xlsx,.xls" style="flex:1;" />
            <button onclick="uploadMarketplace()">Upload & Import</button>
          </div>
          <div id="marketplaceImportStatus" style="margin-top:12px;"></div>
          <div id="marketplaceImportResults" style="margin-top:12px;"></div>
        </div>

        <!-- Summary Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="marketplaceTotalOrders">0</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceRevenue">$0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceEarnings">$0</div>
            <div class="stat-label">Total Earnings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="marketplaceProfit">$0</div>
            <div class="stat-label">Net Profit</div>
          </div>
        </div>

        <!-- Orders Table -->
        <div style="margin-bottom:16px; display:flex; justify-content:flex-end; align-items:center;">
          <button onclick="saveAllMarketplaceCOGS()" id="saveMarketplaceCOGSBtn" style="display:none;">üíæ Save All COGS Changes</button>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                <th style="padding:12px 8px; font-weight:600; width:40px;"></th>
                <th style="padding:12px 8px; font-weight:600;">Product Name</th>
                <th style="padding:12px 8px; font-weight:600; text-align:center;">Qty Sold</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg Price</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Revenue</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Earnings</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg COGS</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Total Profit</th>
                <th style="padding:12px 8px; font-weight:600; text-align:right;">Avg ROI%</th>
                <th style="padding:12px 8px; font-weight:600;">Owner</th>
              </tr>
            </thead>
            <tbody id="marketplaceTableBody">
              <tr>
                <td colspan="10" style="padding:20px; text-align:center;" class="muted">Loading marketplace orders...</td>
              </tr>
            </tbody>
            <tfoot id="marketplaceTableFooter" style="background:#1f2937; border-top:2px solid #22c55e; font-weight:600;">
              <!-- Totals row will be added here -->
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- INVENTORY TAB -->
    <div id="inventory-tab" class="tab-content">
      <div class="card">
        <h2>üè™ Inventory Management</h2>
        <p class="muted" style="margin-bottom:16px;">Track items in stock - use +/- buttons to adjust quantities</p>

        <!-- Inventory Stats -->
        <div class="stat-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-value" id="inventoryTotalItems">0</div>
            <div class="stat-label">Unique Items</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="inventoryTotalQty">0</div>
            <div class="stat-label">Total Quantity</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="inventoryTotalValue">$0</div>
            <div class="stat-label">Total Value</div>
          </div>
          <div class="stat-card">
            <div class="stat-value warning" id="inventoryLowStock">0</div>
            <div class="stat-label">Out of Stock</div>
          </div>
        </div>

        <!-- Add from Catalog (Admin Only) -->
        <div id="addFromCatalogSection" style="background:#0f172a; padding:16px 20px; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px; display:none;">
          <div style="display:flex; align-items:center; flex-wrap:wrap; gap:12px;">
            <h3 style="margin:0; font-size:15px;">‚ûï Add from Master Catalog</h3>
            <select id="catalogItemSelect" style="flex:1; min-width:250px; padding:10px 12px; background:#1e293b; border:1px solid #334155; color:#e2e8f0; border-radius:6px;">
              <option value="">-- Select item to add --</option>
            </select>
            <button onclick="addFromCatalog()">‚ûï Add to Inventory</button>
          </div>
          <div id="addFromCatalogMessage" style="margin-top:12px;"></div>
        </div>

        <!-- Filters -->
        <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center;">
          <input id="inventorySearch" placeholder="Search items..." style="flex:1; min-width:200px;" onkeyup="if(event.key==='Enter') loadInventory()" />
          <select id="inventoryStatusFilter" onchange="loadInventory()" style="padding:8px 12px;">
            <option value="">All Status</option>
            <option value="in_stock">In Stock</option>
            <option value="low_stock">Low Stock</option>
            <option value="out_of_stock">Out of Stock</option>
          </select>
          <select id="inventoryCategoryFilter" onchange="loadInventory()" style="padding:8px 12px;">
            <option value="">All Categories</option>
            <option value="Booster Box">Booster Box</option>
            <option value="ETB">ETB</option>
            <option value="UPC">UPC</option>
            <option value="Booster Bundle">Booster Bundle</option>
            <option value="Singles">Singles</option>
            <option value="Supplies">Supplies</option>
            <option value="Other">Other</option>
          </select>
          <button class="secondary" onclick="loadInventory()">üîç Search</button>
        </div>

        <!-- Inventory Grid -->
        <div id="inventoryGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px;">
          <!-- Items loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- PRODUCTS TAB -->
    <div id="products-tab" class="tab-content">
      <div class="card">
        <h2>üè∑Ô∏è Product Performance</h2>
        <div class="row" style="margin-bottom:12px;">
          <input id="productSearch" placeholder="Search products..." style="flex:1;" />
          <select id="productFilter" onchange="loadProducts()">
            <option value="all">All Products</option>
            <option value="has_cogs">Has COGS</option>
            <option value="missing_cogs">Missing COGS</option>
          </select>
        </div>
        <div id="productsList" class="grid"></div>
        <div id="productsPagination" style="margin-top:20px; display:flex; justify-content:center; gap:8px; flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- SINGLES TAB -->
    <div id="singles-tab" class="tab-content">
      <div class="card">
        <h2>üÉè Single Cards Management</h2>
        <p class="muted" style="margin-bottom:16px;">Manage individual single card sales. Map generic "OP Single" transactions to specific cards.</p>

        <!-- Add New Single Card Section -->
        <div id="addSingleSection" style="background:#0f172a; padding:20px; border-radius:8px; border:1px solid #1f2937; margin-bottom:24px; display:none;">
          <h3 style="margin:0 0 16px 0; font-size:16px;">‚ûï Add New Single Card</h3>
          <div style="display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end;">
            <div>
              <label style="display:block; margin-bottom:6px; font-size:13px; color:#94a3b8;">Image URL from ImageKit</label>
              <input id="newSingleImageUrl" type="text"
                     placeholder="Paste image URL here (e.g., https://ik.imagekit.io/homecraft/...)"
                     style="width:100%; padding:10px; background:#1e293b; border:1px solid #334155; border-radius:6px; color:#e2e8f0; font-size:13px;" />
            </div>
            <button onclick="addSingleCard()" style="padding:10px 24px; white-space:nowrap;">
              ‚ûï Add Card
            </button>
          </div>
          <div id="addSingleMessage" style="margin-top:12px; font-size:13px;"></div>
        </div>

        <!-- Stats -->
        <div id="singlesStats" class="stat-grid" style="margin-bottom:24px;"></div>

        <!-- Unmapped Singles Section -->
        <div id="unmappedSinglesSection" style="margin-bottom:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 style="margin:0; color:#f59e0b;">‚ö†Ô∏è Unmapped Singles (<span id="unmappedCount">0</span>)</h3>
            <div class="muted" style="font-size:12px;">These need to be assigned to specific cards</div>
          </div>
          <div id="unmappedSinglesList" style="max-height:300px; overflow-y:auto; border:1px solid #1f2937; border-radius:8px;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="background:#1f2937; text-align:left; position:sticky; top:0;">
                  <th style="padding:10px 8px; font-weight:600;">Date</th>
                  <th style="padding:10px 8px; font-weight:600;">Item Name</th>
                  <th style="padding:10px 8px; font-weight:600;">Show</th>
                  <th style="padding:10px 8px; font-weight:600; text-align:right;">Price</th>
                  <th style="padding:10px 8px; font-weight:600;">Buyer</th>
                  <th style="padding:10px 8px; font-weight:600; text-align:center;">Map To</th>
                </tr>
              </thead>
              <tbody id="unmappedSinglesBody">
                <tr><td colspan="6" style="padding:20px; text-align:center;" class="muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Singles Grid -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0;">üìã Single Cards Catalog</h3>
          <div class="row">
            <input id="singlesSearch" placeholder="Search singles..." style="width:200px;" onkeyup="filterSingles()" />
          </div>
        </div>
        <div id="singlesGrid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px;">
          <div class="muted" style="padding:20px; text-align:center;">Loading singles...</div>
        </div>
      </div>
    </div>

    <!-- BUYERS TAB -->
    <div id="buyers-tab" class="tab-content">
      <div class="card">
        <h2>üë• Buyer Analytics</h2>
        <div class="row" style="margin-bottom:12px;">
          <input id="buyerSearch" placeholder="Search buyers..." style="flex:1;" />
          <button class="secondary" onclick="loadBuyers(true)">Repeat Buyers Only</button>
        </div>
        <div id="buyersList" class="grid"></div>
      </div>
    </div>

    <!-- OWNERS TAB -->
    <div id="owners-tab" class="tab-content">
      <div class="card">
        <h2>üë§ Ownership Management</h2>
        <p class="muted">View and manage transaction ownership assignments</p>

        <!-- Owner Summary Cards -->
        <div id="ownersSummary" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; margin-bottom:24px;">
          <!-- Summary cards will be populated here -->
        </div>

        <!-- Kanto Inventory Section (only shows when Kanto is selected) -->
        <div id="kantoInventorySection" style="display:none; margin-top:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0;">üì¶ Kanto Inventory</h3>
            <div style="font-size:12px; color:#94a3b8;">Business inventory items</div>
          </div>
          <div id="kantoInventoryGrid" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:12px; max-height:400px; overflow-y:auto; padding:4px;">
            <!-- Inventory items will be loaded here -->
          </div>
        </div>

        <!-- Transactions by Owner -->
        <div id="ownerTransactionsSection" style="margin-top:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
            <h3 style="margin:0;">Transactions</h3>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <div style="display:flex; align-items:center; gap:8px;">
                <label style="font-size:12px; color:#94a3b8;">Catalog Item:</label>
                <select id="ownerCatalogFilter" onchange="loadOwnerTransactions()" style="padding:8px 12px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; max-width:200px;">
                  <option value="all">All Items</option>
                  <!-- Catalog items will be populated dynamically -->
                </select>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <label style="font-size:12px; color:#94a3b8;">Owner:</label>
                <select id="ownerFilter" onchange="loadOwnerTransactions()" style="padding:8px 12px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px;">
                  <option value="all">All Owners</option>
                  <option value="Cihan">Cihan</option>
                  <option value="Nima">Nima</option>
                  <option value="Askar">Askar</option>
                  <option value="Kanto">Kanto</option>
                  <option value="Unassigned">Unassigned</option>
                </select>
              </div>
            </div>
          </div>

          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="background:#1f2937; text-align:left; border-bottom:2px solid #22c55e;">
                  <th style="padding:12px 8px; font-weight:600;">Date</th>
                  <th style="padding:12px 8px; font-weight:600;">Item</th>
                  <th style="padding:12px 8px; font-weight:600;">Catalog</th>
                  <th style="padding:12px 8px; font-weight:600;">Source</th>
                  <th style="padding:12px 8px; font-weight:600; text-align:right;">Revenue</th>
                  <th style="padding:12px 8px; font-weight:600; text-align:right;">Earnings</th>
                  <th style="padding:12px 8px; font-weight:600; text-align:right;">COGS</th>
                  <th style="padding:12px 8px; font-weight:600; text-align:right;">Profit</th>
                  <th style="padding:12px 8px; font-weight:600;">Owner</th>
                  <th style="padding:12px 8px; font-weight:600;">Actions</th>
                </tr>
              </thead>
              <tbody id="ownerTransactionsBody">
                <tr>
                  <td colspan="10" style="padding:20px; text-align:center;" class="muted">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="tab-content active">
      <div id="analyticsStats" class="stat-grid"></div>
      <div class="grid">
        <div class="card">
          <h2>üèÜ Top Products</h2>
          <div id="topProducts"></div>
        </div>
        <div class="card">
          <h2>üëë Top Buyers</h2>
          <div id="topBuyers"></div>
        </div>
      </div>
      <div class="card" id="cogs-rule-performance-card" style="display:none;">
        <h2>‚≠ê COGS Rule Performance</h2>
        <div id="rulePerformance"></div>
      </div>
    </div>

    <!-- COGS Rule Modal (DEPRECATED - Using inline form now) -->
    <div id="cogsRuleModal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="ruleModalTitle">New COGS Rule</h2>
          <span class="modal-close" onclick="closeRuleModal()">√ó</span>
        </div>
        <label for="ruleName">Rule Name</label>
        <input id="ruleName" placeholder="e.g., One Piece AA Cards" />

        <label>Keywords (press Enter to add)</label>
        <div id="keywordTags" class="tag-input">
          <input id="keywordInput" placeholder="Type keyword..." style="border:none;flex:1;background:transparent;" onkeydown="handleKeywordEnter(event)" />
        </div>

        <label for="matchType">Match Type</label>
        <select id="matchType">
          <option value="contains">Contains</option>
          <option value="starts_with">Starts With</option>
          <option value="ends_with">Ends With</option>
          <option value="exact">Exact Match</option>
        </select>

        <label for="cogsAmount">COGS Amount ($)</label>
        <input id="cogsAmount" type="number" step="0.01" placeholder="25.00" />

        <label for="priority">Priority (higher = checked first)</label>
        <input id="priority" type="number" value="50" />

        <label for="category">Category (optional)</label>
        <input id="category" placeholder="e.g., One Piece Cards" />

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Description of what this rule covers..."></textarea>

        <div class="row" style="margin-top:16px;">
          <button onclick="saveRule()">Save Rule</button>
          <button class="secondary" onclick="testRule()">Test Rule</button>
          <button class="secondary" onclick="closeRuleModal()">Cancel</button>
        </div>
        <div id="ruleTestResults" style="margin-top:12px;"></div>
      </div>
    </div>
  </main>

  <script>
    const apiBase = "/api/v1/admin/whatnot";
    let currentKeywords = [];
    let editingRuleId = null;
    let adminEnabled = false;
    let adminKey = null;

    // Admin lock/unlock
    function enableAdmin() {
      const pin = document.getElementById("adminPin").value;
      if (pin === "1453") {
        adminEnabled = true;
        adminKey = "1453";
        document.getElementById("adminStatus").innerHTML = '‚úÖ Admin Enabled';
        document.getElementById("adminStatus").className = 'success';
        document.getElementById("enableBtn").style.display = 'none';
        document.getElementById("disableBtn").style.display = 'inline-block';
        document.getElementById("adminPin").value = '';
        updateUIForAdminMode();
        // Switch to catalog tab for convenience when admin is enabled
        showTab('master-catalog');
      } else {
        alert('Invalid PIN');
      }
    }

    function disableAdmin() {
      adminEnabled = false;
      adminKey = null;
      document.getElementById("adminStatus").innerHTML = 'üëÅÔ∏è View Only';
      document.getElementById("adminStatus").className = 'muted';
      document.getElementById("enableBtn").style.display = 'inline-block';
      document.getElementById("disableBtn").style.display = 'none';
      updateUIForAdminMode();
    }

    function updateUIForAdminMode() {
      // Show/hide admin-only tabs
      const importTabBtn = document.getElementById('import-tab-btn');
      const catalogTabBtn = document.getElementById('catalog-tab-btn');
      const cogsRulesTabBtn = document.getElementById('cogs-rules-tab-btn');

      if (importTabBtn) importTabBtn.style.display = adminEnabled ? 'block' : 'none';  // Import tab only for admins
      if (catalogTabBtn) catalogTabBtn.style.display = adminEnabled ? 'block' : 'block'; // Catalog visible to all for viewing
      if (cogsRulesTabBtn) cogsRulesTabBtn.style.display = adminEnabled ? 'block' : 'none'; // COGS Rules only for admins

      // Show/hide COGS Rule Performance card in Analytics tab
      const cogsRulePerformanceCard = document.getElementById('cogs-rule-performance-card');
      if (cogsRulePerformanceCard) cogsRulePerformanceCard.style.display = adminEnabled ? 'block' : 'none';

      // Show/hide Keywords column in Master Catalog
      const keywordsHeader = document.getElementById('keywords-header');
      if (keywordsHeader) keywordsHeader.style.display = adminEnabled ? 'table-cell' : 'none';

      // Show/hide Owner column in Master Catalog
      const catalogOwnerHeader = document.getElementById('catalog-owner-header');
      if (catalogOwnerHeader) catalogOwnerHeader.style.display = adminEnabled ? 'table-cell' : 'none';
      document.querySelectorAll('.catalog-owner-column').forEach(col => {
        col.style.display = adminEnabled ? 'table-cell' : 'none';
      });

      // Show/hide Owner assignment section in Shows tab
      const assignOwnerSection = document.getElementById('assignOwnerSection');
      if (assignOwnerSection) assignOwnerSection.style.display = adminEnabled ? 'flex' : 'none';

      // Show/hide Inventory add from catalog section
      const addFromCatalogSection = document.getElementById('addFromCatalogSection');
      if (addFromCatalogSection) addFromCatalogSection.style.display = adminEnabled ? 'block' : 'none';

      // Hide/show all edit buttons and input fields
      // HIDE (not disable) all text/number inputs for non-admins
      document.querySelectorAll('input[type="number"], input[type="text"], textarea, select').forEach(input => {
        // Always keep these visible (admin PIN, search/filter dropdowns)
        if (input.id === 'adminPin') return;
        if (input.id && (input.id.includes('Search') || input.id.includes('Filter'))) return;
        if (input.id && input.id.toLowerCase().includes('search')) return;
        if (input.id && input.id.toLowerCase().includes('filter')) return;
        if (input.placeholder && input.placeholder.toLowerCase().includes('search')) return;

        // Hide inputs for non-admins, show for admins
        input.style.display = adminEnabled ? '' : 'none';
        input.disabled = !adminEnabled;
      });

      // Hide/show all buttons except view-only buttons
      document.querySelectorAll('button').forEach(btn => {
        // Skip admin enable/disable buttons
        if (btn.id === 'enableBtn' || btn.id === 'disableBtn') return;

        // Skip pagination buttons
        if (btn.id === 'showPrevBtn' || btn.id === 'showNextBtn') return;

        // Skip view/navigation buttons (check button text for view-only operations)
        const text = btn.textContent.toLowerCase();
        if (text.includes('view') || text.includes('go to') || text.includes('back to') ||
            text.includes('next') || text.includes('previous') || text.includes('load more')) return;

        // Hide buttons that modify data (create, save, upload, delete, edit, apply, add, update, remove, import)
        const isEditButton = text.includes('save') || text.includes('upload') ||
                            text.includes('create') || text.includes('add') ||
                            text.includes('delete') || text.includes('remove') ||
                            text.includes('apply') || text.includes('import') ||
                            text.includes('edit') || text.includes('update') ||
                            text.includes('‚úÖ') || text.includes('‚ûï') ||
                            text.includes('‚úì') || text.includes('‚úï') ||
                            btn.className.includes('danger');

        if (isEditButton) {
          btn.style.display = adminEnabled ? 'inline-block' : 'none';
        }
      });

      // Hide file upload inputs
      document.querySelectorAll('input[type="file"]').forEach(input => {
        input.style.display = adminEnabled ? 'block' : 'none';
        // Add "Read Only Mode" message if hidden
        if (!adminEnabled && !input.nextElementSibling?.classList.contains('read-only-notice')) {
          const notice = document.createElement('div');
          notice.className = 'read-only-notice muted';
          notice.style.padding = '12px';
          notice.style.background = '#1f2937';
          notice.style.borderRadius = '8px';
          notice.style.marginTop = '8px';
          notice.innerHTML = 'üîí Read-only mode. Enable admin access to import data.';
          input.parentNode.insertBefore(notice, input.nextSibling);
        } else if (adminEnabled) {
          // Remove read-only notices when admin enabled
          input.parentNode.querySelectorAll('.read-only-notice').forEach(n => n.remove());
        }
      });

      // Reload current tab to update button visibility
      try {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
          const tabName = activeTab.getAttribute('onclick').match(/showTab\('([^']+)'\)/)[1];
          if (tabName === 'master-catalog') loadMasterCatalog();
          else if (tabName === 'cogs-rules') loadCOGSRules();
          else if (tabName === 'marketplace') loadMarketplace();
          else if (tabName === 'inventory') loadInventory();
          else if (tabName === 'products') loadProducts();
          else if (tabName === 'singles') loadSingles();
          else if (tabName === 'analytics') loadAnalytics();
        }
      } catch (error) {
        console.error('Error reloading tab:', error);
      }
    }

    function authHeaders() {
      return adminKey ? { "Authorization": `Bearer ${adminKey}`, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
    }

    // Tab management
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Load data for active tab
      if (tabName === 'import') loadRecentImports();
      if (tabName === 'master-catalog') loadMasterCatalog();
      if (tabName === 'cogs-rules') loadCogsRules();
      if (tabName === 'shows') loadShows();
      if (tabName === 'marketplace') loadMarketplace();
      if (tabName === 'inventory') loadInventory();
      if (tabName === 'products') loadProducts();
      if (tabName === 'singles') loadSingles();
      if (tabName === 'buyers') loadBuyers();
      if (tabName === 'owners') loadOwners();
      if (tabName === 'analytics') loadAnalytics();
    }

    // Excel Import
    async function uploadExcel() {
      const fileInput = document.getElementById("excelFile");

      if (!fileInput.files[0]) {
        document.getElementById("importStatus").innerHTML = '<span class="warning">‚ö† Please select an Excel file</span>';
        return;
      }

      const fileName = fileInput.files[0].name;
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      // Show detailed progress
      const statusEl = document.getElementById("importStatus");
      const resultsEl = document.getElementById("importResults");

      statusEl.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="spinner"></div>
          <div>
            <div style="font-weight:600; margin-bottom:4px;">üì§ Importing ${fileName}...</div>
            <div class="muted" style="font-size:11px;">Parsing Excel ‚Üí Creating transactions ‚Üí Matching COGS rules</div>
          </div>
        </div>
      `;
      resultsEl.innerHTML = '';

      try {
        const startTime = Date.now();

        const res = await fetch(`${apiBase}/import/excel`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${adminKey}` },
          body: formData
        });

        const result = await res.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        if (res.ok) {
          const cogsPct = result.imported > 0 ? ((result.cogs_assigned_count / result.imported) * 100).toFixed(0) : 0;

          statusEl.innerHTML = `<div class="success" style="font-weight:600;">‚úÖ Import Complete (${elapsed}s)</div>`;

          resultsEl.innerHTML = `
            <div class="card" style="background:#111827; border:1px solid #22c55e;">
              <div style="font-weight:600; margin-bottom:12px; color:#22c55e;">üìä Import Summary</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">TRANSACTIONS</div>
                  <div style="font-size:20px; font-weight:600;">${result.imported}</div>
                  <div class="muted" style="font-size:11px;">from ${result.total_rows} rows</div>
                </div>
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">COGS COVERAGE</div>
                  <div style="font-size:20px; font-weight:600; color:${cogsPct >= 80 ? '#22c55e' : cogsPct >= 50 ? '#f59e0b' : '#ef4444'}">${cogsPct}%</div>
                  <div class="muted" style="font-size:11px;">${result.cogs_assigned_count} / ${result.imported} assigned</div>
                </div>
              </div>
              ${result.cogs_missing_count > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="warning">‚ö† ${result.cogs_missing_count} transactions need COGS rules</div>
                  <div class="muted" style="font-size:11px; margin-top:4px;">Go to Product Catalog to assign COGS</div>
                </div>
              ` : ''}
              ${result.errors.length > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="danger">‚ùå ${result.errors.length} errors:</div>
                  ${result.errors.map(e => `<div class="muted" style="font-size:11px;">‚Ä¢ ${e}</div>`).join('')}
                </div>
              ` : ''}
            </div>
          `;

          loadRecentImports();
          fileInput.value = '';
        } else {
          statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
          resultsEl.innerHTML = `
            <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
              <div class="danger">${result.detail || 'Unknown error'}</div>
            </div>
          `;
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
        resultsEl.innerHTML = `
          <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
            <div class="danger">${error.message}</div>
          </div>
        `;
      }
    }

    async function loadRecentImports() {
      const res = await fetch(`${apiBase}/shows?limit=5`, { headers: authHeaders() });
      const shows = await res.json();
      const container = document.getElementById("recentImports");
      container.innerHTML = shows.map(show => `
        <div class="card">
          <strong>${show.show_date}</strong> - ${show.show_name || 'Unnamed'}<br>
          <span class="muted">${show.item_count} items ‚Ä¢ $${parseFloat(show.total_gross_sales || 0).toFixed(2)}</span>
        </div>
      `).join('');
    }

    // COGS Rules
    async function loadCogsRules() {
      try {
        const res = await fetch(`${apiBase}/cogs-rules`, { headers: authHeaders() });
        const rules = await res.json();
        const container = document.getElementById("cogsRulesList");
        const countEl = document.getElementById("rulesCount");

        countEl.textContent = rules.length;

        if (rules.length === 0) {
          container.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">No COGS rules yet. Create one above to auto-assign costs!</div>';
          return;
        }

        // Sort by priority (descending)
        const sortedRules = rules.sort((a, b) => b.priority - a.priority);

        container.innerHTML = sortedRules.map(rule => `
          <div style="background:#0f172a; padding:16px; border-radius:8px; border:1px solid #1f2937; margin-bottom:12px;">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:12px; align-items:center;">
              <div>
                <strong style="font-size:15px;">${rule.rule_name}</strong>
                <div class="muted" style="font-size:12px; margin-top:4px;">Keywords: ${rule.keywords.join(', ')}</div>
                ${rule.category ? `<div class="muted" style="font-size:11px;">Category: ${rule.category}</div>` : ''}
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">COGS</div>
                <div style="font-weight:600; color:#22c55e; font-size:16px;">$${parseFloat(rule.cogs_amount).toFixed(2)}</div>
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">Priority</div>
                <div style="font-weight:600;">${rule.priority}</div>
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px;">Match</div>
                <div style="font-size:12px;">${rule.match_type}</div>
              </div>
              <div style="display:flex; gap:6px;">
                ${rule.is_active ?
                  '<button class="secondary" style="font-size:12px; padding:6px 10px;" onclick="toggleRuleStatus(' + rule.id + ', false)">üîá Disable</button>' :
                  '<button style="font-size:12px; padding:6px 10px;" onclick="toggleRuleStatus(' + rule.id + ', true)">üîä Enable</button>'}
                <button class="danger" style="font-size:12px; padding:6px 10px;" onclick="deleteCogsRule(${rule.id})">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading COGS rules:', error);
      }
    }

    async function createNewRule() {
      const name = document.getElementById('newRuleName').value.trim();
      const cogs = parseFloat(document.getElementById('newRuleCOGS').value);
      const priority = parseInt(document.getElementById('newRulePriority').value) || 100;
      const matchType = document.getElementById('newRuleMatchType').value;
      const keywordsStr = document.getElementById('newRuleKeywords').value.trim();
      const category = document.getElementById('newRuleCategory').value.trim();
      const notes = document.getElementById('newRuleNotes').value.trim();

      // Validation
      if (!name) {
        alert('Please enter a rule name');
        return;
      }
      if (!cogs || cogs <= 0) {
        alert('Please enter a valid COGS amount');
        return;
      }
      if (!keywordsStr) {
        alert('Please enter at least one keyword');
        return;
      }

      // Parse keywords (comma-separated)
      const keywords = keywordsStr.split(',').map(k => k.trim()).filter(k => k.length > 0);
      if (keywords.length === 0) {
        alert('Please enter at least one keyword');
        return;
      }

      const data = {
        rule_name: name,
        keywords: keywords,
        cogs_amount: cogs,
        match_type: matchType,
        priority: priority,
        is_active: true,
        category: category || null,
        notes: notes || null
      };

      try {
        const res = await fetch(`${apiBase}/cogs-rules`, {
          method: 'POST',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          // Clear form
          document.getElementById('newRuleName').value = '';
          document.getElementById('newRuleCOGS').value = '';
          document.getElementById('newRulePriority').value = '100';
          document.getElementById('newRuleKeywords').value = '';
          document.getElementById('newRuleCategory').value = '';
          document.getElementById('newRuleNotes').value = '';

          // Reload rules list
          await loadCogsRules();
          alert('‚úÖ COGS rule created successfully!');
        } else {
          const error = await res.json();
          alert(`Error creating rule: ${error.detail || 'Unknown error'}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    async function toggleRuleStatus(ruleId, newStatus) {
      try {
        const res = await fetch(`${apiBase}/cogs-rules/${ruleId}`, {
          method: 'PUT',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_active: newStatus })
        });

        if (res.ok) {
          await loadCogsRules();
        } else {
          alert('Error updating rule status');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    async function deleteCogsRule(ruleId) {
      if (!confirm('Are you sure you want to delete this COGS rule?')) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/cogs-rules/${ruleId}`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (res.ok || res.status === 204) {
          await loadCogsRules();
          alert('‚úÖ Rule deleted successfully');
        } else {
          alert('Error deleting rule');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    function openNewRuleModal() {
      editingRuleId = null;
      currentKeywords = [];
      document.getElementById("ruleModalTitle").textContent = "New COGS Rule";
      document.getElementById("ruleName").value = "";
      document.getElementById("cogsAmount").value = "";
      document.getElementById("priority").value = "50";
      document.getElementById("matchType").value = "contains";
      document.getElementById("category").value = "";
      document.getElementById("notes").value = "";
      updateKeywordTags();
      document.getElementById("cogsRuleModal").classList.add("active");
    }

    function closeRuleModal() {
      document.getElementById("cogsRuleModal").classList.remove("active");
      document.getElementById("ruleTestResults").innerHTML = "";
    }

    function handleKeywordEnter(event) {
      if (event.key === 'Enter' && event.target.value.trim()) {
        currentKeywords.push(event.target.value.trim());
        event.target.value = '';
        updateKeywordTags();
        event.preventDefault();
      }
    }

    function removeKeyword(index) {
      currentKeywords.splice(index, 1);
      updateKeywordTags();
    }

    function updateKeywordTags() {
      const container = document.getElementById("keywordTags");
      const input = document.getElementById("keywordInput");
      container.innerHTML = currentKeywords.map((kw, i) =>
        `<span class="tag">${kw}<span class="remove" onclick="removeKeyword(${i})">√ó</span></span>`
      ).join('') + input.outerHTML;
    }

    async function saveRule() {
      const data = {
        rule_name: document.getElementById("ruleName").value,
        keywords: currentKeywords,
        cogs_amount: parseFloat(document.getElementById("cogsAmount").value),
        match_type: document.getElementById("matchType").value,
        priority: parseInt(document.getElementById("priority").value),
        category: document.getElementById("category").value || null,
        notes: document.getElementById("notes").value || null
      };

      if (!data.rule_name || currentKeywords.length === 0 || !data.cogs_amount) {
        alert("Name, keywords, and COGS amount are required");
        return;
      }

      const url = editingRuleId ? `${apiBase}/cogs-rules/${editingRuleId}` : `${apiBase}/cogs-rules`;
      const method = editingRuleId ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: authHeaders(),
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeRuleModal();
        loadCogsRules();
      } else {
        alert("Error saving rule");
      }
    }

    async function testRule() {
      const data = {
        rule_name: "Test",
        keywords: currentKeywords,
        cogs_amount: parseFloat(document.getElementById("cogsAmount").value) || 0,
        match_type: document.getElementById("matchType").value,
        priority: 50
      };

      const res = await fetch(`${apiBase}/cogs-rules/test`, {
        method: "POST",
        headers: authHeaders(),
        body: JSON.stringify(data)
      });

      const result = await res.json();
      document.getElementById("ruleTestResults").innerHTML = result.matches.length > 0
        ? `<div class="success">‚úì Would match ${result.match_count} products:</div><div class="muted">${result.matches.slice(0,5).join(', ')}${result.matches.length > 5 ? '...' : ''}</div>`
        : '<div class="warning">‚ö† No matches found</div>';
    }

    async function toggleRule(id) {
      await fetch(`${apiBase}/cogs-rules/${id}/toggle`, {
        method: "POST",
        headers: authHeaders()
      });
      loadCogsRules();
    }

    async function deleteRule(id) {
      if (!confirm("Delete this COGS rule?")) return;
      await fetch(`${apiBase}/cogs-rules/${id}`, {
        method: "DELETE",
        headers: authHeaders()
      });
      loadCogsRules();
    }

    // Shows
    async function loadShows() {
      try {
        const res = await fetch(`${apiBase}/shows?limit=100`, { headers: authHeaders() });
        const shows = await res.json();

        const tbody = document.getElementById("showsTableBody");
        const tfoot = document.getElementById("showsTableFooter");

        if (shows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" style="padding:20px; text-align:center;" class="muted">No shows imported yet. Go to Import tab to upload your first Excel file!</td></tr>';
          return;
        }

        // Calculate totals
        let totalRevenue = 0;
        let totalCommission = 0;
        let totalEarnings = 0;
        let totalCOGS = 0;
        let totalProfit = 0;
        let totalItems = 0;
        let totalBuyers = 0;
        let showsWithCOGS = 0;

        // Render table rows
        tbody.innerHTML = shows.map(show => {
          const revenue = parseFloat(show.total_gross_sales || 0);
          const commission = parseFloat(show.total_whatnot_commission || 0) + parseFloat(show.total_whatnot_fees || 0);
          const earnings = parseFloat(show.total_net_earnings || 0);
          const cogs = parseFloat(show.total_cogs || 0);
          const profit = parseFloat(show.total_net_profit || 0);
          const items = parseInt(show.item_count || 0);
          const buyers = parseInt(show.unique_buyers || 0);
          const avgOrder = buyers > 0 ? (revenue / buyers).toFixed(2) : '0.00';
          const roi = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          // Add to totals
          totalRevenue += revenue;
          totalCommission += commission;
          totalEarnings += earnings;
          totalCOGS += cogs;
          totalProfit += profit;
          totalItems += items;
          totalBuyers += buyers;
          if (cogs > 0) showsWithCOGS++;

          // Format date
          const date = new Date(show.show_date);
          const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

          // Determine profit color
          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          // Truncate show name if too long
          const showName = show.show_name.length > 50 ? show.show_name.substring(0, 47) + '...' : show.show_name;

          return `
            <tr id="show-${show.id}" style="border-bottom:1px solid #1f2937; transition:background 0.2s; cursor:pointer;"
                onclick="viewShowDetail(${show.id})"
                onmouseover="this.style.background='#111827'"
                onmouseout="this.style.background='transparent'">
              <td style="padding:12px 8px; white-space:nowrap;">${dateStr}</td>
              <td style="padding:12px 8px;">
                <div style="font-weight:500;">${showName}</div>
              </td>
              <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${commission.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${cogs > 0 ? cogs.toFixed(2) : '-'}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${roi}${roi !== 'N/A' ? '%' : ''}</td>
              <td style="padding:12px 8px; text-align:center;" class="muted">${items}</td>
              <td style="padding:12px 8px; text-align:center;" class="muted">${buyers}</td>
              <td style="padding:12px 8px; text-align:right;" class="muted">$${avgOrder}</td>
            </tr>
          `;
        }).join('');

        // Add totals footer
        const avgROI = totalCOGS > 0 ? ((totalProfit / totalCOGS) * 100).toFixed(1) : 'N/A';
        const avgOrderTotal = totalBuyers > 0 ? (totalRevenue / totalBuyers).toFixed(2) : '0.00';

        tfoot.innerHTML = `
          <tr>
            <td style="padding:12px 8px;" colspan="2"><strong>TOTALS (${shows.length} shows)</strong></td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalRevenue.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCommission.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalEarnings.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCOGS.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${totalProfit > 0 ? '#22c55e' : '#ef4444'};">$${totalProfit.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${avgROI !== 'N/A' ? '#22c55e' : '#94a3b8'};">${avgROI}${avgROI !== 'N/A' ? '%' : ''}</td>
            <td style="padding:12px 8px; text-align:center;">${totalItems}</td>
            <td style="padding:12px 8px; text-align:center;">${totalBuyers}</td>
            <td style="padding:12px 8px; text-align:right;">$${avgOrderTotal}</td>
          </tr>
        `;

        // Update summary stats
        document.getElementById('totalShowsCount').textContent = shows.length;
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(0)}`;
        document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(0)}`;
        document.getElementById('avgROI').textContent = avgROI !== 'N/A' ? `${avgROI}%` : 'N/A';

      } catch (error) {
        document.getElementById("showsTableBody").innerHTML = `
          <tr><td colspan="11" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading shows: ${error.message}</td></tr>
        `;
      }
    }

    // Show Detail View Functions
    let currentShowTransactions = [];
    let currentShowId = null;

    let currentShowPage = 1;
    const showTransactionsPerPage = 100;

    async function viewShowDetail(showId, page = 1) {
      try {
        // Store current show ID for owner assignment
        currentShowId = showId;
        currentShowPage = page;

        // Fetch show details
        const showRes = await fetch(`${apiBase}/shows/${showId}`, { headers: authHeaders() });
        const show = await showRes.json();

        // Fetch ALL transactions for this show to get total count
        const allTransRes = await fetch(`${apiBase}/transactions?show_id=${showId}&limit=10000`, { headers: authHeaders() });
        const allTransactions = await allTransRes.json();
        currentShowTransactions = allTransactions;

        // Calculate pagination
        const totalTransactions = allTransactions.length;
        const totalPages = Math.ceil(totalTransactions / showTransactionsPerPage);
        const startIdx = (page - 1) * showTransactionsPerPage;
        const endIdx = startIdx + showTransactionsPerPage;
        const transactions = allTransactions.slice(startIdx, endIdx);

        // Update header
        const date = new Date(show.show_date);
        const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        document.getElementById('showDetailTitle').textContent = `üé¨ ${show.show_name}`;
        document.getElementById('showDetailMeta').textContent = `${dateStr} ‚Ä¢ ${totalTransactions} transactions (Page ${page} of ${totalPages})`;

        // Update summary stats
        const revenue = parseFloat(show.total_gross_sales || 0);
        const cogs = parseFloat(show.total_cogs || 0);
        const profit = parseFloat(show.total_net_profit || 0);
        document.getElementById('detailTotalItems').textContent = show.item_count || 0;
        document.getElementById('detailRevenue').textContent = `$${revenue.toFixed(2)}`;
        document.getElementById('detailCOGS').textContent = `$${cogs.toFixed(2)}`;
        document.getElementById('detailProfit').textContent = `$${profit.toFixed(2)}`;

        // Render transactions table
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = transactions.map((t, index) => {
          const revenue = parseFloat(t.total_revenue || t.gross_sale_price || 0);
          const earnings = parseFloat(t.net_earnings || 0);
          const cogs = parseFloat(t.cogs || 0);
          const profit = earnings - cogs;
          const roi = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          return `
            <tr id="transaction-${t.id}" style="border-bottom:1px solid #1f2937;">
              <td style="padding:12px 8px;">
                <div style="font-weight:500; max-width:300px;">${t.item_name}</div>
              </td>
              <td style="padding:12px 8px; text-align:center;">${t.quantity || 1}</td>
              <td style="padding:12px 8px;">@${t.buyer_username}</td>
              <td style="padding:12px 8px; text-align:right;">$${revenue.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; color:#22c55e;">$${earnings.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;">
                ${adminEnabled ? `
                  <input type="number"
                         step="0.01"
                         value="${cogs.toFixed(2)}"
                         data-transaction-id="${t.id}"
                         data-index="${index}"
                         onchange="updateTransactionCalc(${index})"
                         style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px;" />
                ` : `
                  <div>${cogs > 0 ? '$' + cogs.toFixed(2) : '-'}</div>
                `}
              </td>
              <td id="profit-${index}" style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
              <td id="roi-${index}" style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${roi}${roi !== 'N/A' ? '%' : ''}</td>
              <td style="padding:12px 8px;">
                ${adminEnabled ? `
                  <div style="display:flex; gap:4px; align-items:center;">
                    <select id="owner-show-${t.id}"
                            style="flex:1; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;">
                      <option value="" ${!t.owner ? 'selected' : ''}>Unassigned</option>
                      <option value="Cihan" ${t.owner === 'Cihan' ? 'selected' : ''}>Cihan</option>
                      <option value="Nima" ${t.owner === 'Nima' ? 'selected' : ''}>Nima</option>
                      <option value="Askar" ${t.owner === 'Askar' ? 'selected' : ''}>Askar</option>
                      <option value="Kanto" ${t.owner === 'Kanto' ? 'selected' : ''}>Kanto</option>
                    </select>
                    <button onclick="assignOwner(${t.id}, document.getElementById('owner-show-${t.id}').value)"
                            style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;">
                      Apply
                    </button>
                  </div>
                ` : `
                  <div style="font-size:12px;">${t.owner || 'Unassigned'}</div>
                `}
              </td>
            </tr>
          `;
        }).join('');

        // Update pagination controls
        document.getElementById('showPageInfo').textContent = `Page ${page} of ${totalPages}`;
        document.getElementById('showPrevBtn').disabled = page === 1;
        document.getElementById('showNextBtn').disabled = page === totalPages;
        document.getElementById('showPrevBtn').style.opacity = page === 1 ? '0.5' : '1';
        document.getElementById('showNextBtn').style.opacity = page === totalPages ? '0.5' : '1';
        document.getElementById('showPrevBtn').style.cursor = page === 1 ? 'not-allowed' : 'pointer';
        document.getElementById('showNextBtn').style.cursor = page === totalPages ? 'not-allowed' : 'pointer';

        // Hide shows list, show detail view
        document.getElementById('shows-list-view').style.display = 'none';
        document.getElementById('show-detail-view').style.display = 'block';

      } catch (error) {
        alert(`Error loading show details: ${error.message}`);
      }
    }

    function previousShowPage() {
      if (currentShowPage > 1) {
        viewShowDetail(currentShowId, currentShowPage - 1);
      }
    }

    function nextShowPage() {
      const totalPages = Math.ceil(currentShowTransactions.length / showTransactionsPerPage);
      if (currentShowPage < totalPages) {
        viewShowDetail(currentShowId, currentShowPage + 1);
      }
    }

    function backToShowsList() {
      document.getElementById('show-detail-view').style.display = 'none';
      document.getElementById('shows-list-view').style.display = 'block';
      currentShowPage = 1; // Reset pagination
      loadShows(); // Refresh the shows list
    }

    function updateTransactionCalc(index) {
      const t = currentShowTransactions[index];
      const cogsInput = document.querySelector(`input[data-index="${index}"]`);
      const newCOGS = parseFloat(cogsInput.value) || 0;

      const earnings = parseFloat(t.net_earnings || 0);
      const profit = earnings - newCOGS;
      const roi = newCOGS > 0 ? ((profit / newCOGS) * 100).toFixed(1) : 'N/A';

      const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
      const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

      document.getElementById(`profit-${index}`).textContent = `$${profit.toFixed(2)}`;
      document.getElementById(`profit-${index}`).style.color = profitColor;
      document.getElementById(`roi-${index}`).textContent = `${roi}${roi !== 'N/A' ? '%' : ''}`;
      document.getElementById(`roi-${index}`).style.color = roiColor;
    }

    async function saveAllCOGS() {
      const saveBtn = document.getElementById('saveCOGSBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const updates = [];
        const inputs = document.querySelectorAll('input[data-transaction-id]');

        for (const input of inputs) {
          const transactionId = parseInt(input.getAttribute('data-transaction-id'));
          const newCOGS = parseFloat(input.value) || 0;
          const index = parseInt(input.getAttribute('data-index'));
          const t = currentShowTransactions[index];
          const oldCOGS = parseFloat(t.cogs || 0);

          // Only update if changed
          if (Math.abs(newCOGS - oldCOGS) > 0.001) {
            updates.push({ id: transactionId, cogs: newCOGS });
          }
        }

        if (updates.length === 0) {
          alert('No changes to save');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save All COGS Changes';
          return;
        }

        // Update each transaction
        let successCount = 0;
        for (const update of updates) {
          const res = await fetch(`${apiBase}/transactions/${update.id}`, {
            method: 'PUT',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cogs: update.cogs })
          });

          if (res.ok) {
            successCount++;
          }
        }

        alert(`‚úÖ Updated ${successCount} of ${updates.length} transactions`);

        // Reload the show detail to refresh totals
        const showId = currentShowTransactions[0].show_id;
        viewShowDetail(showId);

      } catch (error) {
        alert(`Error saving COGS: ${error.message}`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save All COGS Changes';
      }
    }

    // Products
    let currentProductsPage = 1;
    const productsPerPage = 50;

    async function loadProducts(page = 1) {
      currentProductsPage = page;
      const filter = document.getElementById("productFilter").value;
      const offset = (page - 1) * productsPerPage;
      let url = `${apiBase}/products?limit=${productsPerPage}&offset=${offset}`;
      if (filter === 'has_cogs') url += '&has_cogs=true';
      if (filter === 'missing_cogs') url += '&has_cogs=false';

      const res = await fetch(url, { headers: authHeaders() });
      const data = await res.json();
      const products = data.products;
      const total = data.total;

      const container = document.getElementById("productsList");
      container.innerHTML = products.map(p => `
        <div class="card" style="cursor:pointer;" onclick="showProductTransactions(${p.id}, '${p.product_name.replace(/'/g, "\\'")}')">
          <strong>${p.product_name}</strong><br>
          <div class="muted">Sold ${p.times_sold}x ‚Ä¢ Avg: $${parseFloat(p.avg_sale_price || 0).toFixed(2)}</div>
          <div>Total: <strong>$${parseFloat(p.total_gross_sales || 0).toFixed(2)}</strong></div>
          ${p.has_cogs ? '<div class="success">‚úÖ Has COGS</div>' : '<div class="warning">‚ö† Missing COGS</div>'}
          <div style="margin-top:8px; font-size:11px; color:#3b82f6;">üìã Click to view transactions</div>
        </div>
      `).join('');

      // Render pagination
      renderProductsPagination(total, page);
    }

    function renderProductsPagination(total, currentPage) {
      const totalPages = Math.ceil(total / productsPerPage);
      const container = document.getElementById("productsPagination");

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      if (currentPage > 1) {
        html += `<button onclick="loadProducts(${currentPage - 1})" style="padding:8px 12px; background:#334155; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer;">‚Üê Prev</button>`;
      }

      // Page numbers
      const maxPageButtons = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

      // Adjust start if we're near the end
      if (endPage - startPage < maxPageButtons - 1) {
        startPage = Math.max(1, endPage - maxPageButtons + 1);
      }

      // First page
      if (startPage > 1) {
        html += `<button onclick="loadProducts(1)" style="padding:8px 12px; background:#334155; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer;">1</button>`;
        if (startPage > 2) {
          html += `<span style="padding:8px; color:#94a3b8;">...</span>`;
        }
      }

      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        html += `<button onclick="loadProducts(${i})" style="padding:8px 12px; background:${isActive ? '#3b82f6' : '#334155'}; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer; font-weight:${isActive ? 'bold' : 'normal'};">${i}</button>`;
      }

      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += `<span style="padding:8px; color:#94a3b8;">...</span>`;
        }
        html += `<button onclick="loadProducts(${totalPages})" style="padding:8px 12px; background:#334155; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer;">${totalPages}</button>`;
      }

      // Next button
      if (currentPage < totalPages) {
        html += `<button onclick="loadProducts(${currentPage + 1})" style="padding:8px 12px; background:#334155; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer;">Next ‚Üí</button>`;
      }

      html += `<div style="padding:8px; color:#94a3b8; margin-left:12px;">Page ${currentPage} of ${totalPages} (${total} items)</div>`;

      container.innerHTML = html;
    }

    // Show transactions for a specific product
    async function showProductTransactions(productId, productName) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';

      modal.innerHTML = `
        <div style="background:#0f172a; border:1px solid #1f2937; border-radius:12px; max-width:1200px; width:100%; max-height:90vh; overflow:auto; padding:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#e2e8f0;">Transactions for: ${productName}</h3>
            <button onclick="this.closest('div').parentElement.parentElement.remove()"
                    style="background:#334155; color:#e2e8f0; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:14px;">
              ‚úï Close
            </button>
          </div>
          <div id="product-transactions-content">Loading...</div>
        </div>
      `;

      document.body.appendChild(modal);

      // Fetch transactions for this product
      try {
        const res = await fetch(`${apiBase}/transactions?product_id=${productId}&limit=500`, { headers: authHeaders() });
        const transactions = await res.json();

        const content = document.getElementById('product-transactions-content');

        if (transactions.length === 0) {
          content.innerHTML = '<div class="warning">No transactions found</div>';
          return;
        }

        // Group by show/marketplace
        const byShow = {};
        const marketplace = [];

        transactions.forEach(t => {
          if (t.sale_type === 'marketplace') {
            marketplace.push(t);
          } else if (t.show_id) {
            if (!byShow[t.show_id]) {
              byShow[t.show_id] = {
                show_name: t.show_name || `Show #${t.show_id}`,
                transactions: []
              };
            }
            byShow[t.show_id].transactions.push(t);
          }
        });

        let html = `
          <div style="margin-bottom:16px; padding:12px; background:#1f2937; border-radius:6px;">
            <strong>Total Transactions: ${transactions.length}</strong><br>
            ${Object.keys(byShow).length > 0 ? `Shows: ${Object.keys(byShow).length} ‚Ä¢ ` : ''}
            ${marketplace.length > 0 ? `Marketplace: ${marketplace.length}` : ''}
          </div>
        `;

        // Show by show
        Object.values(byShow).forEach(show => {
          html += `
            <div style="margin-bottom:20px;">
              <h4 style="color:#3b82f6; margin:8px 0;">${show.show_name} (${show.transactions.length} transactions)</h4>
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="border-bottom:1px solid #1f2937;">
                    <th style="text-align:left; padding:8px; color:#94a3b8;">Date</th>
                    <th style="text-align:left; padding:8px; color:#94a3b8;">Item Name</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Qty</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Price</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">COGS</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  ${show.transactions.map(t => {
                    const hasCogs = t.cogs && t.cogs > 0;
                    const cogsColor = hasCogs ? '#22c55e' : '#ef4444';
                    const profitColor = t.net_profit > 0 ? '#22c55e' : t.net_profit < 0 ? '#ef4444' : '#94a3b8';

                    return `
                      <tr style="border-bottom:1px solid #1f2937;">
                        <td style="padding:8px; color:#e2e8f0;">${new Date(t.transaction_date).toLocaleDateString()}</td>
                        <td style="padding:8px; color:#e2e8f0;">${t.item_name.length > 50 ? t.item_name.substring(0, 50) + '...' : t.item_name}</td>
                        <td style="padding:8px; text-align:right; color:#e2e8f0;">${t.quantity}</td>
                        <td style="padding:8px; text-align:right; color:#e2e8f0;">$${parseFloat(t.gross_sale_price).toFixed(2)}</td>
                        <td style="padding:8px; text-align:right; color:${cogsColor}; font-weight:600;">
                          ${hasCogs ? `$${parseFloat(t.cogs).toFixed(2)}` : '‚ùå Missing'}
                        </td>
                        <td style="padding:8px; text-align:right; color:${profitColor};">
                          ${t.net_profit ? `$${parseFloat(t.net_profit).toFixed(2)}` : '-'}
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        });

        // Marketplace orders
        if (marketplace.length > 0) {
          html += `
            <div style="margin-bottom:20px;">
              <h4 style="color:#8b5cf6; margin:8px 0;">üõí Marketplace Orders (${marketplace.length} transactions)</h4>
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="border-bottom:1px solid #1f2937;">
                    <th style="text-align:left; padding:8px; color:#94a3b8;">Date</th>
                    <th style="text-align:left; padding:8px; color:#94a3b8;">Item Name</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Qty</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Price</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">COGS</th>
                    <th style="text-align:right; padding:8px; color:#94a3b8;">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  ${marketplace.map(t => {
                    const hasCogs = t.cogs && t.cogs > 0;
                    const cogsColor = hasCogs ? '#22c55e' : '#ef4444';
                    const profitColor = t.net_profit > 0 ? '#22c55e' : t.net_profit < 0 ? '#ef4444' : '#94a3b8';

                    return `
                      <tr style="border-bottom:1px solid #1f2937;">
                        <td style="padding:8px; color:#e2e8f0;">${new Date(t.transaction_date).toLocaleDateString()}</td>
                        <td style="padding:8px; color:#e2e8f0;">${t.item_name.length > 50 ? t.item_name.substring(0, 50) + '...' : t.item_name}</td>
                        <td style="padding:8px; text-align:right; color:#e2e8f0;">${t.quantity}</td>
                        <td style="padding:8px; text-align:right; color:#e2e8f0;">$${parseFloat(t.gross_sale_price).toFixed(2)}</td>
                        <td style="padding:8px; text-align:right; color:${cogsColor}; font-weight:600;">
                          ${hasCogs ? `$${parseFloat(t.cogs).toFixed(2)}` : '‚ùå Missing'}
                        </td>
                        <td style="padding:8px; text-align:right; color:${profitColor};">
                          ${t.net_profit ? `$${parseFloat(t.net_profit).toFixed(2)}` : '-'}
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

        content.innerHTML = html;
      } catch (error) {
        document.getElementById('product-transactions-content').innerHTML = `<div class="danger">Error loading transactions: ${error.message}</div>`;
      }
    }

    // Singles
    let singlesData = [];
    let unmappedSinglesData = [];

    async function loadSingles() {
      // Show/hide add section based on admin status
      document.getElementById('addSingleSection').style.display = adminEnabled ? 'block' : 'none';

      // Load singles catalog items
      await loadSinglesGrid();
      // Load unmapped singles
      await loadUnmappedSingles();
    }

    async function loadSinglesGrid() {
      const grid = document.getElementById('singlesGrid');
      grid.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">Loading singles...</div>';

      try {
        const res = await fetch(`${apiBase}/singles`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load singles');
        const data = await res.json();
        singlesData = data.singles;

        // Update stats
        const totalCards = singlesData.length;
        const totalSales = singlesData.reduce((sum, s) => sum + s.sales, 0);
        const totalRevenue = singlesData.reduce((sum, s) => sum + s.revenue, 0);

        document.getElementById('singlesStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalCards}</div>
            <div class="stat-label">Single Cards</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalSales}</div>
            <div class="stat-label">Total Sales</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${totalRevenue.toFixed(2)}</div>
            <div class="stat-label">Total Revenue</div>
          </div>
        `;

        if (singlesData.length === 0) {
          grid.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">No single cards in catalog yet. Add cards from Master Catalog with category "Singles".</div>';
          return;
        }

        // Render grid
        grid.innerHTML = singlesData.map(s => `
          <div class="card" style="padding:16px;">
            <div style="display:flex; gap:12px;">
              <img src="${s.imageUrl || ''}"
                   style="width:80px; height:80px; border-radius:8px; object-fit:cover;"
                   onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23333%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3EüÉè%3C/text%3E%3C/svg%3E';" />
              <div style="flex:1; min-width:0;">
                <div style="font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${s.name}">${s.name}</div>
                <div class="muted" style="font-size:12px;">
                  <div>üìä ${s.sales} sales</div>
                  <div>üí∞ $${s.revenue.toFixed(2)} revenue</div>
                </div>
              </div>
            </div>
            ${s.sales > 0 ? `
              <button onclick="showSingleTransactions(${s.id}, '${s.name.replace(/'/g, "\\'")}')"
                      style="margin-top:12px; width:100%; padding:8px; background:#3b82f6; border:none; color:white; border-radius:6px; cursor:pointer; font-size:12px;">
                View ${s.sales} Transaction${s.sales > 1 ? 's' : ''}
              </button>
            ` : ''}
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading singles:', error);
        grid.innerHTML = `<div class="danger" style="padding:20px; text-align:center;">Error loading singles: ${error.message}</div>`;
      }
    }

    async function loadUnmappedSingles() {
      const tbody = document.getElementById('unmappedSinglesBody');
      tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;" class="muted">Loading...</td></tr>';

      try {
        const res = await fetch(`${apiBase}/singles/unmapped`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load unmapped singles');
        const data = await res.json();
        unmappedSinglesData = data.unmapped;

        document.getElementById('unmappedCount').textContent = data.total;

        if (data.unmapped.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;" class="success">‚úÖ All singles are mapped!</td></tr>';
          document.getElementById('unmappedSinglesSection').style.display = 'none';
          return;
        }

        document.getElementById('unmappedSinglesSection').style.display = 'block';

        // Build dropdown options from singlesData
        const cardOptions = singlesData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        tbody.innerHTML = data.unmapped.map(t => `
          <tr style="border-bottom:1px solid #1f2937;">
            <td style="padding:10px 8px; font-size:12px;">${t.date ? new Date(t.date).toLocaleDateString() : '-'}</td>
            <td style="padding:10px 8px; font-weight:500;">${t.itemName}</td>
            <td style="padding:10px 8px; font-size:12px; color:#94a3b8;">${t.showName || 'Marketplace'}</td>
            <td style="padding:10px 8px; text-align:right; font-weight:600; color:#22c55e;">$${t.price.toFixed(2)}</td>
            <td style="padding:10px 8px; font-size:12px;">@${t.buyer}</td>
            <td style="padding:10px 8px; text-align:center;">
              ${adminEnabled ? `
                <div style="display:flex; gap:4px; justify-content:center;">
                  <select id="remap-select-${t.id}" style="padding:4px 8px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:11px; max-width:150px;">
                    <option value="">Select card...</option>
                    ${cardOptions}
                  </select>
                  <button onclick="remapTransaction(${t.id})"
                          style="padding:4px 8px; background:#22c55e; border:none; color:#0f172a; border-radius:4px; cursor:pointer; font-size:11px; font-weight:600;">
                    Map
                  </button>
                </div>
              ` : '<span class="muted">Admin only</span>'}
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading unmapped singles:', error);
        tbody.innerHTML = `<tr><td colspan="6" style="padding:20px; text-align:center;" class="danger">Error: ${error.message}</td></tr>`;
      }
    }

    async function remapTransaction(transactionId) {
      const select = document.getElementById(`remap-select-${transactionId}`);
      const catalogId = select.value;

      if (!catalogId) {
        alert('Please select a card to map to');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/transactions/${transactionId}/remap-catalog`, {
          method: 'PUT',
          headers: authHeaders(),
          body: JSON.stringify({ catalog_id: parseInt(catalogId) })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || 'Failed to remap transaction');
        }

        // Reload both sections
        await loadSinglesGrid();
        await loadUnmappedSingles();
      } catch (error) {
        console.error('Error remapping transaction:', error);
        alert('Error: ' + error.message);
      }
    }

    async function showSingleTransactions(catalogId, cardName) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';

      modal.innerHTML = `
        <div style="background:#0f172a; border:1px solid #1f2937; border-radius:12px; max-width:900px; width:100%; max-height:90vh; overflow:auto; padding:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#e2e8f0;">üÉè ${cardName}</h3>
            <button onclick="this.closest('div').parentElement.parentElement.remove()"
                    style="background:#334155; color:#e2e8f0; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:14px;">
              ‚úï Close
            </button>
          </div>
          <div id="single-transactions-content">Loading...</div>
        </div>
      `;

      document.body.appendChild(modal);

      try {
        const res = await fetch(`${apiBase}/product-catalog/${catalogId}/transactions`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load transactions');
        const transactions = await res.json();

        const content = document.getElementById('single-transactions-content');

        if (transactions.length === 0) {
          content.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">No transactions found</div>';
          return;
        }

        content.innerHTML = `
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#1f2937; text-align:left;">
                <th style="padding:10px 8px;">Date</th>
                <th style="padding:10px 8px;">Buyer</th>
                <th style="padding:10px 8px; text-align:right;">Price</th>
                <th style="padding:10px 8px; text-align:right;">Earnings</th>
                <th style="padding:10px 8px;">Show</th>
              </tr>
            </thead>
            <tbody>
              ${transactions.map(t => `
                <tr style="border-bottom:1px solid #1f2937;">
                  <td style="padding:10px 8px;">${t.date ? new Date(t.date).toLocaleDateString() : '-'}</td>
                  <td style="padding:10px 8px;">@${t.buyer}</td>
                  <td style="padding:10px 8px; text-align:right; font-weight:600; color:#22c55e;">$${parseFloat(t.price || 0).toFixed(2)}</td>
                  <td style="padding:10px 8px; text-align:right;">$${parseFloat(t.earnings || 0).toFixed(2)}</td>
                  <td style="padding:10px 8px; color:#94a3b8;">${t.showName || 'Marketplace'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        document.getElementById('single-transactions-content').innerHTML = `<div class="danger">Error: ${error.message}</div>`;
      }
    }

    function filterSingles() {
      const search = document.getElementById('singlesSearch').value.toLowerCase();
      const grid = document.getElementById('singlesGrid');

      const filtered = singlesData.filter(s => s.name.toLowerCase().includes(search));

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="muted" style="padding:20px; text-align:center;">No matching cards found</div>';
        return;
      }

      grid.innerHTML = filtered.map(s => `
        <div class="card" style="padding:16px;">
          <div style="display:flex; gap:12px;">
            <img src="${s.imageUrl || ''}"
                 style="width:80px; height:80px; border-radius:8px; object-fit:cover;"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Crect fill=%22%23333%22 width=%2280%22 height=%2280%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3EüÉè%3C/text%3E%3C/svg%3E';" />
            <div style="flex:1; min-width:0;">
              <div style="font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${s.name}">${s.name}</div>
              <div class="muted" style="font-size:12px;">
                <div>üìä ${s.sales} sales</div>
                <div>üí∞ $${s.revenue.toFixed(2)} revenue</div>
              </div>
            </div>
          </div>
          ${s.sales > 0 ? `
            <button onclick="showSingleTransactions(${s.id}, '${s.name.replace(/'/g, "\\'")}')"
                    style="margin-top:12px; width:100%; padding:8px; background:#3b82f6; border:none; color:white; border-radius:6px; cursor:pointer; font-size:12px;">
              View ${s.sales} Transaction${s.sales > 1 ? 's' : ''}
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    async function addSingleCard() {
      const imageUrl = document.getElementById('newSingleImageUrl').value.trim();
      const msgDiv = document.getElementById('addSingleMessage');

      if (!imageUrl) {
        msgDiv.innerHTML = '<span class="warning">‚ö†Ô∏è Please enter an image URL</span>';
        return;
      }

      // Extract name from URL (same logic as Master Catalog)
      let extractedName = '';
      try {
        const urlParts = imageUrl.split('/');
        const fileName = urlParts[urlParts.length - 1];
        extractedName = decodeURIComponent(fileName)
          .replace(/\.(jpg|jpeg|png|gif|webp)$/i, '')
          .replace(/_/g, ' ')
          .replace(/-/g, ' ')
          .trim();
      } catch (e) {
        extractedName = 'New Single Card';
      }

      msgDiv.innerHTML = '<span class="muted">Adding card...</span>';

      try {
        const res = await fetch(`${apiBase}/product-catalog/add`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({
            name: extractedName,
            category: 'Singles',
            image_url: imageUrl,
            include_keywords: [extractedName],
            rule_type: 'include_any'
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || 'Failed to add card');
        }

        document.getElementById('newSingleImageUrl').value = '';
        msgDiv.innerHTML = '<span class="success">‚úÖ Card added successfully!</span>';
        await loadSinglesGrid();
        await loadUnmappedSingles();
      } catch (error) {
        msgDiv.innerHTML = `<span class="danger">‚ùå Error: ${error.message}</span>`;
      }
    }

    // Buyers
    async function loadBuyers(repeatOnly = false) {
      const url = `${apiBase}/buyers?limit=50${repeatOnly ? '&repeat_only=true' : ''}`;
      const res = await fetch(url, { headers: authHeaders() });
      const buyers = await res.json();
      const container = document.getElementById("buyersList");
      container.innerHTML = buyers.map(b => `
        <div class="card">
          <strong>@${b.username}</strong> ${b.is_repeat_buyer ? '‚≠ê' : ''}<br>
          <div class="muted">${b.total_purchases} purchases ‚Ä¢ Avg: $${parseFloat(b.avg_purchase_price || 0).toFixed(2)}</div>
          <div>Total Spent: <strong>$${parseFloat(b.total_spent || 0).toFixed(2)}</strong></div>
        </div>
      `).join('');
    }

    // Analytics
    async function loadAnalytics() {
      const res = await fetch(`${apiBase}/analytics/overview`, { headers: authHeaders() });
      const data = await res.json();
      const stats = document.getElementById("analyticsStats");

      const cogsPct = data.cogs_coverage.coverage_percent || 0;
      stats.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">$${parseFloat(data.total_gross_sales || 0).toFixed(2)}</div>
          <div class="stat-label">Gross Sales</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">$${parseFloat(data.total_net_earnings || 0).toFixed(2)}</div>
          <div class="stat-label">Net Earnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">$${parseFloat(data.total_profit || 0).toFixed(2)}</div>
          <div class="stat-label">Net Profit</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${cogsPct.toFixed(0)}%</div>
          <div class="stat-label">COGS Coverage</div>
        </div>
      `;

      const topProds = await fetch(`${apiBase}/analytics/top-products?limit=5`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("topProducts").innerHTML = topProds.map((p, i) =>
        `<div>${i+1}. ${p.product_name} - $${parseFloat(p.total_revenue || 0).toFixed(2)}</div>`
      ).join('');

      const topBuy = await fetch(`${apiBase}/analytics/top-buyers?limit=5`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("topBuyers").innerHTML = topBuy.map((b, i) =>
        `<div>${i+1}. @${b.username} - $${parseFloat(b.total_spent || 0).toFixed(2)} (${b.purchase_count} purchases)</div>`
      ).join('');

      const rulePref = await fetch(`${apiBase}/analytics/cogs-rule-performance`, { headers: authHeaders() }).then(r => r.json());
      document.getElementById("rulePerformance").innerHTML = rulePref.map(r =>
        `<div><strong>${r.rule_name}:</strong> ${r.matches} matches, $${parseFloat(r.total_cogs_assigned || 0).toFixed(2)} COGS assigned</div>`
      ).join('');
    }

    // Master Catalog (table format with editable COGS)
    let catalogProducts = [];

    // Track expanded catalog items
    let expandedCatalogItems = new Set();
    let catalogTransactions = {}; // Cache for matched transactions

    async function loadMasterCatalog() {
      const tbody = document.getElementById("catalogTableBody");

      try {
        const res = await fetch(`${apiBase}/product-catalog`, { headers: authHeaders() });

        if (!res.ok) {
          const error = await res.json();
          tbody.innerHTML = `<tr><td colspan="9" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading products: ${error.detail || res.statusText}</td></tr>`;
          console.error('Product catalog error:', error);
          return;
        }

        const data = await res.json();
        console.log('Product catalog loaded:', data);

        if (!data.products || data.products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="warning">‚ö† No products found</td></tr>';
          return;
        }

        catalogProducts = data.products;

        // Render catalog items
        const rows = [];

        for (const [index, p] of data.products.entries()) {
          const isExpanded = expandedCatalogItems.has(p.id);
          const hasMatches = p.sales > 0;

          // Main product row
          rows.push(`
            <tr style="border-bottom:1px solid #1f2937;" id="catalog-item-${p.id}">
              <td style="padding:12px 8px;">
                <img src="${p.imageUrl}"
                     style="width:60px; height:60px; border-radius:6px; object-fit:cover;"
                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23333%22 width=%2260%22 height=%2260%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2210%22%3E?%3C/text%3E%3C/svg%3E';"
                     loading="lazy" />
              </td>
              <td style="padding:12px 8px;">
                <div id="name-display-${p.id}" style="display:flex; align-items:center; gap:8px;">
                  <div style="font-weight:500;">${p.name}</div>
                  ${adminEnabled ? `
                    <button onclick="editProductName(${p.id})"
                            id="edit-name-btn-${p.id}"
                            style="padding:2px 6px; background:#3b82f6; color:white; border:none; border-radius:3px; cursor:pointer; font-size:10px; white-space:nowrap;"
                            title="Rename product">
                      ‚úèÔ∏è
                    </button>
                  ` : ''}
                </div>
                <div id="name-edit-${p.id}" style="display:none;">
                  <input type="text"
                         id="name-input-${p.id}"
                         value="${p.name.replace(/"/g, '&quot;')}"
                         style="width:100%; padding:6px 8px; background:#0f172a; border:1px solid #3b82f6; color:#e2e8f0; border-radius:4px; font-size:13px; margin-bottom:6px;" />
                  <div style="display:flex; gap:4px;">
                    <button onclick="applyProductName(${p.id})"
                            style="padding:4px 8px; background:#22c55e; color:white; border:none; border-radius:3px; cursor:pointer; font-size:11px;"
                            title="Apply name change">
                      ‚úì
                    </button>
                    <button onclick="cancelEditProductName(${p.id})"
                            style="padding:4px 8px; background:#334155; color:#e2e8f0; border:none; border-radius:3px; cursor:pointer; font-size:11px;"
                            title="Cancel">
                      ‚úï
                    </button>
                  </div>
                </div>
              </td>
              <td style="padding:12px 8px;">
                <div id="category-display-${p.id}" style="display:flex; align-items:center; gap:8px;">
                  <div class="muted" style="font-size:12px;">${p.category}</div>
                  ${adminEnabled ? `
                    <button onclick="editCategory(${p.id})"
                            id="edit-category-btn-${p.id}"
                            style="padding:2px 6px; background:#3b82f6; color:white; border:none; border-radius:3px; cursor:pointer; font-size:10px; white-space:nowrap;"
                            title="Edit category">
                      ‚úèÔ∏è
                    </button>
                  ` : ''}
                </div>
                <div id="category-edit-${p.id}" style="display:none;">
                  <input type="text"
                         id="category-input-${p.id}"
                         value="${p.category.replace(/"/g, '&quot;')}"
                         style="width:100%; padding:6px 8px; background:#0f172a; border:1px solid #3b82f6; color:#e2e8f0; border-radius:4px; font-size:13px; margin-bottom:6px;" />
                  <div style="display:flex; gap:4px;">
                    <button onclick="applyCategory(${p.id})"
                            style="padding:4px 8px; background:#22c55e; color:white; border:none; border-radius:3px; cursor:pointer; font-size:11px;"
                            title="Apply category change">
                      ‚úì
                    </button>
                    <button onclick="cancelEditCategory(${p.id})"
                            style="padding:4px 8px; background:#334155; color:#e2e8f0; border:none; border-radius:3px; cursor:pointer; font-size:11px;"
                            title="Cancel">
                      ‚úï
                    </button>
                  </div>
                </div>
              </td>
              <td style="padding:12px 8px; text-align:center;">
                ${hasMatches ? `
                  <div onclick="toggleCatalogMatches(${p.id})" style="cursor:pointer; color:#3b82f6; font-weight:600;">
                    ${isExpanded ? '‚ñº' : '‚ñ∂'} ${p.sales}
                  </div>
                ` : `<div class="muted">0</div>`}
              </td>
              <td style="padding:12px 8px; text-align:right; font-weight:600;">
                $${parseFloat(p.revenue || 0).toFixed(2)}
              </td>
              ${adminEnabled ? `
              <td class="keywords-column" style="padding:12px 8px;">
                <div id="keywords-display-${p.id}" style="display:flex; align-items:center; gap:8px;">
                  <div style="font-size:11px; color:#64748b; max-width:250px; overflow:hidden; text-overflow:ellipsis;">
                    <div style="margin-bottom:4px;">
                      <span style="color:#94a3b8; font-weight:600;">${getRuleTypeLabel(p.ruleType)}</span>
                    </div>
                    <div style="color:#22c55e;">Include: ${p.includeKeywords && p.includeKeywords.length > 0 ? p.includeKeywords.join(', ') : '(none)'}</div>
                    ${p.excludeKeywords && p.excludeKeywords.length > 0 ? `<div style="color:#ef4444;">Exclude: ${p.excludeKeywords.join(', ')}</div>` : ''}
                  </div>
                  <button onclick="editKeywords(${p.id})"
                          id="edit-keywords-btn-${p.id}"
                          style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;"
                          title="Edit rule-based keywords">
                    ‚úèÔ∏è Edit
                  </button>
                </div>
                <div id="keywords-edit-${p.id}" style="display:none;">
                  <div style="margin-bottom:8px;">
                    <label style="display:block; font-size:11px; color:#94a3b8; margin-bottom:4px;">Rule Type:</label>
                    <select id="rule-type-${p.id}"
                            style="width:100%; padding:6px 8px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;">
                      <option value="include_any" ${p.ruleType === 'include_any' ? 'selected' : ''}>INCLUDE ANY - Contains at least one keyword</option>
                      <option value="include_all" ${p.ruleType === 'include_all' ? 'selected' : ''}>INCLUDE ALL - Contains all keywords</option>
                      <option value="include_and_exclude" ${p.ruleType === 'include_and_exclude' ? 'selected' : ''}>INCLUDE + EXCLUDE - Contains include but not exclude</option>
                      <option value="catch_all" ${p.ruleType === 'catch_all' ? 'selected' : ''}>CATCH ALL - Catches unmatched items</option>
                    </select>
                  </div>
                  <div style="margin-bottom:8px;">
                    <label style="display:block; font-size:11px; color:#22c55e; margin-bottom:4px;">Include Keywords (comma-separated):</label>
                    <textarea id="include-keywords-${p.id}"
                              style="width:100%; min-height:50px; padding:8px; background:#0f172a; border:1px solid #22c55e; color:#e2e8f0; border-radius:4px; font-size:12px; resize:vertical;"
                              placeholder="keyword1, keyword2, keyword3"
                              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">${p.includeKeywords ? p.includeKeywords.join(', ') : ''}</textarea>
                  </div>
                  <div style="margin-bottom:8px;">
                    <label style="display:block; font-size:11px; color:#ef4444; margin-bottom:4px;">Exclude Keywords (comma-separated, optional):</label>
                    <textarea id="exclude-keywords-${p.id}"
                              style="width:100%; min-height:40px; padding:8px; background:#0f172a; border:1px solid #ef4444; color:#e2e8f0; border-radius:4px; font-size:12px; resize:vertical;"
                              placeholder="keyword to exclude, another exclude"
                              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">${p.excludeKeywords ? p.excludeKeywords.join(', ') : ''}</textarea>
                  </div>
                  <div style="margin-bottom:8px;">
                    <label style="display:block; font-size:11px; color:#94a3b8; margin-bottom:4px;">Priority (higher = checked first):</label>
                    <input type="number"
                           id="priority-${p.id}"
                           value="${p.priority || 100}"
                           style="width:100px; padding:6px 8px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;" />
                  </div>
                  <div style="display:flex; gap:8px; margin-top:8px;">
                    <button onclick="applyKeywords(${p.id})"
                            style="padding:6px 12px; background:#22c55e; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                            title="Apply rule changes">
                      ‚úì Apply
                    </button>
                    <button onclick="cancelEditKeywords(${p.id})"
                            style="padding:6px 12px; background:#334155; color:#e2e8f0; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                            title="Cancel editing">
                      ‚úï Cancel
                    </button>
                  </div>
                </div>
              </td>
              ` : ''}
              <td style="padding:12px 8px;">
                ${adminEnabled ? `
                  <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">
                    <input type="number"
                           step="0.01"
                           min="0"
                           value=""
                           placeholder="0.00"
                           id="cogs-input-${p.id}"
                           data-product-id="${p.id}"
                           data-product-name="${p.name.replace(/"/g, '&quot;')}"
                           data-keywords='${JSON.stringify(p.keywords)}'
                           style="width:80px; text-align:right; padding:6px 8px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:13px;" />
                    <button onclick="applyCatalogCOGS(${p.id})"
                            id="apply-cogs-btn-${p.id}"
                            style="padding:6px 12px; background:#22c55e; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; white-space:nowrap;"
                            title="Apply COGS to all ${p.sales} transactions">
                      Apply COGS
                    </button>
                  </div>
                ` : `
                  <div class="muted" style="text-align:right; font-size:12px;">Read-only</div>
                `}
              </td>
              <td class="catalog-owner-column" style="padding:12px 8px; display:${adminEnabled ? 'table-cell' : 'none'};">
                ${adminEnabled ? `
                  <div style="display:flex; align-items:center; gap:4px;">
                    <select id="catalog-owner-${p.id}"
                            style="flex:1; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;">
                      <option value="">Unassigned</option>
                      <option value="Cihan">Cihan</option>
                      <option value="Nima">Nima</option>
                      <option value="Askar">Askar</option>
                      <option value="Kanto">Kanto</option>
                    </select>
                    <button onclick="assignOwnerToCatalogItem(${p.id}, '${p.name.replace(/'/g, "\\'")}')"
                            style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;"
                            title="Assign owner to all ${p.sales} matched transactions">
                      Apply
                    </button>
                  </div>
                ` : `
                  <div class="muted" style="font-size:12px;">-</div>
                `}
              </td>
              <td style="padding:12px 8px; text-align:center;">
                ${adminEnabled ? `
                  <button onclick="deleteCatalogItem(${p.id}, '${p.name.replace(/'/g, "\\'")}')"
                          style="padding:6px 12px; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;"
                          title="Delete ${p.name}">
                    üóëÔ∏è
                  </button>
                ` : `
                  <div class="muted" style="font-size:12px;">-</div>
                `}
              </td>
            </tr>
          `);

          // Expanded matched transactions
          if (isExpanded && catalogTransactions[p.id]) {
            const matches = catalogTransactions[p.id];
            rows.push(`
              <tr style="background:#0f172a;">
                <td colspan="9" style="padding:16px 24px;">
                  <div style="font-size:13px; font-weight:600; margin-bottom:12px; color:#94a3b8;">
                    üìã ${matches.length} Matched Transactions
                  </div>
                  <div style="max-height:400px; overflow-y:auto;">
                    <table style="width:100%; font-size:12px; border-collapse:collapse;">
                      <thead>
                        <tr style="border-bottom:1px solid #334155;">
                          <th style="padding:8px; text-align:left; color:#94a3b8;">Date</th>
                          <th style="padding:8px; text-align:left; color:#94a3b8;">Item Name</th>
                          <th style="padding:8px; text-align:left; color:#94a3b8;">Show</th>
                          <th style="padding:8px; text-align:right; color:#94a3b8;">Price</th>
                          ${adminEnabled ? '<th style="padding:8px; text-align:left; color:#94a3b8;">Matched Keyword</th>' : ''}
                          ${adminEnabled ? '<th style="padding:8px; text-align:left; color:#94a3b8;">Owner</th>' : ''}
                          <th style="padding:8px; text-align:center; color:#94a3b8;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${matches.map(m => {
                          const date = new Date(m.transaction_date).toLocaleDateString();
                          const matchedKeyword = m.matchedKeyword || 'Unknown';
                          return `
                            <tr style="border-bottom:1px solid #1f2937;">
                              <td style="padding:8px; color:#94a3b8;">${date}</td>
                              <td style="padding:8px;">${m.item_name}</td>
                              <td style="padding:8px; color:#64748b;">${m.sale_type === 'marketplace' ? 'Marketplace' : (m.show_name || 'Show #' + m.show_id)}</td>
                              <td style="padding:8px; text-align:right; color:#22c55e;">$${parseFloat(m.gross_sale_price || 0).toFixed(2)}</td>
                              ${adminEnabled ? `<td style="padding:8px; font-size:11px; color:#f59e0b;">"${matchedKeyword}"</td>` : ''}
                              ${adminEnabled ? `
                              <td style="padding:8px;">
                                <div style="display:flex; align-items:center; gap:4px;">
                                  <select id="catalog-match-owner-${m.id}"
                                          style="padding:3px 4px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:11px;">
                                    <option value="" ${!m.owner ? 'selected' : ''}>Unassigned</option>
                                    <option value="Cihan" ${m.owner === 'Cihan' ? 'selected' : ''}>Cihan</option>
                                    <option value="Nima" ${m.owner === 'Nima' ? 'selected' : ''}>Nima</option>
                                    <option value="Askar" ${m.owner === 'Askar' ? 'selected' : ''}>Askar</option>
                                    <option value="Kanto" ${m.owner === 'Kanto' ? 'selected' : ''}>Kanto</option>
                                  </select>
                                  <button onclick="assignOwnerFromCatalog(${m.id}, ${p.id})"
                                          style="padding:3px 6px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px;">
                                    Apply
                                  </button>
                                </div>
                              </td>
                              ` : ''}
                              <td style="padding:8px; text-align:center;">
                                ${m.sale_type === 'marketplace'
                                  ? `<button onclick="navigateToMarketplace(${m.id})"
                                            style="padding:4px 8px; background:#8b5cf6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">
                                       Go to Marketplace ‚Üí
                                     </button>`
                                  : `<button onclick="navigateToShow(${m.show_id}, ${m.id})"
                                            style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">
                                       Go to Show ‚Üí
                                     </button>`
                                }
                              </td>
                            </tr>
                          `;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            `);
          }
        }

        tbody.innerHTML = rows.join('');

      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="9" style="padding:20px; text-align:center;" class="danger">‚ùå Error: ${error.message}</td></tr>`;
        console.error('Failed to load catalog:', error);
      }
    }

    // Toggle expanded view of matched transactions
    async function toggleCatalogMatches(productId) {
      if (expandedCatalogItems.has(productId)) {
        expandedCatalogItems.delete(productId);
      } else {
        expandedCatalogItems.add(productId);

        // Fetch matched transactions if not already cached
        if (!catalogTransactions[productId]) {
          await fetchCatalogMatches(productId);
        }
      }

      // Reload catalog to show/hide expanded section
      await loadMasterCatalog();
    }

    // Fetch transactions that match this catalog item
    async function fetchCatalogMatches(productId) {
      try {
        // Find the product
        const product = catalogProducts.find(p => p.id === productId);
        if (!product) return;

        // Fetch all transactions
        const res = await fetch(`${apiBase}/transactions?limit=10000`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to fetch transactions');

        const transactions = await res.json();

        // NEW RULE-BASED MATCHING LOGIC (matches backend)
        const matches = [];

        // Sort catalog items by priority (DESC) to match backend ordering
        const sortedCatalog = [...catalogProducts].sort((a, b) => (b.priority || 0) - (a.priority || 0));

        // Find CATCH_ALL item
        const catchAllItem = sortedCatalog.find(item => item.ruleType === 'catch_all');

        for (const t of transactions) {
          const itemNameLower = t.item_name.toLowerCase();
          let matchedItem = null;
          let matchedKeyword = null;

          // Try to match against catalog items (ordered by priority)
          for (const catalogItem of sortedCatalog) {
            // Skip CATCH_ALL items in this pass
            if (catalogItem.ruleType === 'catch_all') continue;

            let match = false;

            if (catalogItem.ruleType === 'include_all') {
              // Must contain ALL include keywords
              match = catalogItem.includeKeywords && catalogItem.includeKeywords.every(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              if (match) matchedKeyword = catalogItem.includeKeywords.join(' + ');

            } else if (catalogItem.ruleType === 'include_any') {
              // Must contain AT LEAST ONE include keyword
              const matchedKw = catalogItem.includeKeywords && catalogItem.includeKeywords.find(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              if (matchedKw) {
                match = true;
                matchedKeyword = matchedKw;
              }

            } else if (catalogItem.ruleType === 'include_and_exclude') {
              // Must have include keywords but NOT exclude keywords
              const hasInclude = catalogItem.includeKeywords && catalogItem.includeKeywords.some(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              const hasExclude = catalogItem.excludeKeywords && catalogItem.excludeKeywords.some(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              match = hasInclude && !hasExclude;
              if (match) {
                matchedKeyword = catalogItem.includeKeywords.find(
                  kw => itemNameLower.includes(kw.toLowerCase())
                );
              }
            }

            // If matched, assign to this catalog item and stop checking
            if (match) {
              matchedItem = catalogItem.id;
              break;
            }
          }

          // If no match found and we have a CATCH_ALL item, assign to it
          if (!matchedItem && catchAllItem) {
            matchedItem = catchAllItem.id;
            matchedKeyword = '(catch all)';
          }

          // Only include this transaction if it matched THIS product
          if (matchedItem === productId) {
            matches.push({
              ...t,
              matchedKeyword: matchedKeyword || '(unknown)'
            });
          }
        }

        catalogTransactions[productId] = matches;

      } catch (error) {
        console.error('Error fetching matches:', error);
        catalogTransactions[productId] = [];
      }
    }

    // Assign owner to all transactions matching a catalog item
    async function assignOwnerToCatalogItem(productId, productName) {
      const ownerSelect = document.getElementById(`catalog-owner-${productId}`);
      const owner = ownerSelect ? ownerSelect.value : '';

      if (!owner) {
        alert('Please select an owner first');
        return;
      }

      // Make sure we have the matched transactions
      if (!catalogTransactions[productId]) {
        await fetchCatalogMatches(productId);
      }

      const matches = catalogTransactions[productId] || [];

      if (matches.length === 0) {
        alert(`No matched transactions found for "${productName}"`);
        return;
      }

      if (!confirm(`Assign "${owner}" as owner to all ${matches.length} transactions matching "${productName}"?`)) {
        return;
      }

      try {
        let successCount = 0;
        let errorCount = 0;

        // Show progress - find button by its neighboring select element
        const selectEl = document.getElementById(`catalog-owner-${productId}`);
        const button = selectEl ? selectEl.nextElementSibling : null;
        const originalText = button ? button.textContent : 'Apply';
        if (button) {
          button.disabled = true;
          button.textContent = '...';
        }

        // Assign owner to each transaction
        for (const t of matches) {
          try {
            const res = await fetch(`${apiBase}/transactions/${t.id}/owner`, {
              method: 'PUT',
              headers: {
                ...authHeaders(),
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(owner),
            });

            if (res.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (e) {
            errorCount++;
          }

          // Update button with progress
          if (button) {
            button.textContent = `${successCount}/${matches.length}`;
          }
        }

        // Restore button
        if (button) {
          button.disabled = false;
          button.textContent = originalText;
        }

        // Clear cache so it reloads with new owner data
        delete catalogTransactions[productId];

        alert(`‚úÖ Assigned "${owner}" to ${successCount} transactions${errorCount > 0 ? ` (${errorCount} errors)` : ''}`);

        // Reload catalog to reflect changes
        await loadMasterCatalog();

      } catch (error) {
        console.error('Failed to assign owner to catalog item:', error);
        alert('Failed to assign owner: ' + error.message);
      }
    }

    // Assign owner to a single transaction from catalog expanded view
    async function assignOwnerFromCatalog(transactionId, catalogItemId) {
      const ownerSelect = document.getElementById(`catalog-match-owner-${transactionId}`);
      const owner = ownerSelect ? ownerSelect.value : '';

      try {
        const res = await fetch(`${apiBase}/transactions/${transactionId}/owner`, {
          method: 'PUT',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(owner || null),
        });

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(errorData.detail || 'Failed to assign owner');
        }

        // Update the cached transaction data
        if (catalogTransactions[catalogItemId]) {
          const txn = catalogTransactions[catalogItemId].find(t => t.id === transactionId);
          if (txn) {
            txn.owner = owner || null;
          }
        }

        // Brief visual feedback
        const button = ownerSelect.nextElementSibling;
        if (button) {
          const originalText = button.textContent;
          button.textContent = '‚úì';
          button.style.background = '#22c55e';
          setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '#3b82f6';
          }, 1000);
        }

      } catch (error) {
        console.error('Failed to assign owner:', error);
        alert('Failed to assign owner: ' + error.message);
      }
    }

    // Navigate to a specific show
    async function navigateToShow(showId, transactionId) {
      // Switch to Shows tab
      showTab('shows');

      // Wait for tab to render
      await new Promise(resolve => setTimeout(resolve, 100));

      // Open the show detail modal
      await viewShowDetail(showId);

      // Wait for modal to render
      await new Promise(resolve => setTimeout(resolve, 300));

      // Scroll to and highlight the specific transaction
      if (transactionId) {
        const transactionRow = document.getElementById(`transaction-${transactionId}`);
        if (transactionRow) {
          transactionRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
          transactionRow.style.background = '#134e4a';
          transactionRow.style.border = '2px solid #22c55e';
          setTimeout(() => {
            transactionRow.style.background = '';
            transactionRow.style.border = '';
          }, 2500);
        }
      }
    }

    // Navigate to marketplace for a specific transaction
    async function navigateToMarketplace(transactionId) {
      // Switch to Marketplace tab
      showTab('marketplace');

      // Wait for tab to render
      await new Promise(resolve => setTimeout(resolve, 100));

      // Scroll to and highlight the specific transaction
      if (transactionId) {
        const transactionRow = document.getElementById(`transaction-${transactionId}`);
        if (transactionRow) {
          transactionRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
          transactionRow.style.background = '#134e4a';
          transactionRow.style.border = '2px solid #22c55e';
          setTimeout(() => {
            transactionRow.style.background = '';
            transactionRow.style.border = '';
          }, 2500);
        }
      }
    }

    // Helper: Get rule type label
    function getRuleTypeLabel(ruleType) {
      const labels = {
        'include_any': 'ANY',
        'include_all': 'ALL',
        'include_and_exclude': 'INCLUDE+EXCLUDE',
        'catch_all': 'CATCH ALL'
      };
      return labels[ruleType] || 'ANY';
    }

    // Edit keywords for a catalog item
    function editKeywords(productId) {
      // Hide display, show edit
      document.getElementById(`keywords-display-${productId}`).style.display = 'none';
      document.getElementById(`keywords-edit-${productId}`).style.display = 'block';

      // Focus the first textarea
      document.getElementById(`include-keywords-${productId}`).focus();
    }

    // Cancel editing keywords
    function cancelEditKeywords(productId) {
      // Show display, hide edit
      document.getElementById(`keywords-display-${productId}`).style.display = 'flex';
      document.getElementById(`keywords-edit-${productId}`).style.display = 'none';

      // Reset fields to original values
      const product = catalogProducts.find(p => p.id === productId);
      if (product) {
        document.getElementById(`rule-type-${productId}`).value = product.ruleType || 'include_any';
        document.getElementById(`include-keywords-${productId}`).value = product.includeKeywords ? product.includeKeywords.join(', ') : '';
        document.getElementById(`exclude-keywords-${productId}`).value = product.excludeKeywords ? product.excludeKeywords.join(', ') : '';
        document.getElementById(`priority-${productId}`).value = product.priority || 100;
      }
    }

    // Apply keyword changes
    async function applyKeywords(productId) {
      try {
        // Get rule type
        let ruleType = document.getElementById(`rule-type-${productId}`).value;

        // Get include keywords
        const includeText = document.getElementById(`include-keywords-${productId}`).value.trim();
        const includeKeywords = includeText
          .split(',')
          .map(k => k.trim())
          .filter(k => k.length > 0);

        // Get exclude keywords
        const excludeText = document.getElementById(`exclude-keywords-${productId}`).value.trim();
        const excludeKeywords = excludeText
          .split(',')
          .map(k => k.trim())
          .filter(k => k.length > 0);

        // Get priority
        const priority = parseInt(document.getElementById(`priority-${productId}`).value) || 100;

        // AUTO-FIX: If user has exclude keywords but wrong rule type, force to include_and_exclude
        if (excludeKeywords.length > 0 && ruleType !== 'include_and_exclude' && ruleType !== 'catch_all') {
          console.warn(`Auto-changing rule type from ${ruleType} to include_and_exclude because exclude keywords are present`);
          ruleType = 'include_and_exclude';
        }

        // Validate: CATCH_ALL doesn't need keywords, others need at least include keywords
        if (ruleType !== 'catch_all' && includeKeywords.length === 0) {
          alert('Please enter at least one include keyword (or select CATCH ALL rule type)');
          return;
        }

        // Update via API
        const res = await fetch(`${apiBase}/product-catalog/${productId}`, {
          method: 'PATCH',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            rule_type: ruleType,
            include_keywords: includeKeywords,
            exclude_keywords: excludeKeywords,
            priority: priority,
            keywords: includeKeywords  // DEPRECATED: Keep for backward compatibility
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || 'Failed to update keywords');
        }

        // Success - reload catalog to show updated keywords
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error updating keywords: ${error.message}`);
        console.error('Error updating keywords:', error);
      }
    }

    // Edit product name for a catalog item
    function editProductName(productId) {
      // Hide display, show edit
      document.getElementById(`name-display-${productId}`).style.display = 'none';
      document.getElementById(`name-edit-${productId}`).style.display = 'block';

      // Focus the input
      document.getElementById(`name-input-${productId}`).focus();
      document.getElementById(`name-input-${productId}`).select();
    }

    // Cancel editing product name
    function cancelEditProductName(productId) {
      // Show display, hide edit
      document.getElementById(`name-display-${productId}`).style.display = 'flex';
      document.getElementById(`name-edit-${productId}`).style.display = 'none';

      // Reset field to original value
      const product = catalogProducts.find(p => p.id === productId);
      if (product) {
        document.getElementById(`name-input-${productId}`).value = product.name;
      }
    }

    // Apply product name change
    async function applyProductName(productId) {
      try {
        const newName = document.getElementById(`name-input-${productId}`).value.trim();

        if (!newName) {
          alert('Product name cannot be empty');
          return;
        }

        // Update via API
        const res = await fetch(`${apiBase}/product-catalog/${productId}`, {
          method: 'PATCH',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: newName
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || 'Failed to update product name');
        }

        // Success - reload catalog to show updated name
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error updating product name: ${error.message}`);
        console.error('Error updating product name:', error);
      }
    }

    // Edit category for a catalog item
    function editCategory(productId) {
      // Hide display, show edit
      document.getElementById(`category-display-${productId}`).style.display = 'none';
      document.getElementById(`category-edit-${productId}`).style.display = 'block';

      // Focus the input
      document.getElementById(`category-input-${productId}`).focus();
      document.getElementById(`category-input-${productId}`).select();
    }

    // Cancel editing category
    function cancelEditCategory(productId) {
      // Show display, hide edit
      document.getElementById(`category-display-${productId}`).style.display = 'flex';
      document.getElementById(`category-edit-${productId}`).style.display = 'none';

      // Reset field to original value
      const product = catalogProducts.find(p => p.id === productId);
      if (product) {
        document.getElementById(`category-input-${productId}`).value = product.category;
      }
    }

    // Apply category change
    async function applyCategory(productId) {
      try {
        const newCategory = document.getElementById(`category-input-${productId}`).value.trim();

        if (!newCategory) {
          alert('Category cannot be empty');
          return;
        }

        // Update via API
        const res = await fetch(`${apiBase}/product-catalog/${productId}`, {
          method: 'PATCH',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            category: newCategory
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || 'Failed to update category');
        }

        // Success - reload catalog to show updated category
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error updating category: ${error.message}`);
        console.error('Error updating category:', error);
      }
    }

    async function saveAllCatalogCOGS() {
      const saveBtn = document.getElementById('saveCatalogCOGSBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const inputs = document.querySelectorAll('input[data-product-id]');
        const updates = [];

        for (const input of inputs) {
          const cogs = parseFloat(input.value);
          if (cogs && cogs > 0) {
            const productId = input.getAttribute('data-product-id');
            const productName = input.getAttribute('data-product-name');
            const keywords = JSON.parse(input.getAttribute('data-keywords'));

            updates.push({
              product_id: productId,
              product_name: productName,
              keywords: keywords,
              cogs: cogs
            });
          }
        }

        if (updates.length === 0) {
          alert('No COGS values entered. Enter at least one COGS value to save.');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save All COGS';
          return;
        }

        // Save each COGS value
        let successCount = 0;
        for (const update of updates) {
          const res = await fetch(`${apiBase}/product-catalog/save-cogs`, {
            method: 'POST',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(update)
          });

          if (res.ok) {
            successCount++;
          }
        }

        alert(`‚úÖ Successfully saved ${successCount} of ${updates.length} COGS values`);

        // Reload catalog
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error saving COGS: ${error.message}`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save All COGS';
      }
    }

    // Add new item to catalog
    async function addCatalogItem() {
      const urlInput = document.getElementById('newCatalogImageUrl');
      const messageEl = document.getElementById('addCatalogMessage');
      const imageUrl = urlInput.value.trim();

      if (!imageUrl) {
        messageEl.innerHTML = '<span class="warning">‚ö† Please paste an image URL</span>';
        return;
      }

      messageEl.innerHTML = '<span class="muted">Adding item...</span>';

      try {
        const res = await fetch(`${apiBase}/product-catalog/add`, {
          method: 'POST',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ image_url: imageUrl })
        });

        if (!res.ok) {
          const error = await res.json();

          // Check if it's a duplicate error (400 status)
          if (res.status === 400 && error.detail && error.detail.includes('Duplicate item')) {
            messageEl.innerHTML = `<span class="warning">‚ö†Ô∏è ${error.detail}</span>`;
            return;
          }

          throw new Error(error.detail || 'Failed to add item');
        }

        const item = await res.json();

        messageEl.innerHTML = `<span class="success">‚úÖ Added: ${item.name} (${item.category})</span>`;
        urlInput.value = '';

        // Reload catalog
        setTimeout(() => {
          loadMasterCatalog();
          messageEl.innerHTML = '';
        }, 2000);

      } catch (error) {
        messageEl.innerHTML = `<span class="warning">‚ùå Error: ${error.message}</span>`;
      }
    }

    // Delete item from catalog
    async function applyCatalogCOGS(catalogId) {
      const input = document.getElementById(`cogs-input-${catalogId}`);
      const applyBtn = document.getElementById(`apply-cogs-btn-${catalogId}`);
      const cogsValue = parseFloat(input.value);

      if (!cogsValue || cogsValue <= 0) {
        alert('Please enter a valid COGS amount');
        return;
      }

      const product = catalogProducts.find(p => p.id === catalogId);
      if (!product) {
        alert('Product not found');
        return;
      }

      if (!confirm(`Apply COGS of $${cogsValue.toFixed(2)} to all ${product.sales} "${product.name}" transactions?\n\nThis will:\n1. Create a COGS mapping rule\n2. Apply the cost to all matching transactions\n3. Lock this COGS field`)) {
        return;
      }

      // Disable button while processing
      applyBtn.disabled = true;
      applyBtn.textContent = 'Applying...';

      try {
        // Create COGS rule and apply to catalog item
        const res = await fetch(`${apiBase}/product-catalog/save-cogs`, {
          method: 'POST',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            product_id: catalogId,
            cogs: cogsValue,
            keywords: product.keywords,
            product_name: product.name
          })
        });

        if (!res.ok) {
          const error = await res.json();
          const errorMessage = error.detail || error.message || JSON.stringify(error);
          throw new Error(errorMessage);
        }

        const result = await res.json();

        // Lock the input field
        input.disabled = true;
        input.style.background = '#1e293b';
        input.style.border = '1px solid #475569';

        // Change button to "Edit"
        applyBtn.textContent = '‚úì Applied';
        applyBtn.style.background = '#475569';
        applyBtn.onclick = () => unlockCatalogCOGS(catalogId);
        applyBtn.title = 'Click to edit COGS';

        alert(`‚úÖ Success!\n\nCOGS rule created: ${result.message}\nApplied $${cogsValue.toFixed(2)} to ${product.sales} transactions`);

        // Reload catalog to show updated counts
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error applying COGS: ${error.message}`);
        applyBtn.disabled = false;
        applyBtn.textContent = 'Apply COGS';
      }
    }

    function unlockCatalogCOGS(catalogId) {
      const input = document.getElementById(`cogs-input-${catalogId}`);
      const applyBtn = document.getElementById(`apply-cogs-btn-${catalogId}`);

      // Unlock the input
      input.disabled = false;
      input.style.background = '#0f172a';
      input.style.border = '1px solid #334155';
      input.focus();

      // Change button back to "Apply COGS"
      applyBtn.textContent = 'Apply COGS';
      applyBtn.style.background = '#22c55e';
      applyBtn.onclick = () => applyCatalogCOGS(catalogId);
      applyBtn.title = `Apply COGS to all transactions`;
    }

    async function deleteCatalogItem(itemId, itemName) {
      if (!confirm(`Are you sure you want to delete "${itemName}" from the catalog?\n\nThis will only remove it from the Master Catalog. Existing COGS rules will not be affected.`)) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/product-catalog/${itemId}`, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (!res.ok) {
          throw new Error('Failed to delete item');
        }

        // Reload catalog
        await loadMasterCatalog();

      } catch (error) {
        alert(`Error deleting item: ${error.message}`);
      }
    }

    // Marketplace Import
    async function uploadMarketplace() {
      const fileInput = document.getElementById("marketplaceFile");

      if (!fileInput.files[0]) {
        document.getElementById("marketplaceImportStatus").innerHTML = '<span class="warning">‚ö† Please select an Excel file</span>';
        return;
      }

      const fileName = fileInput.files[0].name;
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const statusEl = document.getElementById("marketplaceImportStatus");
      const resultsEl = document.getElementById("marketplaceImportResults");

      statusEl.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="spinner"></div>
          <div>
            <div style="font-weight:600; margin-bottom:4px;">üì§ Importing ${fileName}...</div>
            <div class="muted" style="font-size:11px;">Parsing marketplace orders ‚Üí Matching COGS rules</div>
          </div>
        </div>
      `;
      resultsEl.innerHTML = '';

      try {
        const startTime = Date.now();

        const res = await fetch(`${apiBase}/import/marketplace`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${adminKey}` },
          body: formData
        });

        const result = await res.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        if (res.ok) {
          const cogsPct = result.imported > 0 ? ((result.cogs_assigned_count / result.imported) * 100).toFixed(0) : 0;

          statusEl.innerHTML = `<div class="success" style="font-weight:600;">‚úÖ Import Complete (${elapsed}s)</div>`;

          resultsEl.innerHTML = `
            <div class="card" style="background:#111827; border:1px solid #22c55e;">
              <div style="font-weight:600; margin-bottom:12px; color:#22c55e;">üìä Import Summary</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">MARKETPLACE ORDERS</div>
                  <div style="font-size:20px; font-weight:600;">${result.imported}</div>
                  <div class="muted" style="font-size:11px;">from ${result.total_rows} rows</div>
                </div>
                <div>
                  <div class="muted" style="font-size:11px; margin-bottom:4px;">COGS COVERAGE</div>
                  <div style="font-size:20px; font-weight:600; color:${cogsPct >= 80 ? '#22c55e' : cogsPct >= 50 ? '#f59e0b' : '#ef4444'}">${cogsPct}%</div>
                  <div class="muted" style="font-size:11px;">${result.cogs_assigned_count} / ${result.imported} assigned</div>
                </div>
              </div>
              ${result.cogs_missing_count > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="warning">‚ö† ${result.cogs_missing_count} orders need COGS rules</div>
                  <div class="muted" style="font-size:11px; margin-top:4px;">Go to COGS Rules or Product Catalog to assign COGS</div>
                </div>
              ` : ''}
              ${result.errors.length > 0 ? `
                <div style="margin-top:12px; padding:8px; background:#1f2937; border-radius:6px;">
                  <div class="danger">‚ùå ${result.errors.length} errors:</div>
                  ${result.errors.map(e => `<div class="muted" style="font-size:11px;">‚Ä¢ ${e}</div>`).join('')}
                </div>
              ` : ''}
            </div>
          `;

          loadMarketplace();
          fileInput.value = '';
        } else {
          statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
          resultsEl.innerHTML = `
            <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
              <div class="danger">${result.detail || 'Unknown error'}</div>
            </div>
          `;
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="danger" style="font-weight:600;">‚ùå Import Failed</div>`;
        resultsEl.innerHTML = `
          <div class="card" style="background:#1f2937; border:1px solid #ef4444;">
            <div class="danger">${error.message}</div>
          </div>
        `;
      }
    }

    let expandedMarketplaceRows = new Set();
    let currentMarketplaceOrders = [];

    async function loadMarketplace() {
      const tbody = document.getElementById("marketplaceTableBody");
      const tfoot = document.getElementById("marketplaceTableFooter");

      try {
        const res = await fetch(`${apiBase}/transactions?sale_type=marketplace&limit=500`, { headers: authHeaders() });
        const orders = await res.json();
        currentMarketplaceOrders = orders;

        if (orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="muted">No marketplace orders yet. Import your first Excel file above!</td></tr>';
          document.getElementById('saveMarketplaceCOGSBtn').style.display = 'none';
          return;
        }

        // Show save button if admin
        if (adminEnabled) {
          document.getElementById('saveMarketplaceCOGSBtn').style.display = 'inline-block';
        }

        // Group orders by product name
        const grouped = {};
        orders.forEach(order => {
          const key = order.item_name;
          if (!grouped[key]) {
            grouped[key] = [];
          }
          grouped[key].push(order);
        });

        // Calculate totals
        let totalOrders = orders.length;
        let totalRevenue = 0;
        let totalEarnings = 0;
        let totalCOGS = 0;
        let totalProfit = 0;

        // Render grouped rows
        const rows = [];
        let orderIndex = 0; // Global index for tracking individual orders

        Object.keys(grouped).sort().forEach((productName, groupIndex) => {
          const items = grouped[productName];
          const count = items.length;

          // Calculate aggregates for this product
          const revenue = items.reduce((sum, o) => sum + parseFloat(o.total_revenue || o.gross_sale_price || 0), 0);
          const earnings = items.reduce((sum, o) => sum + parseFloat(o.net_earnings || 0), 0);
          const cogs = items.reduce((sum, o) => sum + parseFloat(o.cogs || 0), 0);
          const profit = earnings - cogs;
          const avgPrice = revenue / count;
          const avgCOGS = cogs / count;
          const avgROI = cogs > 0 ? ((profit / cogs) * 100).toFixed(1) : 'N/A';

          // Add to totals
          totalRevenue += revenue;
          totalEarnings += earnings;
          totalCOGS += cogs;
          totalProfit += profit;

          // Determine colors
          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const roiColor = avgROI !== 'N/A' ? (parseFloat(avgROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

          const isExpanded = expandedMarketplaceRows.has(productName);
          const expandIcon = isExpanded ? '‚ñº' : '‚ñ∂';

          // Main row
          // For single items (count == 1), show editable COGS in the main row
          if (count === 1) {
            const singleOrder = items[0];
            const currentOrderIndex = orderIndex;
            orderIndex++;

            const singleCOGS = parseFloat(singleOrder.cogs || 0);
            const singleProfit = earnings - singleCOGS;
            const singleROI = singleCOGS > 0 ? ((singleProfit / singleCOGS) * 100).toFixed(1) : 'N/A';
            const singleProfitColor = singleProfit > 0 ? '#22c55e' : singleProfit < 0 ? '#ef4444' : '#94a3b8';
            const singleROIColor = singleROI !== 'N/A' ? (parseFloat(singleROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

            rows.push(`
              <tr style="border-bottom:1px solid #1f2937; transition:background 0.2s;">
                <td style="padding:12px 8px; text-align:center; color:#94a3b8;"></td>
                <td style="padding:12px 8px;">
                  <div style="font-weight:500;">${productName}</div>
                </td>
                <td style="padding:12px 8px; text-align:center; font-weight:600;">${count}</td>
                <td style="padding:12px 8px; text-align:right;">$${avgPrice.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right;">
                  ${adminEnabled ? `
                    <input type="number"
                           step="0.01"
                           value="${singleCOGS.toFixed(2)}"
                           data-transaction-id="${singleOrder.id}"
                           data-marketplace-index="${currentOrderIndex}"
                           onchange="updateMarketplaceCalc(${currentOrderIndex})"
                           style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:13px;" />
                  ` : `
                    <div style="font-size:13px;">${singleCOGS > 0 ? '$' + singleCOGS.toFixed(2) : '-'}</div>
                  `}
                </td>
                <td id="marketplace-profit-${currentOrderIndex}" style="padding:12px 8px; text-align:right; font-weight:600; color:${singleProfitColor};">$${singleProfit.toFixed(2)}</td>
                <td id="marketplace-roi-${currentOrderIndex}" style="padding:12px 8px; text-align:right; font-weight:600; color:${singleROIColor};">${singleROI}${singleROI !== 'N/A' ? '%' : ''}</td>
                <td style="padding:12px 8px;">
                  ${adminEnabled ? `
                    <div style="display:flex; gap:4px; align-items:center;">
                      <select id="owner-${singleOrder.id}"
                              style="flex:1; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;">
                        <option value="" ${!singleOrder.owner ? 'selected' : ''}>Unassigned</option>
                        <option value="Cihan" ${singleOrder.owner === 'Cihan' ? 'selected' : ''}>Cihan</option>
                        <option value="Nima" ${singleOrder.owner === 'Nima' ? 'selected' : ''}>Nima</option>
                        <option value="Askar" ${singleOrder.owner === 'Askar' ? 'selected' : ''}>Askar</option>
                        <option value="Kanto" ${singleOrder.owner === 'Kanto' ? 'selected' : ''}>Kanto</option>
                      </select>
                      <button onclick="assignOwner(${singleOrder.id}, document.getElementById('owner-${singleOrder.id}').value)"
                              style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;">
                        Apply
                      </button>
                    </div>
                  ` : `
                    <div style="font-size:12px;">${singleOrder.owner || 'Unassigned'}</div>
                  `}
                </td>
              </tr>
            `);
          } else {
            // Multiple items - show grouped row (clickable to expand)
            rows.push(`
              <tr style="border-bottom:1px solid #1f2937; cursor:pointer; transition:background 0.2s;"
                  onclick="toggleMarketplaceExpand('${productName.replace(/'/g, "\\'")}', this)"
                  onmouseover="this.style.background='#111827'"
                  onmouseout="this.style.background='transparent'">
                <td style="padding:12px 8px; text-align:center; color:#94a3b8;">
                  ${expandIcon}
                </td>
                <td style="padding:12px 8px;">
                  <div style="font-weight:500;">${productName}</div>
                  <div class="muted" style="font-size:11px; margin-top:2px;">${count} orders</div>
                </td>
                <td style="padding:12px 8px; text-align:center; font-weight:600;">${count}</td>
                <td style="padding:12px 8px; text-align:right;">$${avgPrice.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600;">$${revenue.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${earnings.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right;" class="muted">${cogs > 0 ? `$${avgCOGS.toFixed(2)}` : '-'}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:${profitColor};">$${profit.toFixed(2)}</td>
                <td style="padding:12px 8px; text-align:right; font-weight:600; color:${roiColor};">${avgROI}${avgROI !== 'N/A' ? '%' : ''}</td>
                <td style="padding:12px 8px;" class="muted">-</td>
              </tr>
            `);
          }

          // Expanded detail rows (only for count > 1)
          if (count > 1) {
            if (isExpanded) {
              items.forEach((order, i) => {
                const currentOrderIndex = orderIndex;
                orderIndex++;

                const orderRevenue = parseFloat(order.total_revenue || order.gross_sale_price || 0);
                const orderEarnings = parseFloat(order.net_earnings || 0);
                const orderCOGS = parseFloat(order.cogs || 0);
                const orderProfit = orderEarnings - orderCOGS;
                const orderROI = orderCOGS > 0 ? ((orderProfit / orderCOGS) * 100).toFixed(1) : 'N/A';
                const orderProfitColor = orderProfit > 0 ? '#22c55e' : orderProfit < 0 ? '#ef4444' : '#94a3b8';
                const orderROIColor = orderROI !== 'N/A' ? (parseFloat(orderROI) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

                const date = new Date(order.transaction_date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                rows.push(`
                  <tr class="marketplace-detail-row" style="background:#0f172a; border-bottom:1px solid #1f2937;">
                    <td style="padding:8px 8px 8px 32px;"></td>
                    <td style="padding:8px;" colspan="2">
                      <div style="font-size:12px;" class="muted">${dateStr} ‚Ä¢ @${order.buyer_username || 'Unknown'}</div>
                    </td>
                    <td style="padding:8px; text-align:right; font-size:12px;">$${orderRevenue.toFixed(2)}</td>
                    <td style="padding:8px; text-align:right; font-size:12px;">-</td>
                    <td style="padding:8px; text-align:right; font-size:12px; color:#22c55e;">$${orderEarnings.toFixed(2)}</td>
                    <td style="padding:8px; text-align:right;">
                      ${adminEnabled ? `
                        <input type="number"
                               step="0.01"
                               value="${orderCOGS.toFixed(2)}"
                               data-transaction-id="${order.id}"
                               data-marketplace-index="${currentOrderIndex}"
                               onchange="updateMarketplaceCalc(${currentOrderIndex})"
                               style="width:80px; text-align:right; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;" />
                      ` : `
                        <div style="font-size:12px;">${orderCOGS > 0 ? '$' + orderCOGS.toFixed(2) : '-'}</div>
                      `}
                    </td>
                    <td id="marketplace-profit-${currentOrderIndex}" style="padding:8px; text-align:right; font-size:12px; color:${orderProfitColor};">$${orderProfit.toFixed(2)}</td>
                    <td id="marketplace-roi-${currentOrderIndex}" style="padding:8px; text-align:right; font-size:12px; color:${orderROIColor};">${orderROI}${orderROI !== 'N/A' ? '%' : ''}</td>
                    <td style="padding:8px;">
                      ${adminEnabled ? `
                        <div style="display:flex; gap:4px; align-items:center;">
                          <select id="owner-detail-${order.id}"
                                  style="flex:1; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:11px;">
                            <option value="" ${!order.owner ? 'selected' : ''}>Unassigned</option>
                            <option value="Cihan" ${order.owner === 'Cihan' ? 'selected' : ''}>Cihan</option>
                            <option value="Nima" ${order.owner === 'Nima' ? 'selected' : ''}>Nima</option>
                            <option value="Askar" ${order.owner === 'Askar' ? 'selected' : ''}>Askar</option>
                            <option value="Kanto" ${order.owner === 'Kanto' ? 'selected' : ''}>Kanto</option>
                          </select>
                          <button onclick="assignOwner(${order.id}, document.getElementById('owner-detail-${order.id}').value)"
                                  style="padding:4px 6px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:10px; white-space:nowrap;">
                            Apply
                          </button>
                        </div>
                      ` : `
                        <div style="font-size:11px;">${order.owner || 'Unassigned'}</div>
                      `}
                    </td>
                  </tr>
                `);
              });
            } else {
              // Still increment orderIndex for items in collapsed groups
              orderIndex += items.length;
            }
          }
        });

        tbody.innerHTML = rows.join('');

        // Add totals footer
        const avgTotalROI = totalCOGS > 0 ? ((totalProfit / totalCOGS) * 100).toFixed(1) : 'N/A';

        tfoot.innerHTML = `
          <tr>
            <td style="padding:12px 8px;" colspan="2"><strong>TOTALS (${Object.keys(grouped).length} unique products, ${totalOrders} orders)</strong></td>
            <td style="padding:12px 8px; text-align:center; font-weight:600;">${totalOrders}</td>
            <td style="padding:12px 8px;"></td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalRevenue.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:#22c55e;">$${totalEarnings.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right;">$${totalCOGS.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${totalProfit > 0 ? '#22c55e' : '#ef4444'};">$${totalProfit.toFixed(2)}</td>
            <td style="padding:12px 8px; text-align:right; font-weight:600; color:${avgTotalROI !== 'N/A' ? '#22c55e' : '#94a3b8'};">${avgTotalROI}${avgTotalROI !== 'N/A' ? '%' : ''}</td>
            <td style="padding:12px 8px;"></td>
          </tr>
        `;

        // Update summary stats
        document.getElementById('marketplaceTotalOrders').textContent = totalOrders;
        document.getElementById('marketplaceRevenue').textContent = `$${totalRevenue.toFixed(0)}`;
        document.getElementById('marketplaceEarnings').textContent = `$${totalEarnings.toFixed(0)}`;
        document.getElementById('marketplaceProfit').textContent = `$${totalProfit.toFixed(0)}`;

      } catch (error) {
        tbody.innerHTML = `
          <tr><td colspan="9" style="padding:20px; text-align:center;" class="danger">‚ùå Error loading orders: ${error.message}</td></tr>
        `;
      }
    }

    function toggleMarketplaceExpand(productName, rowElement) {
      if (expandedMarketplaceRows.has(productName)) {
        expandedMarketplaceRows.delete(productName);
      } else {
        expandedMarketplaceRows.add(productName);
      }
      loadMarketplace();
    }

    function updateMarketplaceCalc(index) {
      const order = currentMarketplaceOrders[index];
      const cogsInput = document.querySelector(`input[data-marketplace-index="${index}"]`);
      const newCOGS = parseFloat(cogsInput.value) || 0;

      const earnings = parseFloat(order.net_earnings || 0);
      const profit = earnings - newCOGS;
      const roi = newCOGS > 0 ? ((profit / newCOGS) * 100).toFixed(1) : 'N/A';

      const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
      const roiColor = roi !== 'N/A' ? (parseFloat(roi) > 0 ? '#22c55e' : '#ef4444') : '#94a3b8';

      document.getElementById(`marketplace-profit-${index}`).textContent = `$${profit.toFixed(2)}`;
      document.getElementById(`marketplace-profit-${index}`).style.color = profitColor;
      document.getElementById(`marketplace-roi-${index}`).textContent = `${roi}${roi !== 'N/A' ? '%' : ''}`;
      document.getElementById(`marketplace-roi-${index}`).style.color = roiColor;
    }

    async function saveAllMarketplaceCOGS() {
      const saveBtn = document.getElementById('saveMarketplaceCOGSBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Saving...';

      try {
        const updates = [];
        const inputs = document.querySelectorAll('input[data-transaction-id]');

        for (const input of inputs) {
          const transactionId = parseInt(input.getAttribute('data-transaction-id'));
          const newCOGS = parseFloat(input.value) || 0;
          const index = parseInt(input.getAttribute('data-marketplace-index'));
          const order = currentMarketplaceOrders[index];
          const oldCOGS = parseFloat(order.cogs || 0);

          // Only update if changed
          if (Math.abs(newCOGS - oldCOGS) > 0.001) {
            updates.push({ id: transactionId, cogs: newCOGS });
          }
        }

        if (updates.length === 0) {
          alert('No changes to save');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save All COGS Changes';
          return;
        }

        // Update each transaction
        let successCount = 0;
        for (const update of updates) {
          const res = await fetch(`${apiBase}/transactions/${update.id}`, {
            method: 'PUT',
            headers: {
              ...authHeaders(),
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cogs: update.cogs })
          });

          if (res.ok) {
            successCount++;
          }
        }

        alert(`‚úÖ Updated ${successCount} of ${updates.length} marketplace orders`);

        // Reload marketplace to refresh totals
        await loadMarketplace();

      } catch (error) {
        alert(`Error saving COGS: ${error.message}`);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save All COGS Changes';
      }
    }

    // === OWNER MANAGEMENT FUNCTIONS ===

    async function loadOwners() {
      try {
        // Load catalog items for filter dropdown
        const catalogRes = await fetch(`${apiBase}/product-catalog`, { headers: authHeaders() });
        if (catalogRes.ok) {
          const catalogData = await catalogRes.json();
          const catalogFilter = document.getElementById('ownerCatalogFilter');
          if (catalogFilter && catalogData.products) {
            // Keep "All Items" and add catalog items
            catalogFilter.innerHTML = '<option value="all">All Items</option>' +
              catalogData.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
          }
        }

        // Load owner summary
        const summaryRes = await fetch(`${apiBase}/owners/summary`, { headers: authHeaders() });
        const summaryData = await summaryRes.json();

        const summaryEl = document.getElementById('ownersSummary');
        summaryEl.innerHTML = summaryData.owners.map(owner => {
          const profitColor = owner.total_profit > 0 ? '#22c55e' : owner.total_profit < 0 ? '#ef4444' : '#94a3b8';
          const iconMap = {
            'Cihan': 'üë§',
            'Nima': 'üë§',
            'Askar': 'üë§',
            'Kanto': 'üè™',
            'Unassigned': '‚ùì'
          };
          const icon = iconMap[owner.owner] || 'üë§';

          // Kanto has inventory stats
          const isKanto = owner.owner === 'Kanto';
          const invQty = owner.inventory_total_quantity || 0;
          const invValue = owner.inventory_total_value || 0;
          const invItems = owner.inventory_item_count || 0;

          return `
            <div class="card" style="padding:16px; cursor:pointer; transition:background 0.2s;"
                 onmouseover="this.style.background='#1f2937'"
                 onmouseout="this.style.background='#111827'"
                 onclick="filterByOwner('${owner.owner}')">
              <div style="font-size:24px; margin-bottom:8px;">${icon}</div>
              <div style="font-weight:600; font-size:16px; margin-bottom:8px;">${owner.owner}</div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span class="muted" style="font-size:12px;">Transactions:</span>
                <span style="font-weight:600;">${owner.transaction_count}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span class="muted" style="font-size:12px;">Revenue:</span>
                <span style="font-weight:600;">$${owner.total_revenue.toFixed(2)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span class="muted" style="font-size:12px;">Earnings:</span>
                <span style="font-weight:600; color:#22c55e;">$${owner.total_earnings.toFixed(2)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span class="muted" style="font-size:12px;">COGS:</span>
                <span style="font-weight:600;">$${owner.total_cogs.toFixed(2)}</span>
              </div>
              ${owner.total_cogs > 0 ? `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                  <span class="muted" style="font-size:12px;">Profit:</span>
                  <span style="font-weight:600; color:${profitColor};">$${owner.total_profit.toFixed(2)}</span>
                </div>
              ` : ''}
              ${isKanto ? `
                <div style="border-top:1px solid #334155; margin-top:8px; padding-top:8px;">
                  <div style="font-size:11px; color:#94a3b8; margin-bottom:4px;">üì¶ Inventory</div>
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                    <span class="muted" style="font-size:11px;">Items:</span>
                    <span style="font-weight:600; font-size:12px;">${invItems} (${invQty} qty)</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="muted" style="font-size:11px;">COGS:</span>
                    <span style="font-weight:600; font-size:12px; color:#3b82f6;">$${invValue.toFixed(2)}</span>
                  </div>
                </div>
                <div style="border-top:2px solid #22c55e; margin-top:8px; padding-top:8px;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; font-weight:600;">Total COGS:</span>
                    <span style="font-weight:700; font-size:14px; color:#f59e0b;">$${(owner.total_cogs + invValue).toFixed(2)}</span>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

        // Load transactions for selected owner filter
        loadOwnerTransactions();

      } catch (error) {
        console.error('Failed to load owners:', error);
        document.getElementById('ownersSummary').innerHTML = '<div class="danger">Failed to load owners data</div>';
      }
    }

    async function loadOwnerTransactions() {
      const filter = document.getElementById('ownerFilter').value;
      const catalogFilter = document.getElementById('ownerCatalogFilter').value;
      const tbody = document.getElementById('ownerTransactionsBody');

      // Show/hide Kanto inventory section based on filter
      const invSection = document.getElementById('kantoInventorySection');
      if (filter === 'Kanto') {
        invSection.style.display = 'block';
        loadKantoInventory();
      } else {
        invSection.style.display = 'none';
      }

      try {
        let transactions = [];

        if (filter === 'all') {
          // Load all owners and combine transactions
          const summaryRes = await fetch(`${apiBase}/owners/summary`, { headers: authHeaders() });
          if (!summaryRes.ok) throw new Error('Failed to load owners summary');
          const summaryData = await summaryRes.json();

          for (const owner of summaryData.owners) {
            const ownerName = owner.owner === 'Unassigned' ? 'Unassigned' : owner.owner;
            const res = await fetch(`${apiBase}/owners/${ownerName}/transactions?limit=1000`, { headers: authHeaders() });
            if (!res.ok) {
              console.error(`Failed to load ${ownerName} transactions:`, res.status);
              continue;
            }
            const data = await res.json();
            transactions.push(...data.transactions);
          }
        } else {
          const res = await fetch(`${apiBase}/owners/${filter}/transactions?limit=1000`, { headers: authHeaders() });
          if (!res.ok) throw new Error(`Failed to load transactions for ${filter}`);
          const data = await res.json();
          transactions = data.transactions;
        }

        // Filter by catalog item if selected
        if (catalogFilter !== 'all') {
          const catalogId = parseInt(catalogFilter);
          // Load catalog items to get matching rules
          const catalogRes = await fetch(`${apiBase}/product-catalog`, { headers: authHeaders() });
          if (catalogRes.ok) {
            const catalogData = await catalogRes.json();
            const selectedCatalog = catalogData.products.find(p => p.id === catalogId);

            if (selectedCatalog) {
              // Sort catalog by priority for proper matching
              const sortedCatalog = [...catalogData.products].sort((a, b) => (b.priority || 0) - (a.priority || 0));
              const catchAllItem = sortedCatalog.find(item => item.ruleType === 'catch_all');

              // Filter transactions that match this catalog item
              transactions = transactions.filter(t => {
                const itemNameLower = t.item_name.toLowerCase();
                let matchedItemId = null;

                // Try to match against catalog items (ordered by priority)
                for (const catalogItem of sortedCatalog) {
                  if (catalogItem.ruleType === 'catch_all') continue;

                  let match = false;

                  if (catalogItem.ruleType === 'include_all') {
                    match = catalogItem.includeKeywords && catalogItem.includeKeywords.every(
                      kw => itemNameLower.includes(kw.toLowerCase())
                    );
                  } else if (catalogItem.ruleType === 'include_any') {
                    match = catalogItem.includeKeywords && catalogItem.includeKeywords.some(
                      kw => itemNameLower.includes(kw.toLowerCase())
                    );
                  } else if (catalogItem.ruleType === 'include_and_exclude') {
                    const hasInclude = catalogItem.includeKeywords && catalogItem.includeKeywords.some(
                      kw => itemNameLower.includes(kw.toLowerCase())
                    );
                    const hasExclude = catalogItem.excludeKeywords && catalogItem.excludeKeywords.some(
                      kw => itemNameLower.includes(kw.toLowerCase())
                    );
                    match = hasInclude && !hasExclude;
                  }

                  if (match) {
                    matchedItemId = catalogItem.id;
                    break;
                  }
                }

                // If no match and there's a catch-all, use it
                if (!matchedItemId && catchAllItem) {
                  matchedItemId = catchAllItem.id;
                }

                return matchedItemId === catalogId;
              });
            }
          }
        }

        if (transactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="padding:20px; text-align:center;" class="muted">No transactions found</td></tr>';
          return;
        }

        // Sort by date descending
        transactions.sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date));

        // Load catalog for matching
        let catalogItems = [];
        let sortedCatalog = [];
        let catchAllItem = null;
        try {
          const catRes = await fetch(`${apiBase}/product-catalog`, { headers: authHeaders() });
          if (catRes.ok) {
            const catData = await catRes.json();
            catalogItems = catData.products || [];
            sortedCatalog = [...catalogItems].sort((a, b) => (b.priority || 0) - (a.priority || 0));
            catchAllItem = sortedCatalog.find(item => item.ruleType === 'catch_all');
          }
        } catch (e) {
          console.error('Failed to load catalog for matching:', e);
        }

        // Function to find matching catalog item for a transaction
        function findMatchingCatalog(itemName) {
          const itemNameLower = itemName.toLowerCase();
          for (const catalogItem of sortedCatalog) {
            if (catalogItem.ruleType === 'catch_all') continue;
            let match = false;
            if (catalogItem.ruleType === 'include_all') {
              match = catalogItem.includeKeywords && catalogItem.includeKeywords.every(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
            } else if (catalogItem.ruleType === 'include_any') {
              match = catalogItem.includeKeywords && catalogItem.includeKeywords.some(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
            } else if (catalogItem.ruleType === 'include_and_exclude') {
              const hasInclude = catalogItem.includeKeywords && catalogItem.includeKeywords.some(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              const hasExclude = catalogItem.excludeKeywords && catalogItem.excludeKeywords.some(
                kw => itemNameLower.includes(kw.toLowerCase())
              );
              match = hasInclude && !hasExclude;
            }
            if (match) return catalogItem;
          }
          return catchAllItem || null;
        }

        tbody.innerHTML = transactions.map(t => {
          const date = new Date(t.transaction_date).toLocaleDateString();
          const revenue = parseFloat(t.total_revenue || t.gross_sale_price || 0);
          const earnings = parseFloat(t.net_earnings || 0);
          const cogs = parseFloat(t.cogs || 0);
          const profit = cogs > 0 ? earnings - cogs : 0;
          const profitColor = profit > 0 ? '#22c55e' : profit < 0 ? '#ef4444' : '#94a3b8';
          const source = t.sale_type === 'marketplace' ? 'üõí Marketplace' : `üé¨ ${t.show_name || 'Show #' + t.show_id}`;
          const matchedCatalog = findMatchingCatalog(t.item_name);
          const catalogName = matchedCatalog ? matchedCatalog.name : '(Unmatched)';

          return `
            <tr style="border-bottom:1px solid #1f2937;">
              <td style="padding:12px 8px;">${date}</td>
              <td style="padding:12px 8px;">${t.item_name}</td>
              <td style="padding:12px 8px; color:#8b5cf6; font-size:11px;">${catalogName}</td>
              <td style="padding:12px 8px; color:#64748b; font-size:12px;">${source}</td>
              <td style="padding:12px 8px; text-align:right;">$${revenue.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right; color:#22c55e;">$${earnings.toFixed(2)}</td>
              <td style="padding:12px 8px; text-align:right;">${cogs > 0 ? '$' + cogs.toFixed(2) : '-'}</td>
              <td style="padding:12px 8px; text-align:right; color:${profitColor};">${profit !== 0 ? '$' + profit.toFixed(2) : '-'}</td>
              <td style="padding:12px 8px;">
                ${adminEnabled ? `
                  <div style="display:flex; gap:4px; align-items:center;">
                    <select id="owner-owners-${t.id}"
                            style="flex:1; padding:4px 6px; background:#0f172a; border:1px solid #334155; color:#e2e8f0; border-radius:4px; font-size:12px;">
                      <option value="" ${!t.owner ? 'selected' : ''}>Unassigned</option>
                      <option value="Cihan" ${t.owner === 'Cihan' ? 'selected' : ''}>Cihan</option>
                      <option value="Nima" ${t.owner === 'Nima' ? 'selected' : ''}>Nima</option>
                      <option value="Askar" ${t.owner === 'Askar' ? 'selected' : ''}>Askar</option>
                      <option value="Kanto" ${t.owner === 'Kanto' ? 'selected' : ''}>Kanto</option>
                    </select>
                    <button onclick="assignOwner(${t.id}, document.getElementById('owner-owners-${t.id}').value)"
                            style="padding:4px 8px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;">
                      Apply
                    </button>
                  </div>
                ` : `
                  <div style="font-size:12px;">${t.owner || 'Unassigned'}</div>
                `}
              </td>
              <td style="padding:12px 8px;">
                ${t.sale_type === 'marketplace' ? `
                  <button onclick="showTab('marketplace')"
                          style="padding:6px 12px; background:#22c55e; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;">
                    Go to Marketplace
                  </button>
                ` : t.show_id ? `
                  <button onclick="showTab('shows'); setTimeout(() => viewShowDetail(${t.show_id}), 100)"
                          style="padding:6px 12px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; white-space:nowrap;">
                    Go to Show
                  </button>
                ` : '-'}
              </td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Failed to load owner transactions:', error);
        tbody.innerHTML = '<tr><td colspan="10" style="padding:20px; text-align:center;" class="danger">Failed to load transactions</td></tr>';
      }
    }

    function filterByOwner(owner) {
      const filterEl = document.getElementById('ownerFilter');
      filterEl.value = owner;
      loadOwnerTransactions();

      // Show/hide Kanto inventory section
      const invSection = document.getElementById('kantoInventorySection');
      if (owner === 'Kanto') {
        invSection.style.display = 'block';
        loadKantoInventory();
      } else {
        invSection.style.display = 'none';
      }
    }

    async function loadKantoInventory() {
      const grid = document.getElementById('kantoInventoryGrid');
      grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;" class="muted">Loading inventory...</div>';

      try {
        // Load inventory items (all belong to Kanto by default)
        const res = await fetch(`${apiBase}/inventory?limit=500`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load inventory');
        let items = await res.json();

        // Only show items with quantity > 0
        items = items.filter(item => item.quantity > 0);

        // Sort by quantity descending
        items.sort((a, b) => b.quantity - a.quantity);

        if (items.length === 0) {
          grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;" class="muted">No items in stock</div>';
          return;
        }

        grid.innerHTML = items.map(item => {
          const imageUrl = item.catalog_image_url || item.image_url || '';
          const costPerUnit = parseFloat(item.cost_per_unit) || 0;
          const totalValue = costPerUnit * item.quantity;
          const qtyColor = item.quantity === 0 ? '#ef4444' : item.quantity <= 5 ? '#f59e0b' : '#22c55e';
          const escapedName = (item.item_name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

          return `
            <div style="background:#1e293b; border-radius:8px; overflow:hidden; border:1px solid #334155;">
              <!-- Image -->
              <div style="height:80px; background:#0f172a; display:flex; align-items:center; justify-content:center;">
                ${imageUrl
                  ? `<img src="${imageUrl}" alt="${escapedName}" style="max-width:100%; max-height:80px; object-fit:contain;" />`
                  : `<div style="color:#475569; font-size:24px;">üì¶</div>`
                }
              </div>
              <!-- Info -->
              <div style="padding:8px;">
                <div style="font-size:11px; font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${escapedName}">
                  ${escapedName}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                  <span style="font-size:10px; color:#94a3b8;">Qty:</span>
                  <span style="font-size:12px; font-weight:700; color:${qtyColor};">${item.quantity}</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                  <span style="font-size:10px; color:#94a3b8;">Cost/Unit:</span>
                  <div id="kanto-cost-display-${item.id}" onclick="${adminEnabled ? `startKantoCostEdit(${item.id}, ${costPerUnit})` : ''}" style="font-size:11px; font-weight:600; ${adminEnabled ? 'cursor:pointer; text-decoration:underline dotted;' : ''}">
                    $${costPerUnit.toFixed(2)}
                  </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #334155; padding-top:4px; margin-top:4px;">
                  <span style="font-size:10px; color:#94a3b8;">Total:</span>
                  <span style="font-size:11px; font-weight:600; color:#3b82f6;">$${totalValue.toFixed(2)}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load Kanto inventory:', error);
        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px;" class="danger">Failed to load inventory: ${error.message}</div>`;
      }
    }

    function startKantoCostEdit(itemId, currentCost) {
      if (!adminEnabled) return;

      const displayEl = document.getElementById(`kanto-cost-display-${itemId}`);
      displayEl.innerHTML = `
        <input type="number" id="kanto-cost-input-${itemId}" value="${currentCost}" step="0.01" min="0"
               style="width:50px; font-size:11px; padding:2px 4px; background:#0f172a; border:1px solid #3b82f6; color:white; border-radius:4px;"
               onkeydown="if(event.key==='Enter') applyKantoCostEdit(${itemId}); if(event.key==='Escape') loadKantoInventory();" />
        <button onclick="applyKantoCostEdit(${itemId})" style="font-size:10px; padding:2px 6px; background:#22c55e; border:none; color:white; border-radius:4px; cursor:pointer;">‚úì</button>
      `;
      document.getElementById(`kanto-cost-input-${itemId}`).focus();
    }

    async function applyKantoCostEdit(itemId) {
      const input = document.getElementById(`kanto-cost-input-${itemId}`);
      const newCost = parseFloat(input.value);

      if (isNaN(newCost) || newCost < 0) {
        alert('Please enter a valid cost (0 or greater)');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ cost_per_unit: newCost }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Failed to update cost');
        }

        // Reload Kanto inventory grid and refresh owner cards to show updated totals
        await loadKantoInventory();
        await loadOwners();
      } catch (error) {
        console.error('Failed to update cost:', error);
        alert('Failed to update: ' + error.message);
      }
    }

    async function assignOwner(transactionId, owner) {
      try {
        console.log('Assigning owner:', { transactionId, owner });

        const res = await fetch(`${apiBase}/transactions/${transactionId}/owner`, {
          method: 'PUT',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(owner || null),
        });

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(errorData.detail || 'Failed to assign owner');
        }

        const result = await res.json();
        console.log('Owner assigned successfully:', result);

        // Reload the current active tab to show updated owner
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
          const onclickAttr = activeTab.getAttribute('onclick');
          if (onclickAttr.includes('owners')) {
            loadOwners();
          } else if (onclickAttr.includes('marketplace')) {
            loadMarketplace();
          } else if (onclickAttr.includes('shows')) {
            // If we're in a show detail view, reload that show
            if (currentShowId) {
              viewShowDetail(currentShowId);
            } else {
              loadShows();
            }
          }
        }

      } catch (error) {
        console.error('Failed to assign owner:', error);
        alert('Failed to assign owner: ' + error.message);
      }
    }

    async function assignOwnerToShow() {
      const owner = document.getElementById('showOwnerSelect').value;
      if (!owner) {
        alert('Please select an owner');
        return;
      }

      if (!currentShowId) {
        alert('No show selected');
        return;
      }

      if (!confirm(`Assign all transactions in this show to ${owner}?`)) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/shows/${currentShowId}/owner`, {
          method: 'PUT',
          headers: {
            ...authHeaders(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(owner),
        });

        if (!res.ok) throw new Error('Failed to assign owner to show');

        const result = await res.json();
        alert(`‚úÖ Assigned ${result.transactions_updated} transactions to ${owner}`);

        // Reload show details
        viewShowDetail(currentShowId);

      } catch (error) {
        console.error('Failed to assign owner to show:', error);
        alert('Failed to assign owner to show: ' + error.message);
      }
    }

    // === INVENTORY FUNCTIONS ===

    async function loadInventory() {
      // Load stats
      loadInventoryStats();
      // Load catalog dropdown for admin
      if (adminEnabled) loadCatalogDropdown();

      const search = document.getElementById('inventorySearch')?.value || '';
      const status = document.getElementById('inventoryStatusFilter')?.value || '';
      const category = document.getElementById('inventoryCategoryFilter')?.value || '';

      let url = `${apiBase}/inventory?limit=200`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (status) url += `&status_filter=${status}`;
      if (category) url += `&category=${encodeURIComponent(category)}`;

      try {
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load inventory');
        const items = await res.json();
        // Sort by quantity descending (highest count first)
        items.sort((a, b) => b.quantity - a.quantity);
        renderInventoryGrid(items);
      } catch (error) {
        console.error('Failed to load inventory:', error);
        document.getElementById('inventoryGrid').innerHTML =
          '<div style="grid-column:1/-1; padding:40px; text-align:center;" class="danger">Failed to load inventory</div>';
      }
    }

    async function loadInventoryStats() {
      try {
        const res = await fetch(`${apiBase}/inventory/stats`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load stats');
        const stats = await res.json();

        document.getElementById('inventoryTotalItems').textContent = stats.total_items || 0;
        document.getElementById('inventoryTotalQty').textContent = stats.total_quantity || 0;
        document.getElementById('inventoryTotalValue').textContent = '$' + (stats.total_value || 0).toFixed(2);
        document.getElementById('inventoryLowStock').textContent = stats.out_of_stock || 0;
      } catch (error) {
        console.error('Failed to load inventory stats:', error);
      }
    }

    function renderInventoryGrid(items) {
      const grid = document.getElementById('inventoryGrid');

      if (!items || items.length === 0) {
        grid.innerHTML = `
          <div style="grid-column:1/-1; padding:40px; text-align:center;">
            <div class="muted" style="font-size:16px; margin-bottom:12px;">No inventory items yet</div>
            <div class="muted" style="font-size:13px;">Use "Add from Master Catalog" above to add items</div>
          </div>
        `;
        return;
      }

      grid.innerHTML = items.map(item => {
        const imageUrl = item.catalog_image_url || item.image_url || '';
        const qtyColor = item.quantity === 0 ? '#ef4444' : item.quantity <= 5 ? '#f59e0b' : '#22c55e';

        return `
          <div style="background:#1e293b; border-radius:12px; overflow:hidden; border:1px solid #334155; position:relative;">
            <!-- Remove Button (Admin Only) -->
            ${adminEnabled ? `
              <button onclick="removeInventoryItem(${item.id}, '${item.item_name.replace(/'/g, "\\'")}')"
                      style="position:absolute; top:8px; right:8px; width:28px; height:28px; border-radius:50%; background:rgba(239,68,68,0.9); border:none; color:white; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10;"
                      title="Remove from inventory">‚úï</button>
            ` : ''}
            <!-- Image -->
            <div style="height:140px; background:#0f172a; display:flex; align-items:center; justify-content:center;">
              ${imageUrl
                ? `<img src="${imageUrl}" alt="${item.item_name}" style="max-width:100%; max-height:140px; object-fit:contain;" />`
                : `<div style="color:#475569; font-size:40px;">üì¶</div>`
              }
            </div>
            <!-- Info -->
            <div style="padding:12px;">
              <div style="font-size:13px; font-weight:600; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${item.item_name}">
                ${item.item_name}
              </div>
              <div style="font-size:11px; color:#94a3b8; margin-bottom:12px;">
                ${item.catalog_category || item.category || 'Uncategorized'}
              </div>
              <!-- Quantity Display -->
              <div id="qty-container-${item.id}" style="display:flex; align-items:center; justify-content:center; gap:8px; background:#0f172a; padding:10px; border-radius:8px;">
                ${adminEnabled ? `
                  <button onclick="adjustInventory(${item.id}, -1)"
                          style="width:36px; height:36px; border-radius:50%; background:#374151; border:none; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">‚àí</button>
                ` : ''}
                <div id="qty-display-${item.id}"
                     onclick="${adminEnabled ? `startQtyEdit(${item.id}, ${item.quantity})` : ''}"
                     style="font-size:24px; font-weight:700; color:${qtyColor}; min-width:50px; text-align:center; ${adminEnabled ? 'cursor:pointer;' : ''}">
                  ${item.quantity}
                </div>
                ${adminEnabled ? `
                  <button onclick="adjustInventory(${item.id}, 1)"
                          style="width:36px; height:36px; border-radius:50%; background:#22c55e; border:none; color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadCatalogDropdown() {
      // Load catalog items that are NOT already in inventory
      try {
        // Get all catalog items from product-catalog endpoint
        const catalogRes = await fetch(`${apiBase}/product-catalog`, { headers: authHeaders() });
        if (!catalogRes.ok) {
          console.error('Failed to fetch catalog:', catalogRes.status);
          return;
        }
        const catalogData = await catalogRes.json();
        const catalogItems = catalogData.products || [];

        // Get existing inventory catalog_item_ids
        const invRes = await fetch(`${apiBase}/inventory?limit=500`, { headers: authHeaders() });
        if (!invRes.ok) return;
        const invItems = await invRes.json();
        const existingCatalogIds = new Set(invItems.filter(i => i.catalog_item_id).map(i => i.catalog_item_id));

        // Filter to catalog items NOT in inventory (dropdown shows what's missing)
        const availableItems = catalogItems.filter(c => !existingCatalogIds.has(c.id));

        const select = document.getElementById('catalogItemSelect');
        select.innerHTML = '<option value="">-- Select item to add --</option>';
        availableItems.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = `${item.name} (${item.category})`;
          select.appendChild(opt);
        });

        // Show message if all items already in inventory
        if (availableItems.length === 0) {
          select.innerHTML = '<option value="">All catalog items already in inventory</option>';
        }
      } catch (error) {
        console.error('Failed to load catalog dropdown:', error);
      }
    }

    async function addFromCatalog() {
      if (!adminEnabled) {
        alert('Admin mode required');
        return;
      }

      const select = document.getElementById('catalogItemSelect');
      const catalogId = select.value;
      const msgEl = document.getElementById('addFromCatalogMessage');

      if (!catalogId) {
        msgEl.innerHTML = '<span class="warning">Please select an item</span>';
        setTimeout(() => { msgEl.innerHTML = ''; }, 3000);
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/from-catalog/${catalogId}`, {
          method: 'POST',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: 0 }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Failed to add');
        }

        msgEl.innerHTML = '<span class="success">‚úÖ Added to inventory!</span>';
        setTimeout(() => { msgEl.innerHTML = ''; }, 3000);

        // Reload inventory and dropdown
        loadInventory();
        loadCatalogDropdown();
      } catch (error) {
        console.error('Failed to add from catalog:', error);
        msgEl.innerHTML = `<span class="danger">‚ùå ${error.message}</span>`;
      }
    }

    async function removeInventoryItem(itemId, itemName) {
      if (!adminEnabled) {
        alert('Admin mode required');
        return;
      }

      if (!confirm(`Remove "${itemName}" from inventory?`)) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}`, {
          method: 'DELETE',
          headers: authHeaders(),
        });

        if (!res.ok) throw new Error('Failed to remove');

        // Reload inventory and dropdown
        loadInventory();
        loadCatalogDropdown();
      } catch (error) {
        console.error('Failed to remove inventory item:', error);
        alert('Failed to remove: ' + error.message);
      }
    }

    async function adjustInventory(itemId, adjustment) {
      if (!adminEnabled) {
        alert('Admin mode required');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}/adjust`, {
          method: 'POST',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ adjustment: adjustment }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Failed to adjust quantity');
        }

        loadInventory();
      } catch (error) {
        console.error('Failed to adjust inventory:', error);
        alert('Failed to adjust: ' + error.message);
      }
    }

    function startQtyEdit(itemId, currentQty) {
      if (!adminEnabled) return;

      const container = document.getElementById(`qty-container-${itemId}`);
      const qtyColor = currentQty === 0 ? '#ef4444' : currentQty <= 5 ? '#f59e0b' : '#22c55e';

      container.innerHTML = `
        <input type="number"
               id="qty-input-${itemId}"
               value="${currentQty}"
               min="0"
               style="width:60px; height:36px; font-size:20px; font-weight:700; text-align:center; background:#1e293b; border:2px solid ${qtyColor}; border-radius:8px; color:${qtyColor}; outline:none;"
               onkeydown="if(event.key==='Enter') applyQtyEdit(${itemId}); if(event.key==='Escape') cancelQtyEdit(${itemId});"
               autofocus />
        <button onclick="applyQtyEdit(${itemId})"
                style="padding:8px 16px; background:#22c55e; border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer; font-size:13px;">
          Apply
        </button>
      `;

      // Focus and select the input
      const input = document.getElementById(`qty-input-${itemId}`);
      input.focus();
      input.select();
    }

    async function applyQtyEdit(itemId) {
      const input = document.getElementById(`qty-input-${itemId}`);
      const newQty = parseInt(input.value, 10);

      if (isNaN(newQty) || newQty < 0) {
        alert('Please enter a valid quantity (0 or greater)');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: newQty }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Failed to update quantity');
        }

        // Reload inventory to show updated data
        loadInventory();
      } catch (error) {
        console.error('Failed to update quantity:', error);
        alert('Failed to update: ' + error.message);
      }
    }

    function cancelQtyEdit(itemId) {
      // Just reload to restore original view
      loadInventory();
    }

    async function deleteInventoryItem(itemId) {
      if (!adminEnabled) {
        alert('Admin mode required');
        return;
      }

      if (!confirm('Are you sure you want to delete this inventory item?')) {
        return;
      }

      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}`, {
          method: 'DELETE',
          headers: authHeaders(),
        });

        if (!res.ok) throw new Error('Failed to delete item');

        loadInventory();
      } catch (error) {
        console.error('Failed to delete inventory item:', error);
        alert('Failed to delete: ' + error.message);
      }
    }

    async function editInventoryItem(itemId) {
      if (!adminEnabled) {
        alert('Admin mode required');
        return;
      }

      // For now, use prompt dialogs - could be enhanced with a modal later
      try {
        const res = await fetch(`${apiBase}/inventory/${itemId}`, { headers: authHeaders() });
        if (!res.ok) throw new Error('Failed to load item');
        const item = await res.json();

        const newQty = prompt('Enter new quantity:', item.quantity);
        if (newQty === null) return;

        const newCost = prompt('Enter cost per unit ($):', item.cost_per_unit || '');
        const newLocation = prompt('Enter location:', item.location || '');
        const newOwner = prompt('Enter owner (Cihan/Nima/Askar/Kanto):', item.owner || '');

        const updatePayload = {};
        if (newQty !== null && newQty !== '') updatePayload.quantity = parseInt(newQty);
        if (newCost !== null && newCost !== '') updatePayload.cost_per_unit = parseFloat(newCost);
        if (newLocation !== null) updatePayload.location = newLocation || null;
        if (newOwner !== null) updatePayload.owner = newOwner || null;

        const updateRes = await fetch(`${apiBase}/inventory/${itemId}`, {
          method: 'PUT',
          headers: { ...authHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify(updatePayload),
        });

        if (!updateRes.ok) throw new Error('Failed to update item');

        loadInventory();
      } catch (error) {
        console.error('Failed to edit inventory item:', error);
        alert('Failed to edit: ' + error.message);
      }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      // Start in view-only mode - show ALL tabs but disable editing
      // Non-admin users can VIEW everything, just can't EDIT
      updateUIForAdminMode();

      // Show Analytics tab by default (view-only mode)
      showTab('analytics');

      // Allow Enter key to enable admin
      document.getElementById("adminPin").addEventListener("keypress", (e) => {
        if (e.key === "Enter") enableAdmin();
      });
    });
  </script>
</body>
</html>
